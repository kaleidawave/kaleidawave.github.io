<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="google-site-verification" content="pi8qBei6qHxHyGxm9Eh4WDhPwxU672uIJmfdIqcgIGs">
    <meta name="referrer" content="no-referrer-when-downgrade">

    
    <!-- Cloudflare Web Analytics -->
    <script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;9a3f0b71c0ea4b3d99621e1b084c24cd&quot;}"></script>
    <!-- End Cloudflare Web Analytics -->
    

    <title>My Rust infrastructure</title>

    <meta name="title" content="My Rust infrastructure">
    <meta property="og:title" content="My Rust infrastructure">
    <meta property="twitter:title" content="My Rust infrastructure">

    <meta name="description" content="Some libraries and tools I have built to help with writing Rust.">
    <meta property="og:description" content="Some libraries and tools I have built to help with writing Rust.">
    <meta property="twitter:description" content="Some libraries and tools I have built to help with writing Rust.">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kaleidawave.github.io/">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kaleidawave.github.io/">

    
    <meta property="twitter:image" content="https://kaleidawave.github.io/media/banners/rust-infrastructure.png">
    <meta property="og:image" content="https://kaleidawave.github.io/media/banners/rust-infrastructure.png">
    

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link rel="preconnect" href="https://fonts.gstatic.com"><link data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap" rel="stylesheet"><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap">/* vietnamese */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW86Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW87Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW81Rb0JcBao.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZJhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZthjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* greek-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZNhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+1F00-1FFF;
}
/* greek */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZxhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
/* vietnamese */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZBhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZFhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl618BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6R8BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* vietnamese */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl698BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl658BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6B8BtxaV4jcFw.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style>

    <style>:root {
    font-family: "SF Pro Display", "SF Pro Icons", "Inter", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
    font-weight: 400;

    --text-color: #1a1a1a;
    --border: var(--text-color);
    --background: #F2F0EB;
    --muted-background: #f9f5f8;
    --muted-background-opaque: #e4e0da80;
    --accent: #bc3b3b;
    --muted-accent: #993b33;
    --code-highlight: #e2ccb7;
}

@media screen {
    :root.dark {
        --text-color: #dbdbdb;
        --background: #0f0f10;
        --muted-background: #1f1f23;
        --muted-background-opaque: #1f1f2380;
        --accent: #a8ff8e;
        --muted-accent: #81b47c;
        --code-highlight: #549463;
    }
}

:root.dark .shiki-light {
    display: none;
}

:root:not(.dark) .shiki-dark {
    display: none;
}

html,
body {
    margin: 0;
    padding: 0;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    font-size: 16px;
}

body {
    background-color: var(--background, white);
    color: var(--text-color, black);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

header {
    background-color: var(--muted-background-opaque, white);
    display: flex;
    justify-content: space-around;
    align-items: center;
    font-size: 16px;
    padding: 14px;
}

:root:not(.dark) header {
    border-bottom: 2px solid var(--border);
}

header>div {
    width: 100% !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

header video {
    position: absolute;
}

header h1 {
    font-weight: 100;
    font-size: 20px;
    color: var(--text-color);
}

header h1>a {
    color: var(--text-color) !important;
}

header .icon-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

header img {
    position: relative;
    top: -4px;
    height: 26px;
    width: auto;
}

@media print {
    header nav {
        display: none;
    }

    footer {
        display: none;
    }
}

header nav>ul {
    padding-left: 0;
    display: flex;
    list-style: none;
}

header nav>ul>li {
    margin-left: 10px;
    text-transform: lowercase;
}

h1,
h2,
h3,
h4,
h5 {
    font-family: "Be Vietnam Pro", sans-serif;
    font-weight: 600;
    scroll-margin: 100px;
}

*::selection {
    background: var(--muted-accent);
    color: var(--background);
}

em {
    position: relative;
    left: -2px;
}

ul,
ol {
    margin: 0px;
    padding-left: 20px;
}

hr {
    width: 100%;
    margin: 30px auto;
    border: none;
    border-top: 1px solid var(--text-color);
}

main {
    margin: 20px 0 80px;
}

.width-box {
    width: 95%;
    margin: 0 auto;
}

svg.icon {
    height: 10pt;
    fill: var(--muted-accent);
    position: relative;
    top: 2px;
}

a {
    color: var(--accent, white);
    text-decoration: none;
}

a:visited {
    color: var(--muted-accent, white);
}

pre code {
    white-space: break-spaces !important;
    overflow-x: hidden;
    tab-size: 4;
}

/* Shrink inline code a little bit */
:is(div, p, a, li)>code {
    font-size: 90%;
}

pre,
code {
    background-color: var(--muted-background) !important;
    font-family: 'JetBrains Mono', 'Fira Code light', consolas, monospace;
    font-size: 14px;
}

footer {
    margin-top: auto;
    background-color: var(--muted-background-opaque, white);
    padding: 22px;
}

:root:not(.dark) footer {
    border-top: 2px solid var(--border);
}

footer>div {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

footer h3 {
    margin: 0;
    font-weight: inherit;
    font-size: 16px;
}

footer nav ul {
    list-style: none;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

footer nav ul>li:not(:first-child) {
    border-left: 2px solid var(--muted-accent);
    padding-left: 6px;
}

footer>div>*:nth-child(2n) {
    margin-left: auto;
    font-size: 10pt;
}

@media screen and (max-width: 480px) {
    header>div {
        flex-direction: column;
    }

    body {
        width: 100vw;
        box-sizing: border-box;
    }

    .posts>ul>li img {
        width: 100%;
        height: auto;
    }
}

@media screen and (min-width: 480px) {
    @supports (backdrop-filter: blur(20px)) {
        header {
            backdrop-filter: blur(20px);
        }
    }

    header {
        position: sticky;
        top: 0;
        right: 0;
        left: 0;
        z-index: 100;
    }

    .width-box {
        width: 100%;
        max-width: min(80vw, 840px);
    }
}</style>
    <link rel="alternate" type="application/rss+xml" href="/feed.xml">
</head>

<body>
    <header>
        <div class="width-box">
            <a class="icon-title" href="/">
                <h1 class="header-title">Ben's Engineering Blog</h1>
                <img draggable="true" src="/media/icon.png" width="256" height="256" alt="">
                
            </a>
            <nav>
                <ul>
                    <li><a href="/posts">Posts</a></li>
                    <li><a href="/about">About</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main>
        
        <div class="width-box">
            <style>.post {
    display: flex;
    flex-direction: column;
}

.post>p,
.post li,
.post blockquote {
    line-height: 1.6em;
    margin: 6px 0;
    font-weight: inherit;
    font-family: "Inter", "Helvetica", sans-serif;
}

.post>*:is(h1, h2, h3, h4, h5) {
    margin: 12pt 0;
}

.post img,
.post video,
.post pre:not(.shiki) {
    margin: 20px 0;
}

.post pre.shiki {
    margin: 0;
}

/* Dark mode by default */
:root:not(.dark) .post img.invertible,
:root:not(.dark) .post video.invertible {
    filter: invert(1);
}

.post img {
    border-radius: 10px;
}

.post svg.icon {
    height: 1em;
    fill: var(--text-color);
}

.post span.line.highlight {
    font-weight: bold;
    background-color: var(--code-highlight);
    outline: 4px var(--code-highlight) solid;
}

.post .shiki-container {
    padding: 20px;
}

.post .math {
    margin: auto;
}

.post .math>svg {
    width: auto;
    height: 200%;
    margin: 10px;
}

.post .quote {
    font-style: italic;
}

.post .quote::before {
    content: '"';
}

.post .quote::after {
    content: '"';
}

.post *[role="caption"] {
    font-size: 14px;
    margin: 6px 0 20px;
    padding: 6px;
    text-align: center;
    font-weight: normal;
    opacity: 0.8;
}

.post time {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 11pt;
    font-family: monospace;
}

.post .center {
    text-align: center;
    font-weight: inherit;
    padding: 30px;
}

.post .note {
    font-style: italic;
    font-size: 12pt;
    opacity: 0.8;
}

*:is(h1, h2, h3, h4, h5, h6)>code {
    font-size: 0.8em;
}

*:is(h1, h2, h3, h4, h5, h6, p, li)>code {
    padding: 2px 6px;
}

/* For footnotes */
.post a[href^="#foot"] {
    font-family: monospace;
    position: relative;
    top: -5px;
    left: 2px;
}

.post #footnotes~* {
    font-size: 14px;
    margin: 4px 0;
    width: 100%;
}

video.small {
    max-height: 300px !important;
}

.callout {
    margin-top: 18px;
    padding: 20px;
    font-size: 15pt;
    background-color: var(--muted-background);
    border-radius: 16px;
    border: 3px solid var(--muted-accent);
}

.post h1.title {
    font-size: 40px;
}

.post h1 {
    font-size: 32px;
}

.post h2 {
    font-size: 28px;
}

.post h3 {
    font-size: 24px;
}

.post h4 {
    font-size: 20px;
}

.post h5 {
    font-size: 16px;
}

.post a.media-container>img {
    width: 100%;
}

.post table {
    border-spacing: 0;
    border-collapse: collapse;
    margin: 40px 0;
    /* max-width: 100%;
    overflow: scroll; */
}

.post table td,
.post table th {
    border: 2px solid var(--text-color);
    padding: 6px 8px;
    text-align: left;
}

.post blockquote {
    border-left: 4px solid var(--muted-accent);
    margin: 10px 0;
    padding: 5px 10px;
    background: var(--muted-background-opaque);
}

.post blockquote>p {
    margin: 0;
}

.post .widget {
    background: white;
    border-radius: 6px;
    padding: 50px;
    margin: 40px 0;
}

.discussions {
    margin: 80px 0px;
}

.parralel pre:not(.shiki) {
    font-size: 12px;
}

@media screen and (max-width: 480px) {
    .center {
        text-align: center;
        font-weight: inherit;
        padding: 10px 0px;
    }

    .post>p,
    .post li {
        font-size: 12pt;
        line-height: 1.4em;
    }

    .post img,
    .post pre,
    .post table,
    .post .widget,
    .post video {
        width: 100%;
        height: auto;
    }

    .post pre {
        overflow-x: auto;
    }
}

@media screen and (min-width: 480px) {
    .post>.parralel {
        display: flex;
        gap: 30px;
    }

    .post>.parralel>div {
        flex-grow: 1;
    }

    .post img,
    .post video,
    .post pre:not(.shiki) {
        align-self: center;
        height: auto;
    }

    .post>img,
    .post>video,
    .post table,
    .post .widget,
    .post>a.media-container,
    .post>.parralel,
    .post>pre:not(.shiki) {
        width: 105%;
        align-self: center;
    }
}

@media print {
    .post video {
        display: none;
    }
}</style>

<div class="post">
    <h1 class="title">My Rust infrastructure</h1>
    
    <time datetime="2023-04-20">
        Published on Thursday 20<sup>th</sup> April 2023
        
    </time>
    
    <p>I have written a lot of Rust over the last couple of years. Along the way of building a <a href="https://github.com/kaleidawave/ezno">compiler</a>, I have built up a few smaller, generic crates and tools (infrastructure) to assist with writing Rust. I realised I haven't shared much about some of these, so I thought it would be a good opportunity to give an overview now.</p>
<p>If you are interested in getting started with Rust: Last summer I wrote a collection of posts for <a href="https://www.shuttle.rs/">Shuttle</a> (a great place to deploy Rust server applications). I wrote a bit about <a href="https://www.shuttle.rs/blog/2022/07/28/patterns-with-rust-types">patterns with Rust types</a>, <a href="https://www.shuttle.rs/blog/2022/06/30/error-handling">how Rust tackles error handling</a> or <a href="https://www.shuttle.rs/blog/2022/06/09/the-builder-pattern">the builder pattern</a> as <a href="https://www.shuttle.rs/blog/tags/all">well as many others</a>. If you are looking to get started with Rust, check those posts out as well as their platform (IMO currently the easiest way to deploy a Rust server application).</p>
<blockquote>
<p>This post was meant to part of an upcoming post about the parser I just published, but this stuff didn't fit into that post. So I decided to split the content up. Look forward to a future post which includes things I learned about parsing and talks about some parser utility libraries I have written (<a href="https://github.com/kaleidawave/source-map">source-map</a>, <a href="https://github.com/kaleidawave/tokenizer-lib">tokenizer-lib</a> and <a href="https://github.com/kaleidawave/derive-finite-automaton">derive-finite-automaton</a>) etc.</p>
</blockquote>
<p>I'll start off with a couple of libraries I've built that make it easier and shorter to write Rust code.</p>
<h2 id="building-macros-with-syn-helpers" tabindex="-1">Building macros with <a href="https://github.com/kaleidawave/syn-helpers">syn-helpers</a></h2>
<p>Proc(edural) macros are a way of generating Rust code. Derive proc macros are Rust's approach to reflection. I wrote at length about reflection, the use cases and an example with a comparison between vanilla JavaScript and Rust in <a href="https://www.shuttle.rs/blog/2022/12/23/procedural-macros">this post on Shuttle.rs</a>. In summary, proc derive macros allow for generating the Rust <code>impl</code> blocks based on the content of <code>struct</code> and <code>enum</code> declarations. For example, <code>#[derive(Debug)]</code> above a <code>struct</code> declaration finds fields and generates an <code>impl Debug for ...</code> with an implementation that prints the field name alongside its runtime value.</p>
<p>One thing about proc macros is that you will likely be reaching for the dependencies <code>syn</code> and <code>quote</code> when writing them. The <a href="https://doc.rust-lang.org/stable/proc_macro/">API</a> for writing them only gives us a low-level sequence of tokens. Fortunately <a href="https://github.com/dtolnay/syn">syn</a> exists and can parse the sequence into an <a href="https://docs.rs/syn/latest/syn/struct.DeriveInput.html">AST</a>, which makes it a lot easier to read fields. Generating output code is also made easier as <a href="https://github.com/dtolnay/quote">quote</a> offers a declarative using a macro: <a href="https://docs.rs/quote/latest/quote/macro.quote.html"><code>quote!</code></a> (<a href="https://docs.rs/syn/latest/syn/macro.parse_quote.html"><code>parse_quote!</code></a> is also a similar thing and equally useful).</p>
<p>But just these on their own, it can still be difficult and verbose to build actual proc macros (<a href="https://www.shuttle.rs/blog/2022/12/23/procedural-macros#procedural-macro-time">the code in the post only worked for structs with named fields</a>). Syn and quote offer great building blocks but they don't give you much help handling the setup required for derive proc macros.</p>
<p>Some of the problems I have run that make the code harder and longer to write and can also introduce bugs:</p>
<ul>
<li>Writing logic that can handle both <code>struct</code>s and <code>enum</code>s and their variants. You can use <code>self</code> to reference data in a <code>struct</code>, <strong>but not in</strong> an <code>enum</code></li>
<li>Creating expressions that access both named fields and unnamed fields</li>
<li>Handling generics that exist on either of the structure or the trait and how to handle if the names clash</li>
<li>How to handle attributes, how to access them at different levels</li>
<li>Forgetting to add <code>#[automatically_derived]</code></li>
</ul>
<p>To make this easier, last year I wrote a <em>'procedural macro framework'</em> that abstracted <code>syn</code> and this process to handle all these cases for you. It's a bit difficult to explain in words so here is an example that calls <code>do_thing</code> for all fields except ones marked with <code>ignore</code>.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">syn_helpers</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">syn</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{parse_quote, </span><span style="color: #FFA657">DeriveInput</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">GenericParam</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Ident</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Stmt</span><span style="color: #C9D1D9">}, </span><span style="color: #FFA657">proc_macro2</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Span</span><span style="color: #C9D1D9">, quote,</span></span>
<span class="line"><span style="color: #C9D1D9">    derive_trait, </span><span style="color: #FFA657">FieldMut</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">HasAttributes</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Trait</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">TraitItem</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">TypeOfSelf</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Constructable</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> my_trait </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Trait</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    name</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">my_crate</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">MyTrait</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">    generic_parameters</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">None</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    items</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">TraitItem</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new_method</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Ident</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"method_one"</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Span</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">call_site</span><span style="color: #C9D1D9">()),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">None</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">TypeOfSelf</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Reference</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Vec</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">default</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">None</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">|mut</span><span style="color: #C9D1D9"> item</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            item</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">map_constructable</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|mut</span><span style="color: #C9D1D9"> constructable</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(constructable</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_fields_mut</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">fields_iterator_mut</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">flat_map</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|mut</span><span style="color: #C9D1D9"> field</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Option</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Stmt</span><span style="color: #C9D1D9">&gt; {</span></span>
<span class="line"><span style="color: #C9D1D9">                        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> field</span></span>
<span class="line"><span style="color: #C9D1D9">                            </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_attributes</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">                            </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">                            </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">any</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">attr</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> attr</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">path</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_ident</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"ignore"</span><span style="color: #C9D1D9">))</span></span>
<span class="line"><span style="color: #C9D1D9">                        {</span></span>
<span class="line"><span style="color: #C9D1D9">                            </span><span style="color: #FFA657">None</span></span>
<span class="line"><span style="color: #C9D1D9">                        } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                            </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> reference </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> field</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_reference</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">                            </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">do_thing</span><span style="color: #C9D1D9">(#reference);))</span></span>
<span class="line"><span style="color: #C9D1D9">                        }</span></span>
<span class="line"><span style="color: #C9D1D9">                    })</span></span>
<span class="line"><span style="color: #C9D1D9">                    </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">collect</span><span style="color: #C9D1D9">())</span></span>
<span class="line"><span style="color: #C9D1D9">            })</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">    )],</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> r#struct</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">DeriveInput</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">struct</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">X</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        a</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        b</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">i32</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> stream </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">derive_trait</span><span style="color: #C9D1D9">(r#struct, my_trait);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D2A8FF">assert_eq!</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">    stream</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_string</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">quote!</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        #[automatically_derived]</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">impl</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">::</span><span style="color: #FFA657">my_crate</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">MyTrait</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">X</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">method_one</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&amp;</span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">X</span><span style="color: #C9D1D9"> { a</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">ref</span><span style="color: #C9D1D9"> _0, b</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">ref</span><span style="color: #C9D1D9"> _1 } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">do_thing</span><span style="color: #C9D1D9">(_0);</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #D2A8FF">do_thing</span><span style="color: #C9D1D9">(_1);</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_string</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">use</span><span style="color: #24292F"> </span><span style="color: #953800">syn_helpers</span><span style="color: #CF222E">::</span><span style="color: #24292F">{</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">syn</span><span style="color: #CF222E">::</span><span style="color: #24292F">{parse_quote, </span><span style="color: #953800">DeriveInput</span><span style="color: #24292F">, </span><span style="color: #953800">GenericParam</span><span style="color: #24292F">, </span><span style="color: #953800">Ident</span><span style="color: #24292F">, </span><span style="color: #953800">Stmt</span><span style="color: #24292F">}, </span><span style="color: #953800">proc_macro2</span><span style="color: #CF222E">::</span><span style="color: #953800">Span</span><span style="color: #24292F">, quote,</span></span>
<span class="line"><span style="color: #24292F">    derive_trait, </span><span style="color: #953800">FieldMut</span><span style="color: #24292F">, </span><span style="color: #953800">HasAttributes</span><span style="color: #24292F">, </span><span style="color: #953800">Trait</span><span style="color: #24292F">, </span><span style="color: #953800">TraitItem</span><span style="color: #24292F">, </span><span style="color: #953800">TypeOfSelf</span><span style="color: #24292F">, </span><span style="color: #953800">Constructable</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> my_trait </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Trait</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    name</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(</span><span style="color: #CF222E">::</span><span style="color: #953800">my_crate</span><span style="color: #CF222E">::</span><span style="color: #953800">MyTrait</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">    generic_parameters</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">None</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">    items</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #8250DF">vec!</span><span style="color: #24292F">[</span><span style="color: #953800">TraitItem</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new_method</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Ident</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new</span><span style="color: #24292F">(</span><span style="color: #0A3069">"method_one"</span><span style="color: #24292F">, </span><span style="color: #953800">Span</span><span style="color: #CF222E">::</span><span style="color: #8250DF">call_site</span><span style="color: #24292F">()),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">None</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">TypeOfSelf</span><span style="color: #CF222E">::</span><span style="color: #953800">Reference</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Vec</span><span style="color: #CF222E">::</span><span style="color: #8250DF">default</span><span style="color: #24292F">(),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">None</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">|mut</span><span style="color: #24292F"> item</span><span style="color: #CF222E">|</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">            item</span><span style="color: #CF222E">.</span><span style="color: #8250DF">map_constructable</span><span style="color: #24292F">(</span><span style="color: #CF222E">|mut</span><span style="color: #24292F"> constructable</span><span style="color: #CF222E">|</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">                </span><span style="color: #953800">Ok</span><span style="color: #24292F">(constructable</span></span>
<span class="line"><span style="color: #24292F">                    </span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_fields_mut</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">                    </span><span style="color: #CF222E">.</span><span style="color: #8250DF">fields_iterator_mut</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">                    </span><span style="color: #CF222E">.</span><span style="color: #8250DF">flat_map</span><span style="color: #24292F">(</span><span style="color: #CF222E">|mut</span><span style="color: #24292F"> field</span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Stmt</span><span style="color: #24292F">&gt; {</span></span>
<span class="line"><span style="color: #24292F">                        </span><span style="color: #CF222E">if</span><span style="color: #24292F"> field</span></span>
<span class="line"><span style="color: #24292F">                            </span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_attributes</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">                            </span><span style="color: #CF222E">.</span><span style="color: #8250DF">iter</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">                            </span><span style="color: #CF222E">.</span><span style="color: #8250DF">any</span><span style="color: #24292F">(</span><span style="color: #CF222E">|</span><span style="color: #24292F">attr</span><span style="color: #CF222E">|</span><span style="color: #24292F"> attr</span><span style="color: #CF222E">.</span><span style="color: #24292F">path</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_ident</span><span style="color: #24292F">(</span><span style="color: #0A3069">"ignore"</span><span style="color: #24292F">))</span></span>
<span class="line"><span style="color: #24292F">                        {</span></span>
<span class="line"><span style="color: #24292F">                            </span><span style="color: #953800">None</span></span>
<span class="line"><span style="color: #24292F">                        } </span><span style="color: #CF222E">else</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">                            </span><span style="color: #CF222E">let</span><span style="color: #24292F"> reference </span><span style="color: #CF222E">=</span><span style="color: #24292F"> field</span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_reference</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">                            </span><span style="color: #953800">Some</span><span style="color: #24292F">(</span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(</span><span style="color: #8250DF">do_thing</span><span style="color: #24292F">(#reference);))</span></span>
<span class="line"><span style="color: #24292F">                        }</span></span>
<span class="line"><span style="color: #24292F">                    })</span></span>
<span class="line"><span style="color: #24292F">                    </span><span style="color: #CF222E">.</span><span style="color: #8250DF">collect</span><span style="color: #24292F">())</span></span>
<span class="line"><span style="color: #24292F">            })</span></span>
<span class="line"><span style="color: #24292F">        },</span></span>
<span class="line"><span style="color: #24292F">    )],</span></span>
<span class="line"><span style="color: #24292F">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> r#struct</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">DeriveInput</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">struct</span><span style="color: #24292F"> </span><span style="color: #953800">X</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        a</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">String</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        b</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">i32</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"><span style="color: #24292F">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> stream </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">derive_trait</span><span style="color: #24292F">(r#struct, my_trait);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8250DF">assert_eq!</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">    stream</span><span style="color: #CF222E">.</span><span style="color: #8250DF">to_string</span><span style="color: #24292F">(),</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">quote!</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        #[automatically_derived]</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">impl</span><span style="color: #24292F"> </span><span style="color: #CF222E">::</span><span style="color: #953800">my_crate</span><span style="color: #CF222E">::</span><span style="color: #953800">MyTrait</span><span style="color: #24292F"> </span><span style="color: #CF222E">for</span><span style="color: #24292F"> </span><span style="color: #953800">X</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">method_one</span><span style="color: #24292F">(</span><span style="color: #CF222E">&amp;</span><span style="color: #0550AE">self</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">                </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #953800">X</span><span style="color: #24292F"> { a</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">ref</span><span style="color: #24292F"> _0, b</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">ref</span><span style="color: #24292F"> _1 } </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">self</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">                </span><span style="color: #8250DF">do_thing</span><span style="color: #24292F">(_0);</span></span>
<span class="line"><span style="color: #24292F">                </span><span style="color: #8250DF">do_thing</span><span style="color: #24292F">(_1);</span></span>
<span class="line"><span style="color: #24292F">            }</span></span>
<span class="line"><span style="color: #24292F">        }</span></span>
<span class="line"><span style="color: #24292F">    }</span><span style="color: #CF222E">.</span><span style="color: #8250DF">to_string</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">)</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Benefits of using the crate here</p>
<ul>
<li><code>map_constructable</code> handles both enums variants and <code>struct</code>-ures.</li>
<li>The code uses the <a href="https://docs.rs/syn-helpers/0.4.3/syn_helpers/trait.Field.html"><code>Field</code></a> trait which abstracts over generating expressions to access fields. Handling named and unnamed variants is automated away</li>
<li>For fields whose type contains generics, it can add necessary <code>where</code> clauses if the trait is called on that field</li>
<li>The macro also gets a structure. You get a more declarative code by laying out the <a href="https://docs.rs/syn-helpers/0.4.3/syn_helpers/struct.Trait.html"><code>Trait</code></a> with the items you need to implement. Those methods contain functions that handle generating the output.</li>
</ul>
<p>For example, in the parser, I currently have a way of <em>visiting nodes</em> (running a set of functions over them) and automating this implementation becomes quite simple using the <code>syn-helpers</code> library.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">proc_macro</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">TokenStream</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">std</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">error</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Error</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">string_cases</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">StringCasesExt</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">syn_helpers</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">    derive_trait,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">proc_macro2</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #FFA657">Ident</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Span</span><span style="color: #C9D1D9">},</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">quote</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{</span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">, format_ident},</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">syn</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">{parse_macro_input, parse_quote, </span><span style="color: #FFA657">DeriveInput</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Stmt</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Constructable</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">FieldMut</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">HasAttributes</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">NamedOrUnnamedFieldMut</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FFA657">Trait</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">TraitItem</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">/// On the top structure</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">VISIT_SELF_NAME</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;</span><span style="color: #FFA657">str</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"visit_self"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">/// Per field modifiers</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">VISIT_SKIP_NAME</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;</span><span style="color: #FFA657">str</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"visit_skip_field"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">/// Add to chain. Can be on item or a field</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">VISIT_WITH_CHAIN_NAME</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;</span><span style="color: #FFA657">str</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"visit_with_chain"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">/// Usage #[derive(Visitable)]</span></span>
<span class="line"><span style="color: #C9D1D9">#[proc_macro_derive(</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Visitable</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    attributes(visit_self, visit_skip_field, visit_custom_visit)</span></span>
<span class="line"><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #FF7B72">pub</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">generate_visit_implementation</span><span style="color: #C9D1D9">(input</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TokenStream</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TokenStream</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> input </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">parse_macro_input!</span><span style="color: #C9D1D9">(input </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">DeriveInput</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> visit_item </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TraitItem</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new_method</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Ident</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"visit"</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Span</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">call_site</span><span style="color: #C9D1D9">()),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[</span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">TData</span><span style="color: #C9D1D9">)]),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">syn_helpers</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">TypeOfSelf</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Reference</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(visitors</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">impl</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">crate::</span><span style="color: #FFA657">visiting</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">VisitorReceiver</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">TData</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">?</span><span style="color: #FFA657">Sized</span><span style="color: #C9D1D9">)),</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(data</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TData</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(settings</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;crate::</span><span style="color: #FFA657">VisitSettings</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(chain</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">::</span><span style="color: #FFA657">temporary_annex</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Annex</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FF7B72">crate::</span><span style="color: #C9D1D9">visiting</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Chain</span><span style="color: #C9D1D9">&gt;),</span></span>
<span class="line"><span style="color: #C9D1D9">        ],</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">None</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">item</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">generated_visit_item</span><span style="color: #C9D1D9">(item, </span><span style="color: #FFA657">VisitType</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Immutable</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> visit_mut_item </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TraitItem</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new_method</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Ident</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"visit_mut"</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Span</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">call_site</span><span style="color: #C9D1D9">()),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[</span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">TData</span><span style="color: #C9D1D9">)]),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">syn_helpers</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">TypeOfSelf</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">MutableReference</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(visitors</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">impl</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">crate::</span><span style="color: #FFA657">visiting</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">VisitorMutReceiver</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">TData</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">?</span><span style="color: #FFA657">Sized</span><span style="color: #C9D1D9">)),</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(data</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TData</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(settings</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;crate::</span><span style="color: #FFA657">VisitSettings</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(chain</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">::</span><span style="color: #FFA657">temporary_annex</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Annex</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FF7B72">crate::</span><span style="color: #C9D1D9">visiting</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Chain</span><span style="color: #C9D1D9">&gt;),</span></span>
<span class="line"><span style="color: #C9D1D9">        ],</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">None</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">item</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">generated_visit_item</span><span style="color: #C9D1D9">(item, </span><span style="color: #FFA657">VisitType</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Mutable</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> visitable_trait </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Trait</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        name</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">crate::</span><span style="color: #FFA657">visiting</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Visitable</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">        generic_parameters</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">None</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        items</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">vec!</span><span style="color: #C9D1D9">[visit_item, visit_mut_item],</span></span>
<span class="line"><span style="color: #C9D1D9">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> output </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">derive_trait</span><span style="color: #C9D1D9">(input, visitable_trait);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    output</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">#[derive(</span><span style="color: #FFA657">Clone</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Copy</span><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #FF7B72">enum</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">VisitType</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Immutable</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Mutable</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">generated_visit_item</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> item</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">syn_helpers</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Item</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    visit_type</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">VisitType</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Result</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Stmt</span><span style="color: #C9D1D9">&gt;, </span><span style="color: #FFA657">Box</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FF7B72">dyn</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Error</span><span style="color: #C9D1D9">&gt;&gt; {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> attributes </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> item</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">structure</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_attributes</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> visit_self </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> attributes</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">any</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">attr</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> attr</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">path</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_ident</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">VISIT_SELF_NAME</span><span style="color: #C9D1D9">));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> visit_with_chain </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> attributes</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">find_map</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">attr</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        attr</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">path</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_ident</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">VISIT_WITH_CHAIN_NAME</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">then_some</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9">attr</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">tokens)</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> lines </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Vec</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(expr_tokens) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> visit_with_chain {</span></span>
<span class="line"><span style="color: #C9D1D9">        lines</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">( </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> chain </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> chain</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push_annex</span><span style="color: #C9D1D9">(#expr_tokens); ))</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> visit_self {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> struct_name_as_snake_case </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9">item</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">structure</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_name</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_string</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_snake_case</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> mut_postfix </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">matches!</span><span style="color: #C9D1D9">(visit_type, </span><span style="color: #FFA657">VisitType</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Mutable</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">then_some</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"_mut"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">unwrap_or_default</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> func_name </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">format_ident!</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"visit_{}{}"</span><span style="color: #C9D1D9">, struct_name_as_snake_case, mut_postfix);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        lines</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9">( visitors</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">#</span><span style="color: #D2A8FF">func_name</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">self</span><span style="color: #C9D1D9">, data,  chain); ))</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> field_lines </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> item</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">map_constructable</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|mut</span><span style="color: #C9D1D9"> constructable</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(constructable</span></span>
<span class="line"><span style="color: #C9D1D9">			</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_fields_mut</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">			</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">fields_iterator_mut</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">			</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">flat_map</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|mut</span><span style="color: #C9D1D9"> field</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">NamedOrUnnamedFieldMut</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Option</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Stmt</span><span style="color: #C9D1D9">&gt; {</span></span>
<span class="line"><span style="color: #C9D1D9">				</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> attributes </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> field</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_attributes</span><span style="color: #C9D1D9">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">				</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> skip_field </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> attributes</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">any</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">attr</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> attr</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">path</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_ident</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">VISIT_SKIP_NAME</span><span style="color: #C9D1D9">));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">				</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> visit_with_chain </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> attributes</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">find_map</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">attr</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">					attr</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">path</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_ident</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">VISIT_WITH_CHAIN_NAME</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">then_some</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9">attr</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">tokens)</span></span>
<span class="line"><span style="color: #C9D1D9">				});</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">				</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> chain </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(expr_tokens) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> visit_with_chain {</span></span>
<span class="line"><span style="color: #C9D1D9">					</span><span style="color: #D2A8FF">quote!</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> chain</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push_annex</span><span style="color: #C9D1D9">(#expr_tokens))</span></span>
<span class="line"><span style="color: #C9D1D9">				} </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">					</span><span style="color: #D2A8FF">quote!</span><span style="color: #C9D1D9">(chain)</span></span>
<span class="line"><span style="color: #C9D1D9">				};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">				</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">skip_field {</span></span>
<span class="line"><span style="color: #C9D1D9">					</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> reference </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> field</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_reference</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">					</span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">match</span><span style="color: #C9D1D9"> visit_type {</span></span>
<span class="line"><span style="color: #C9D1D9">						</span><span style="color: #FFA657">VisitType</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Immutable</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">							</span><span style="color: #FF7B72">crate::</span><span style="color: #FFA657">Visitable</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">visit</span><span style="color: #C9D1D9">(#reference, visitors, data, settings, #chain);</span></span>
<span class="line"><span style="color: #C9D1D9">						},</span></span>
<span class="line"><span style="color: #C9D1D9">						</span><span style="color: #FFA657">VisitType</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Mutable</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">parse_quote!</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">							</span><span style="color: #FF7B72">crate::</span><span style="color: #FFA657">Visitable</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">visit_mut</span><span style="color: #C9D1D9">(#reference, visitors, data, settings, #chain);</span></span>
<span class="line"><span style="color: #C9D1D9">						},</span></span>
<span class="line"><span style="color: #C9D1D9">					})</span></span>
<span class="line"><span style="color: #C9D1D9">				} </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">					</span><span style="color: #FFA657">None</span></span>
<span class="line"><span style="color: #C9D1D9">				}</span></span>
<span class="line"><span style="color: #C9D1D9">			})</span></span>
<span class="line"><span style="color: #C9D1D9">			</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">collect</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&lt;_&gt;&gt;())</span></span>
<span class="line"><span style="color: #C9D1D9">    })</span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    lines</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">append</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> field_lines);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(lines)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">use</span><span style="color: #24292F"> </span><span style="color: #953800">proc_macro</span><span style="color: #CF222E">::</span><span style="color: #953800">TokenStream</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #CF222E">use</span><span style="color: #24292F"> </span><span style="color: #953800">std</span><span style="color: #CF222E">::</span><span style="color: #953800">error</span><span style="color: #CF222E">::</span><span style="color: #953800">Error</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #CF222E">use</span><span style="color: #24292F"> </span><span style="color: #953800">string_cases</span><span style="color: #CF222E">::</span><span style="color: #953800">StringCasesExt</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #CF222E">use</span><span style="color: #24292F"> </span><span style="color: #953800">syn_helpers</span><span style="color: #CF222E">::</span><span style="color: #24292F">{</span></span>
<span class="line"><span style="color: #24292F">    derive_trait,</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">proc_macro2</span><span style="color: #CF222E">::</span><span style="color: #24292F">{</span><span style="color: #953800">Ident</span><span style="color: #24292F">, </span><span style="color: #953800">Span</span><span style="color: #24292F">},</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">quote</span><span style="color: #CF222E">::</span><span style="color: #24292F">{</span><span style="color: #0550AE">self</span><span style="color: #24292F">, format_ident},</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">syn</span><span style="color: #CF222E">::</span><span style="color: #24292F">{parse_macro_input, parse_quote, </span><span style="color: #953800">DeriveInput</span><span style="color: #24292F">, </span><span style="color: #953800">Stmt</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">Constructable</span><span style="color: #24292F">, </span><span style="color: #953800">FieldMut</span><span style="color: #24292F">, </span><span style="color: #953800">HasAttributes</span><span style="color: #24292F">, </span><span style="color: #953800">NamedOrUnnamedFieldMut</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #953800">Trait</span><span style="color: #24292F">, </span><span style="color: #953800">TraitItem</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">/// On the top structure</span></span>
<span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">VISIT_SELF_NAME</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #953800">str</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">"visit_self"</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #6E7781">/// Per field modifiers</span></span>
<span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">VISIT_SKIP_NAME</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #953800">str</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">"visit_skip_field"</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #6E7781">/// Add to chain. Can be on item or a field</span></span>
<span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">VISIT_WITH_CHAIN_NAME</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #953800">str</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">"visit_with_chain"</span><span style="color: #24292F">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">/// Usage #[derive(Visitable)]</span></span>
<span class="line"><span style="color: #24292F">#[proc_macro_derive(</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">Visitable</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">    attributes(visit_self, visit_skip_field, visit_custom_visit)</span></span>
<span class="line"><span style="color: #24292F">)]</span></span>
<span class="line"><span style="color: #CF222E">pub</span><span style="color: #24292F"> </span><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">generate_visit_implementation</span><span style="color: #24292F">(input</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">TokenStream</span><span style="color: #24292F">) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #953800">TokenStream</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> input </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">parse_macro_input!</span><span style="color: #24292F">(input </span><span style="color: #CF222E">as</span><span style="color: #24292F"> </span><span style="color: #953800">DeriveInput</span><span style="color: #24292F">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> visit_item </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">TraitItem</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new_method</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Ident</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new</span><span style="color: #24292F">(</span><span style="color: #0A3069">"visit"</span><span style="color: #24292F">, </span><span style="color: #953800">Span</span><span style="color: #CF222E">::</span><span style="color: #8250DF">call_site</span><span style="color: #24292F">()),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Some</span><span style="color: #24292F">(</span><span style="color: #8250DF">vec!</span><span style="color: #24292F">[</span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(</span><span style="color: #953800">TData</span><span style="color: #24292F">)]),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">syn_helpers</span><span style="color: #CF222E">::</span><span style="color: #953800">TypeOfSelf</span><span style="color: #CF222E">::</span><span style="color: #953800">Reference</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #8250DF">vec!</span><span style="color: #24292F">[</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(visitors</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> (</span><span style="color: #CF222E">impl</span><span style="color: #24292F"> </span><span style="color: #CF222E">crate::</span><span style="color: #953800">visiting</span><span style="color: #CF222E">::</span><span style="color: #953800">VisitorReceiver</span><span style="color: #24292F">&lt;</span><span style="color: #953800">TData</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #CF222E">?</span><span style="color: #953800">Sized</span><span style="color: #24292F">)),</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(data</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> </span><span style="color: #953800">TData</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(settings</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;crate::</span><span style="color: #953800">VisitSettings</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(chain</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> </span><span style="color: #CF222E">::</span><span style="color: #953800">temporary_annex</span><span style="color: #CF222E">::</span><span style="color: #953800">Annex</span><span style="color: #24292F">&lt;</span><span style="color: #CF222E">crate::</span><span style="color: #24292F">visiting</span><span style="color: #CF222E">::</span><span style="color: #953800">Chain</span><span style="color: #24292F">&gt;),</span></span>
<span class="line"><span style="color: #24292F">        ],</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">None</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">|</span><span style="color: #24292F">item</span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #8250DF">generated_visit_item</span><span style="color: #24292F">(item, </span><span style="color: #953800">VisitType</span><span style="color: #CF222E">::</span><span style="color: #953800">Immutable</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> visit_mut_item </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">TraitItem</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new_method</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Ident</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new</span><span style="color: #24292F">(</span><span style="color: #0A3069">"visit_mut"</span><span style="color: #24292F">, </span><span style="color: #953800">Span</span><span style="color: #CF222E">::</span><span style="color: #8250DF">call_site</span><span style="color: #24292F">()),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Some</span><span style="color: #24292F">(</span><span style="color: #8250DF">vec!</span><span style="color: #24292F">[</span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(</span><span style="color: #953800">TData</span><span style="color: #24292F">)]),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">syn_helpers</span><span style="color: #CF222E">::</span><span style="color: #953800">TypeOfSelf</span><span style="color: #CF222E">::</span><span style="color: #953800">MutableReference</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #8250DF">vec!</span><span style="color: #24292F">[</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(visitors</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> (</span><span style="color: #CF222E">impl</span><span style="color: #24292F"> </span><span style="color: #CF222E">crate::</span><span style="color: #953800">visiting</span><span style="color: #CF222E">::</span><span style="color: #953800">VisitorMutReceiver</span><span style="color: #24292F">&lt;</span><span style="color: #953800">TData</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #CF222E">?</span><span style="color: #953800">Sized</span><span style="color: #24292F">)),</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(data</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> </span><span style="color: #953800">TData</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(settings</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;crate::</span><span style="color: #953800">VisitSettings</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(chain</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> </span><span style="color: #CF222E">::</span><span style="color: #953800">temporary_annex</span><span style="color: #CF222E">::</span><span style="color: #953800">Annex</span><span style="color: #24292F">&lt;</span><span style="color: #CF222E">crate::</span><span style="color: #24292F">visiting</span><span style="color: #CF222E">::</span><span style="color: #953800">Chain</span><span style="color: #24292F">&gt;),</span></span>
<span class="line"><span style="color: #24292F">        ],</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">None</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">|</span><span style="color: #24292F">item</span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #8250DF">generated_visit_item</span><span style="color: #24292F">(item, </span><span style="color: #953800">VisitType</span><span style="color: #CF222E">::</span><span style="color: #953800">Mutable</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> visitable_trait </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Trait</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        name</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">(</span><span style="color: #CF222E">crate::</span><span style="color: #953800">visiting</span><span style="color: #CF222E">::</span><span style="color: #953800">Visitable</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">        generic_parameters</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">None</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        items</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #8250DF">vec!</span><span style="color: #24292F">[visit_item, visit_mut_item],</span></span>
<span class="line"><span style="color: #24292F">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> output </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">derive_trait</span><span style="color: #24292F">(input, visitable_trait);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    output</span><span style="color: #CF222E">.</span><span style="color: #8250DF">into</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">#[derive(</span><span style="color: #953800">Clone</span><span style="color: #24292F">, </span><span style="color: #953800">Copy</span><span style="color: #24292F">)]</span></span>
<span class="line"><span style="color: #CF222E">enum</span><span style="color: #24292F"> </span><span style="color: #953800">VisitType</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">Immutable</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">Mutable</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">generated_visit_item</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">mut</span><span style="color: #24292F"> item</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">syn_helpers</span><span style="color: #CF222E">::</span><span style="color: #953800">Item</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">    visit_type</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">VisitType</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #953800">Result</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Vec</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Stmt</span><span style="color: #24292F">&gt;, </span><span style="color: #953800">Box</span><span style="color: #24292F">&lt;</span><span style="color: #CF222E">dyn</span><span style="color: #24292F"> </span><span style="color: #953800">Error</span><span style="color: #24292F">&gt;&gt; {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> attributes </span><span style="color: #CF222E">=</span><span style="color: #24292F"> item</span><span style="color: #CF222E">.</span><span style="color: #24292F">structure</span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_attributes</span><span style="color: #24292F">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> visit_self </span><span style="color: #CF222E">=</span><span style="color: #24292F"> attributes</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">.</span><span style="color: #8250DF">iter</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">.</span><span style="color: #8250DF">any</span><span style="color: #24292F">(</span><span style="color: #CF222E">|</span><span style="color: #24292F">attr</span><span style="color: #CF222E">|</span><span style="color: #24292F"> attr</span><span style="color: #CF222E">.</span><span style="color: #24292F">path</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_ident</span><span style="color: #24292F">(</span><span style="color: #0550AE">VISIT_SELF_NAME</span><span style="color: #24292F">));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> visit_with_chain </span><span style="color: #CF222E">=</span><span style="color: #24292F"> attributes</span><span style="color: #CF222E">.</span><span style="color: #8250DF">iter</span><span style="color: #24292F">()</span><span style="color: #CF222E">.</span><span style="color: #8250DF">find_map</span><span style="color: #24292F">(</span><span style="color: #CF222E">|</span><span style="color: #24292F">attr</span><span style="color: #CF222E">|</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        attr</span><span style="color: #CF222E">.</span><span style="color: #24292F">path</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_ident</span><span style="color: #24292F">(</span><span style="color: #0550AE">VISIT_WITH_CHAIN_NAME</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">.</span><span style="color: #8250DF">then_some</span><span style="color: #24292F">(</span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">attr</span><span style="color: #CF222E">.</span><span style="color: #24292F">tokens)</span></span>
<span class="line"><span style="color: #24292F">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #CF222E">mut</span><span style="color: #24292F"> lines </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Vec</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new</span><span style="color: #24292F">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #953800">Some</span><span style="color: #24292F">(expr_tokens) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> visit_with_chain {</span></span>
<span class="line"><span style="color: #24292F">        lines</span><span style="color: #CF222E">.</span><span style="color: #8250DF">push</span><span style="color: #24292F">(</span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">( </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #CF222E">mut</span><span style="color: #24292F"> chain </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> chain</span><span style="color: #CF222E">.</span><span style="color: #8250DF">push_annex</span><span style="color: #24292F">(#expr_tokens); ))</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">if</span><span style="color: #24292F"> visit_self {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">let</span><span style="color: #24292F"> struct_name_as_snake_case </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">item</span><span style="color: #CF222E">.</span><span style="color: #24292F">structure</span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_name</span><span style="color: #24292F">()</span><span style="color: #CF222E">.</span><span style="color: #8250DF">to_string</span><span style="color: #24292F">()</span><span style="color: #CF222E">.</span><span style="color: #8250DF">to_snake_case</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">let</span><span style="color: #24292F"> mut_postfix </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">matches!</span><span style="color: #24292F">(visit_type, </span><span style="color: #953800">VisitType</span><span style="color: #CF222E">::</span><span style="color: #953800">Mutable</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">.</span><span style="color: #8250DF">then_some</span><span style="color: #24292F">(</span><span style="color: #0A3069">"_mut"</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">.</span><span style="color: #8250DF">unwrap_or_default</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">let</span><span style="color: #24292F"> func_name </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">format_ident!</span><span style="color: #24292F">(</span><span style="color: #0A3069">"visit_{}{}"</span><span style="color: #24292F">, struct_name_as_snake_case, mut_postfix);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">        lines</span><span style="color: #CF222E">.</span><span style="color: #8250DF">push</span><span style="color: #24292F">(</span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F">( visitors</span><span style="color: #CF222E">.</span><span style="color: #24292F">#</span><span style="color: #8250DF">func_name</span><span style="color: #24292F">(</span><span style="color: #0550AE">self</span><span style="color: #24292F">, data,  chain); ))</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #CF222E">mut</span><span style="color: #24292F"> field_lines </span><span style="color: #CF222E">=</span><span style="color: #24292F"> item</span><span style="color: #CF222E">.</span><span style="color: #8250DF">map_constructable</span><span style="color: #24292F">(</span><span style="color: #CF222E">|mut</span><span style="color: #24292F"> constructable</span><span style="color: #CF222E">|</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Ok</span><span style="color: #24292F">(constructable</span></span>
<span class="line"><span style="color: #24292F">			</span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_fields_mut</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">			</span><span style="color: #CF222E">.</span><span style="color: #8250DF">fields_iterator_mut</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">			</span><span style="color: #CF222E">.</span><span style="color: #8250DF">flat_map</span><span style="color: #24292F">(</span><span style="color: #CF222E">|mut</span><span style="color: #24292F"> field</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">NamedOrUnnamedFieldMut</span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Stmt</span><span style="color: #24292F">&gt; {</span></span>
<span class="line"><span style="color: #24292F">				</span><span style="color: #CF222E">let</span><span style="color: #24292F"> attributes </span><span style="color: #CF222E">=</span><span style="color: #24292F"> field</span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_attributes</span><span style="color: #24292F">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">				</span><span style="color: #CF222E">let</span><span style="color: #24292F"> skip_field </span><span style="color: #CF222E">=</span><span style="color: #24292F"> attributes</span><span style="color: #CF222E">.</span><span style="color: #8250DF">iter</span><span style="color: #24292F">()</span><span style="color: #CF222E">.</span><span style="color: #8250DF">any</span><span style="color: #24292F">(</span><span style="color: #CF222E">|</span><span style="color: #24292F">attr</span><span style="color: #CF222E">|</span><span style="color: #24292F"> attr</span><span style="color: #CF222E">.</span><span style="color: #24292F">path</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_ident</span><span style="color: #24292F">(</span><span style="color: #0550AE">VISIT_SKIP_NAME</span><span style="color: #24292F">));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">				</span><span style="color: #CF222E">let</span><span style="color: #24292F"> visit_with_chain </span><span style="color: #CF222E">=</span><span style="color: #24292F"> attributes</span><span style="color: #CF222E">.</span><span style="color: #8250DF">iter</span><span style="color: #24292F">()</span><span style="color: #CF222E">.</span><span style="color: #8250DF">find_map</span><span style="color: #24292F">(</span><span style="color: #CF222E">|</span><span style="color: #24292F">attr</span><span style="color: #CF222E">|</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">					attr</span><span style="color: #CF222E">.</span><span style="color: #24292F">path</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_ident</span><span style="color: #24292F">(</span><span style="color: #0550AE">VISIT_WITH_CHAIN_NAME</span><span style="color: #24292F">)</span><span style="color: #CF222E">.</span><span style="color: #8250DF">then_some</span><span style="color: #24292F">(</span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">attr</span><span style="color: #CF222E">.</span><span style="color: #24292F">tokens)</span></span>
<span class="line"><span style="color: #24292F">				});</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">				</span><span style="color: #CF222E">let</span><span style="color: #24292F"> chain </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #953800">Some</span><span style="color: #24292F">(expr_tokens) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> visit_with_chain {</span></span>
<span class="line"><span style="color: #24292F">					</span><span style="color: #8250DF">quote!</span><span style="color: #24292F">(</span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> chain</span><span style="color: #CF222E">.</span><span style="color: #8250DF">push_annex</span><span style="color: #24292F">(#expr_tokens))</span></span>
<span class="line"><span style="color: #24292F">				} </span><span style="color: #CF222E">else</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">					</span><span style="color: #8250DF">quote!</span><span style="color: #24292F">(chain)</span></span>
<span class="line"><span style="color: #24292F">				};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">				</span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">!</span><span style="color: #24292F">skip_field {</span></span>
<span class="line"><span style="color: #24292F">					</span><span style="color: #CF222E">let</span><span style="color: #24292F"> reference </span><span style="color: #CF222E">=</span><span style="color: #24292F"> field</span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_reference</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">					</span><span style="color: #953800">Some</span><span style="color: #24292F">(</span><span style="color: #CF222E">match</span><span style="color: #24292F"> visit_type {</span></span>
<span class="line"><span style="color: #24292F">						</span><span style="color: #953800">VisitType</span><span style="color: #CF222E">::</span><span style="color: #953800">Immutable</span><span style="color: #24292F"> </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">							</span><span style="color: #CF222E">crate::</span><span style="color: #953800">Visitable</span><span style="color: #CF222E">::</span><span style="color: #8250DF">visit</span><span style="color: #24292F">(#reference, visitors, data, settings, #chain);</span></span>
<span class="line"><span style="color: #24292F">						},</span></span>
<span class="line"><span style="color: #24292F">						</span><span style="color: #953800">VisitType</span><span style="color: #CF222E">::</span><span style="color: #953800">Mutable</span><span style="color: #24292F"> </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> </span><span style="color: #8250DF">parse_quote!</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">							</span><span style="color: #CF222E">crate::</span><span style="color: #953800">Visitable</span><span style="color: #CF222E">::</span><span style="color: #8250DF">visit_mut</span><span style="color: #24292F">(#reference, visitors, data, settings, #chain);</span></span>
<span class="line"><span style="color: #24292F">						},</span></span>
<span class="line"><span style="color: #24292F">					})</span></span>
<span class="line"><span style="color: #24292F">				} </span><span style="color: #CF222E">else</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">					</span><span style="color: #953800">None</span></span>
<span class="line"><span style="color: #24292F">				}</span></span>
<span class="line"><span style="color: #24292F">			})</span></span>
<span class="line"><span style="color: #24292F">			</span><span style="color: #CF222E">.</span><span style="color: #8250DF">collect</span><span style="color: #CF222E">::</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Vec</span><span style="color: #24292F">&lt;_&gt;&gt;())</span></span>
<span class="line"><span style="color: #24292F">    })</span><span style="color: #CF222E">?</span><span style="color: #24292F">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    lines</span><span style="color: #CF222E">.</span><span style="color: #8250DF">append</span><span style="color: #24292F">(</span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> field_lines);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">Ok</span><span style="color: #24292F">(lines)</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>It takes around 140 lines to implement this trait. <code>syn-helpers</code> here can handle the cases when the AST contains generics. Using <code>syn-helpers</code> means the code can focus on the actual behaviour of the trait rather than handling all the different cases Rust declarations can be in.</p>
<hr>
<p>Although it is called <code>syn-helpers</code> and that was its original aim, it has now grown into a large framework focused on derive macros. So if you write derive macros and maybe struggle with keeping things concise. If you have API/abstraction you want to be added for a proc-macro you are writing I am open <a href="https://github.com/kaleidawave/syn-helpers/issues">for discussion</a>.</p>
<p>Building this out I feel it might be close to a fully declarative macro implementation <a href="https://github.com/kaleidawave/syn-helpers/issues/1">notes here</a>. Rust current has declarative macros but anything <code>derive</code> based has to be done imperatively and there isn't an end-to-end declarative approach. Maybe it could be tried out in this library.</p>
<h3 id="putting-the-framework-to-build-more-customisable-derive-implementations" tabindex="-1">Putting the framework to build more customisable <code>derive</code> implementations</h3>
<p>I had written two macros before, and <code>syn-helpers</code> <em>helped</em> tidy up and share the code between these two. The two main ones are:</p>
<h3 id="%23%5Bderive(debugextras)%5D" tabindex="-1"><code>#[derive(DebugExtras)]</code></h3>
<p><code>#[derive(Debug)]</code> is great most times, but sometimes it lacks a bit of customisation for the derive item. <a href="https://github.com/kaleidawave/derive-debug-extras">derive-debug-extras</a> offers an enhanced macro that adds <code>#[debug_ignore]</code> and <code>#[debug_as_display]</code> attributes that can help improve debugging.</p>
<p>But arguably my favourite one is <a href="https://github.com/kaleidawave/derive-debug-extras#debug_single_tuple_inline"><code>#[debug_single_tuple_inline]</code></a>. This fixes a problem in the Ezno checker. I use a lot of the new type pattern to declare identifiers. Unfortunately, despite them only having one field, when debugging them with the pretty flag (I want other named structs to be over lines) it ends up over three. So although it did require rewriting the standard debug implementation, now:</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #8B949E">// Without #[debug_single_tuple_inline]</span></span>
<span class="line"><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">A</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">123</span></span>
<span class="line"><span style="color: #C9D1D9">    ),</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">A</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">145</span></span>
<span class="line"><span style="color: #C9D1D9">    ),</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">A</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">125</span></span>
<span class="line"><span style="color: #C9D1D9">    ),</span></span>
<span class="line"><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #8B949E">// With #[debug_single_tuple_inline]</span></span>
<span class="line"><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">A</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">123</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">A</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">145</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">A</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">125</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">]</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #6E7781">// Without #[debug_single_tuple_inline]</span></span>
<span class="line"><span style="color: #24292F">[</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">A</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">123</span></span>
<span class="line"><span style="color: #24292F">    ),</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">A</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">145</span></span>
<span class="line"><span style="color: #24292F">    ),</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">A</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">125</span></span>
<span class="line"><span style="color: #24292F">    ),</span></span>
<span class="line"><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #6E7781">// With #[debug_single_tuple_inline]</span></span>
<span class="line"><span style="color: #24292F">[</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">A</span><span style="color: #24292F">(</span><span style="color: #0550AE">123</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">A</span><span style="color: #24292F">(</span><span style="color: #0550AE">145</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">A</span><span style="color: #24292F">(</span><span style="color: #0550AE">125</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">]</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>IMO, all unnamed fields when debugged should be on one line despite the pretty flag.</p>
<h3 id="%23%5Bderive(partialeqextras)%5D" tabindex="-1"><code>#[derive(PartialEqExtras)]</code></h3>
<p>In a similar vein, <a href="https://github.com/kaleidawave/derive-partial-eq-extras">derive-partial-eq-extras</a> adds a more customisable <a href="https://doc.rust-lang.org/std/cmp/trait.PartialEq.html">PartialEq</a> implementation. It adds two new attributes for ignoring certain fields in the implementer.</p>
<p>For example, in my parser, expressions have positions and IDs. However, when comparing two expressions I want to treat them on a value basis and not based on position or identifiers. For example, given the literal expression <code>5</code>, I want AST to equal other <code>5</code>s, no matter where they have been parsed. To do this I simply add <code>#[partial_eq_ignore_types]</code>, which I can use easily on the expression AST:</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">#[derive(</span><span style="color: #FFA657">PartialEqExtras</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Debug</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Clone</span><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #C9D1D9">#[partial_eq_ignore_types(</span><span style="color: #FFA657">Span</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ExpressionId</span><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #FF7B72">pub</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">enum</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Expression</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">NumberLiteral</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">NumberStructure</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Span</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ExpressionId</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">StringLiteral</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">, #[partial_eq_ignore] </span><span style="color: #FFA657">Quoted</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Span</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ExpressionId</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">BooleanLiteral</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">bool</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Span</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ExpressionId</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">RegexLiteral</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">		pattern</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">		flags</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Option</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">&gt;,</span></span>
<span class="line"><span style="color: #C9D1D9">		position</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Span</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">		id</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ExpressionId</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	},</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">ArrayLiteral</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Vec</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">SpreadExpression</span><span style="color: #C9D1D9">&gt;, </span><span style="color: #FFA657">Span</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ExpressionId</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">ObjectLiteral</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">ObjectLiteral</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">...</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">#[derive(</span><span style="color: #953800">PartialEqExtras</span><span style="color: #24292F">, </span><span style="color: #953800">Debug</span><span style="color: #24292F">, </span><span style="color: #953800">Clone</span><span style="color: #24292F">)]</span></span>
<span class="line"><span style="color: #24292F">#[partial_eq_ignore_types(</span><span style="color: #953800">Span</span><span style="color: #24292F">, </span><span style="color: #953800">ExpressionId</span><span style="color: #24292F">)]</span></span>
<span class="line"><span style="color: #CF222E">pub</span><span style="color: #24292F"> </span><span style="color: #CF222E">enum</span><span style="color: #24292F"> </span><span style="color: #953800">Expression</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">NumberLiteral</span><span style="color: #24292F">(</span><span style="color: #953800">NumberStructure</span><span style="color: #24292F">, </span><span style="color: #953800">Span</span><span style="color: #24292F">, </span><span style="color: #953800">ExpressionId</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">StringLiteral</span><span style="color: #24292F">(</span><span style="color: #953800">String</span><span style="color: #24292F">, #[partial_eq_ignore] </span><span style="color: #953800">Quoted</span><span style="color: #24292F">, </span><span style="color: #953800">Span</span><span style="color: #24292F">, </span><span style="color: #953800">ExpressionId</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">BooleanLiteral</span><span style="color: #24292F">(</span><span style="color: #953800">bool</span><span style="color: #24292F">, </span><span style="color: #953800">Span</span><span style="color: #24292F">, </span><span style="color: #953800">ExpressionId</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">RegexLiteral</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">		pattern</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">String</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">		flags</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Option</span><span style="color: #24292F">&lt;</span><span style="color: #953800">String</span><span style="color: #24292F">&gt;,</span></span>
<span class="line"><span style="color: #24292F">		position</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Span</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">		id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">ExpressionId</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	},</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">ArrayLiteral</span><span style="color: #24292F">(</span><span style="color: #953800">Vec</span><span style="color: #24292F">&lt;</span><span style="color: #953800">SpreadExpression</span><span style="color: #24292F">&gt;, </span><span style="color: #953800">Span</span><span style="color: #24292F">, </span><span style="color: #953800">ExpressionId</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">ObjectLiteral</span><span style="color: #24292F">(</span><span style="color: #953800">ObjectLiteral</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">...</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>This is similar to <a href="https://docs.rs/educe/latest/educe/#ignore-fields-1">educe</a>, however it does not have the <em>ignore types</em> feature, so declarations can get clobbered with annotations on lots of fields. I did try and add it to educe but got a bit scared by its codebase.</p>
</blockquote>
<p>Again look into the sources and see that they are slim as they are built of <code>syn-helpers</code></p>
<h2 id="assisting-with-sum-enums" tabindex="-1">Assisting with sum <code>enum</code>s</h2>
<p>In the parser, I often have types that sum together some struct definitions like</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">#[derive(</span><span style="color: #FFA657">Debug</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Clone</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">PartialEq</span><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #FF7B72">pub</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">enum</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Declaration</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">Variable</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">VariableDeclaration</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">Function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Decorated</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">StatementFunction</span><span style="color: #C9D1D9">&gt;),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">Class</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Decorated</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">ClassDeclaration</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">StatementPosition</span><span style="color: #C9D1D9">&gt;&gt;),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">Enum</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Decorated</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">EnumDeclaration</span><span style="color: #C9D1D9">&gt;),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">#[derive(</span><span style="color: #953800">Debug</span><span style="color: #24292F">, </span><span style="color: #953800">Clone</span><span style="color: #24292F">, </span><span style="color: #953800">PartialEq</span><span style="color: #24292F">)]</span></span>
<span class="line"><span style="color: #CF222E">pub</span><span style="color: #24292F"> </span><span style="color: #CF222E">enum</span><span style="color: #24292F"> </span><span style="color: #953800">Declaration</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">Variable</span><span style="color: #24292F">(</span><span style="color: #953800">VariableDeclaration</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">Function</span><span style="color: #24292F">(</span><span style="color: #953800">Decorated</span><span style="color: #24292F">&lt;</span><span style="color: #953800">StatementFunction</span><span style="color: #24292F">&gt;),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">Class</span><span style="color: #24292F">(</span><span style="color: #953800">Decorated</span><span style="color: #24292F">&lt;</span><span style="color: #953800">ClassDeclaration</span><span style="color: #24292F">&lt;</span><span style="color: #953800">StatementPosition</span><span style="color: #24292F">&gt;&gt;),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">Enum</span><span style="color: #24292F">(</span><span style="color: #953800">Decorated</span><span style="color: #24292F">&lt;</span><span style="color: #953800">EnumDeclaration</span><span style="color: #24292F">&gt;),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">...</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Converting in and out can be a bit of a pain. If I have a function that takes a <code>Declaration</code> I need to remember the variant and then wrap the whole expression in it. So I created <a href="https://github.com/kaleidawave/derive-enum-from-into">derive enum from into</a>. With this, I can add <code>#[derive(EnumFrom, EnumTryInto)]</code> to have an easier time converting between the two (including immutable and mutable references).</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">#[derive(</span><span style="color: #FFA657">Debug</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Clone</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">EnumFrom</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">EnumTryInto</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">PartialEq</span><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #C9D1D9">#[try_into_references(</span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #FF7B72">pub</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">enum</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Declaration</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">Variable</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">VariableDeclaration</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">Function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Decorated</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">StatementFunction</span><span style="color: #C9D1D9">&gt;),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">Class</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Decorated</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">ClassDeclaration</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">StatementPosition</span><span style="color: #C9D1D9">&gt;&gt;),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">Enum</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Decorated</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">EnumDeclaration</span><span style="color: #C9D1D9">&gt;),</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">my_func</span><span style="color: #C9D1D9">(var_dec</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">VariableDeclaration</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> dec </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Declaration</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from</span><span style="color: #C9D1D9">(var_dec);</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">assert!</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">matches!</span><span style="color: #C9D1D9">(dec, </span><span style="color: #FFA657">Declaration</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Variable</span><span style="color: #C9D1D9">(_)));</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> result </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Decorated</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">StatementFunction</span><span style="color: #C9D1D9">&gt;</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">try_from</span><span style="color: #C9D1D9">(dec);</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">assert!</span><span style="color: #C9D1D9">(result</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_err</span><span style="color: #C9D1D9">());</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">#[derive(</span><span style="color: #953800">Debug</span><span style="color: #24292F">, </span><span style="color: #953800">Clone</span><span style="color: #24292F">, </span><span style="color: #953800">EnumFrom</span><span style="color: #24292F">, </span><span style="color: #953800">EnumTryInto</span><span style="color: #24292F">, </span><span style="color: #953800">PartialEq</span><span style="color: #24292F">)]</span></span>
<span class="line"><span style="color: #24292F">#[try_into_references(</span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">, </span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F">)]</span></span>
<span class="line"><span style="color: #CF222E">pub</span><span style="color: #24292F"> </span><span style="color: #CF222E">enum</span><span style="color: #24292F"> </span><span style="color: #953800">Declaration</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">Variable</span><span style="color: #24292F">(</span><span style="color: #953800">VariableDeclaration</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">Function</span><span style="color: #24292F">(</span><span style="color: #953800">Decorated</span><span style="color: #24292F">&lt;</span><span style="color: #953800">StatementFunction</span><span style="color: #24292F">&gt;),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">Class</span><span style="color: #24292F">(</span><span style="color: #953800">Decorated</span><span style="color: #24292F">&lt;</span><span style="color: #953800">ClassDeclaration</span><span style="color: #24292F">&lt;</span><span style="color: #953800">StatementPosition</span><span style="color: #24292F">&gt;&gt;),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">Enum</span><span style="color: #24292F">(</span><span style="color: #953800">Decorated</span><span style="color: #24292F">&lt;</span><span style="color: #953800">EnumDeclaration</span><span style="color: #24292F">&gt;),</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">...</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">my_func</span><span style="color: #24292F">(var_dec</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">VariableDeclaration</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">let</span><span style="color: #24292F"> dec </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Declaration</span><span style="color: #CF222E">::</span><span style="color: #8250DF">from</span><span style="color: #24292F">(var_dec);</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">assert!</span><span style="color: #24292F">(</span><span style="color: #8250DF">matches!</span><span style="color: #24292F">(dec, </span><span style="color: #953800">Declaration</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Variable</span><span style="color: #24292F">(_)));</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">let</span><span style="color: #24292F"> result </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Decorated</span><span style="color: #CF222E">::</span><span style="color: #24292F">&lt;</span><span style="color: #953800">StatementFunction</span><span style="color: #24292F">&gt;</span><span style="color: #CF222E">::</span><span style="color: #8250DF">try_from</span><span style="color: #24292F">(dec);</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">assert!</span><span style="color: #24292F">(result</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_err</span><span style="color: #24292F">());</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>This is a smaller, less configurable, <code>enum</code> only version of <a href="https://jeltef.github.io/derive_more/derive_more/from.html">#[derive(From)] from the derive_more crate</a></p>
</blockquote>
<p>This crate is actually my most downloaded, possibly because it seems to be used on this <a href="https://github.com/near/nearcore/blob/02bd5996d0e581f12768baa9f3f68849a77a8312/Cargo.toml#L121">popular project</a>.</p>
<h2 id="iterator-endiate" tabindex="-1">Iterator endiate</h2>
<p>A smaller one, but I often have a case when iterating through something I want to know if it is the last one. This often happens in the to-string part of my parser where I want to add a comma delimiter between items but don't want a trailing comma. For <a href="https://doc.rust-lang.org/stable/std/iter/trait.ExactSizeIterator.html">iterators with a known size</a>, this crate adds an <a href="http://xion.io/post/code/rust-extension-traits.html">extension trait</a> that adds the <code>endiate</code> method. Similar in functionality to the <code>enumerate</code>.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #8B949E">// adds `.endiate()` method to all (sized) iterators</span></span>
<span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">iterator_endiate</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">EndiateIteratorExt</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (at_end, item) </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> items</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">endiate</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">	settings</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">add_indent</span><span style="color: #C9D1D9">(depth, buf);</span></span>
<span class="line"><span style="color: #C9D1D9">	item</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_string_from_buffer</span><span style="color: #C9D1D9">(buf, settings, depth);</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">at_end {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> item</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">requires_semi_colon</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">			buf</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">';'</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">		}</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> settings</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">pretty {</span></span>
<span class="line"><span style="color: #C9D1D9">			buf</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">push_new_line</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">		}</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #6E7781">// adds `.endiate()` method to all (sized) iterators</span></span>
<span class="line"><span style="color: #CF222E">use</span><span style="color: #24292F"> </span><span style="color: #953800">iterator_endiate</span><span style="color: #CF222E">::</span><span style="color: #953800">EndiateIteratorExt</span><span style="color: #24292F">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">for</span><span style="color: #24292F"> (at_end, item) </span><span style="color: #CF222E">in</span><span style="color: #24292F"> items</span><span style="color: #CF222E">.</span><span style="color: #8250DF">iter</span><span style="color: #24292F">()</span><span style="color: #CF222E">.</span><span style="color: #8250DF">endiate</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">	settings</span><span style="color: #CF222E">.</span><span style="color: #8250DF">add_indent</span><span style="color: #24292F">(depth, buf);</span></span>
<span class="line"><span style="color: #24292F">	item</span><span style="color: #CF222E">.</span><span style="color: #8250DF">to_string_from_buffer</span><span style="color: #24292F">(buf, settings, depth);</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">!</span><span style="color: #24292F">at_end {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">if</span><span style="color: #24292F"> item</span><span style="color: #CF222E">.</span><span style="color: #8250DF">requires_semi_colon</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">			buf</span><span style="color: #CF222E">.</span><span style="color: #8250DF">push</span><span style="color: #24292F">(</span><span style="color: #0A3069">';'</span><span style="color: #24292F">);</span></span>
<span class="line"><span style="color: #24292F">		}</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">if</span><span style="color: #24292F"> settings</span><span style="color: #CF222E">.</span><span style="color: #24292F">pretty {</span></span>
<span class="line"><span style="color: #24292F">			buf</span><span style="color: #CF222E">.</span><span style="color: #8250DF">push_new_line</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">		}</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Also adds the <code>nendiate</code> for when you want to know you are not at the end</p>
<h2 id="enums-and-strings" tabindex="-1">Enums and strings</h2>
<p><a href="https://github.com/kaleidawave/enum-variants-strings">Enum variants strings</a> is a library for converting between (yes, both ways) <code>&amp;str</code> and <code>enum</code> structures. The derive macro handles generating this based on variant names. Mapping from a string to an <code>enum</code>, works for simple things that implement <a href="https://doc.rust-lang.org/stable/std/default/trait.Default.html"><code>Default</code></a>.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">use</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">enum_variants_strings</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">EnumVariantsStrings</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">#[derive(</span><span style="color: #FFA657">Debug</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">PartialEq</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">EnumVariantsStrings</span><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #FF7B72">enum</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Variants</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">X</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">Y</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">i32</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">    #[enum_variants_strings_mappings(</span><span style="color: #A5D6FF">"z"</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"zee"</span><span style="color: #C9D1D9">)]</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">Z</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        y</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">String</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    },</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">main</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">assert_eq!</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Variants</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_str</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"x"</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Variants</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">X</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">assert_eq!</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Variants</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_str</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"y"</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Variants</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Y</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)));</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">assert_eq!</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Variants</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_str</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"z"</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Ok</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Variants</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Z</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">String</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">default</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">            y</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">String</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">default</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">        })</span></span>
<span class="line"><span style="color: #C9D1D9">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">assert_eq!</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Variants</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">X</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_str</span><span style="color: #C9D1D9">(), </span><span style="color: #A5D6FF">"x"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">assert_eq!</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">Variants</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Z</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">            x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"abc"</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">            y</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"xyz"</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">into</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">to_str</span><span style="color: #C9D1D9">(),</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #A5D6FF">"zee"</span></span>
<span class="line"><span style="color: #C9D1D9">    );</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">use</span><span style="color: #24292F"> </span><span style="color: #953800">enum_variants_strings</span><span style="color: #CF222E">::</span><span style="color: #953800">EnumVariantsStrings</span><span style="color: #24292F">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">#[derive(</span><span style="color: #953800">Debug</span><span style="color: #24292F">, </span><span style="color: #953800">PartialEq</span><span style="color: #24292F">, </span><span style="color: #953800">EnumVariantsStrings</span><span style="color: #24292F">)]</span></span>
<span class="line"><span style="color: #CF222E">enum</span><span style="color: #24292F"> </span><span style="color: #953800">Variants</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">X</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">Y</span><span style="color: #24292F">(</span><span style="color: #953800">i32</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">    #[enum_variants_strings_mappings(</span><span style="color: #0A3069">"z"</span><span style="color: #24292F">, </span><span style="color: #0A3069">"zee"</span><span style="color: #24292F">)]</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">Z</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">String</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        y</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">String</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">    },</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">main</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">assert_eq!</span><span style="color: #24292F">(</span><span style="color: #953800">Variants</span><span style="color: #CF222E">::</span><span style="color: #8250DF">from_str</span><span style="color: #24292F">(</span><span style="color: #0A3069">"x"</span><span style="color: #24292F">), </span><span style="color: #953800">Ok</span><span style="color: #24292F">(</span><span style="color: #953800">Variants</span><span style="color: #CF222E">::</span><span style="color: #953800">X</span><span style="color: #24292F">));</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">assert_eq!</span><span style="color: #24292F">(</span><span style="color: #953800">Variants</span><span style="color: #CF222E">::</span><span style="color: #8250DF">from_str</span><span style="color: #24292F">(</span><span style="color: #0A3069">"y"</span><span style="color: #24292F">), </span><span style="color: #953800">Ok</span><span style="color: #24292F">(</span><span style="color: #953800">Variants</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Y</span><span style="color: #24292F">(</span><span style="color: #0550AE">0</span><span style="color: #24292F">)));</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">assert_eq!</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Variants</span><span style="color: #CF222E">::</span><span style="color: #8250DF">from_str</span><span style="color: #24292F">(</span><span style="color: #0A3069">"z"</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Ok</span><span style="color: #24292F">(</span><span style="color: #953800">Variants</span><span style="color: #CF222E">::</span><span style="color: #953800">Z</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">            x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">String</span><span style="color: #CF222E">::</span><span style="color: #8250DF">default</span><span style="color: #24292F">(),</span></span>
<span class="line"><span style="color: #24292F">            y</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">String</span><span style="color: #CF222E">::</span><span style="color: #8250DF">default</span><span style="color: #24292F">(),</span></span>
<span class="line"><span style="color: #24292F">        })</span></span>
<span class="line"><span style="color: #24292F">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">assert_eq!</span><span style="color: #24292F">(</span><span style="color: #953800">Variants</span><span style="color: #CF222E">::</span><span style="color: #953800">X</span><span style="color: #CF222E">.</span><span style="color: #8250DF">to_str</span><span style="color: #24292F">(), </span><span style="color: #0A3069">"x"</span><span style="color: #24292F">);</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #8250DF">assert_eq!</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">Variants</span><span style="color: #CF222E">::</span><span style="color: #953800">Z</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">            x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0A3069">"abc"</span><span style="color: #CF222E">.</span><span style="color: #8250DF">into</span><span style="color: #24292F">(),</span></span>
<span class="line"><span style="color: #24292F">            y</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0A3069">"xyz"</span><span style="color: #CF222E">.</span><span style="color: #8250DF">into</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">        }</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">.</span><span style="color: #8250DF">to_str</span><span style="color: #24292F">(),</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0A3069">"zee"</span></span>
<span class="line"><span style="color: #24292F">    );</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p><a href="https://github.com/kaleidawave/ezno/blob/75d31ddb60eee495915fcf805a56221d2e79ce7d/src/ast_explorer.rs#L40">I use it for changing between modes in the ast-playground of Ezno</a>.</p>
<h2 id="deploying-rust-with-github-actions" tabindex="-1">Deploying Rust with GitHub actions</h2>
<p>In my crates, I want the update commit to automatically push the version change back to the repository. If I do it manually, I always forget to push after, things get out of sync.</p>
<p>So I built a GitHub action for doing this: <a href="https://github.com/kaleidawave/crates-release-gh-action">crates-release-action</a></p>
<p>Here is how you can use it:</p>
<pre><code class="language-yaml"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #7EE787">name</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">Release crate</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79C0FF">on</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #7EE787">workflow_dispatch</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #7EE787">inputs</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #7EE787">version</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #7EE787">description</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"major/minor/patch or semver"</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #7EE787">required</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">false</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #7EE787">default</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">"patch"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7EE787">concurrency</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">release-crate</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7EE787">jobs</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #7EE787">publish</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #7EE787">runs-on</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">ubuntu-latest</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #7EE787">steps</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">      - </span><span style="color: #7EE787">uses</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">actions/checkout@v3</span></span>
<span class="line"><span style="color: #C9D1D9">      - </span><span style="color: #7EE787">name</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">Set git credentials</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #7EE787">run</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">|</span></span>
<span class="line"><span style="color: #A5D6FF">          git config user.name github-actions</span></span>
<span class="line"><span style="color: #A5D6FF">          git config user.email github-actions@github.com</span></span>
<span class="line"><span style="color: #C9D1D9">      - </span><span style="color: #7EE787">name</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">Crates publish</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #7EE787">uses</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">kaleidawave/crates-release-gh-action@main</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #7EE787">id</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">release</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #7EE787">with</span><span style="color: #C9D1D9">:</span></span>
<span class="line"><span style="color: #C9D1D9">          </span><span style="color: #7EE787">version</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">$</span></span>
<span class="line"><span style="color: #C9D1D9">          </span><span style="color: #7EE787">crates-token</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">$</span></span>
<span class="line"><span style="color: #C9D1D9">      - </span><span style="color: #7EE787">name</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">Push updated Cargo.toml</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #7EE787">run</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">|</span></span>
<span class="line"><span style="color: #A5D6FF">          git add .</span></span>
<span class="line"><span style="color: #A5D6FF">          git commit -m "Release: $"</span></span>
<span class="line"><span style="color: #A5D6FF">          git tag "release/$"</span></span>
<span class="line"><span style="color: #A5D6FF">          git push --tags origin main</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #116329">name</span><span style="color: #24292F">: </span><span style="color: #0A3069">Release crate</span></span>
<span class="line"></span>
<span class="line"><span style="color: #0550AE">on</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">  </span><span style="color: #116329">workflow_dispatch</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #116329">inputs</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">      </span><span style="color: #116329">version</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #116329">description</span><span style="color: #24292F">: </span><span style="color: #0A3069">"major/minor/patch or semver"</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #116329">required</span><span style="color: #24292F">: </span><span style="color: #0550AE">false</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #116329">default</span><span style="color: #24292F">: </span><span style="color: #0A3069">"patch"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #116329">concurrency</span><span style="color: #24292F">: </span><span style="color: #0A3069">release-crate</span></span>
<span class="line"></span>
<span class="line"><span style="color: #116329">jobs</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">  </span><span style="color: #116329">publish</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #116329">runs-on</span><span style="color: #24292F">: </span><span style="color: #0A3069">ubuntu-latest</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #116329">steps</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">      - </span><span style="color: #116329">uses</span><span style="color: #24292F">: </span><span style="color: #0A3069">actions/checkout@v3</span></span>
<span class="line"><span style="color: #24292F">      - </span><span style="color: #116329">name</span><span style="color: #24292F">: </span><span style="color: #0A3069">Set git credentials</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #116329">run</span><span style="color: #24292F">: </span><span style="color: #CF222E">|</span></span>
<span class="line"><span style="color: #0A3069">          git config user.name github-actions</span></span>
<span class="line"><span style="color: #0A3069">          git config user.email github-actions@github.com</span></span>
<span class="line"><span style="color: #24292F">      - </span><span style="color: #116329">name</span><span style="color: #24292F">: </span><span style="color: #0A3069">Crates publish</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #116329">uses</span><span style="color: #24292F">: </span><span style="color: #0A3069">kaleidawave/crates-release-gh-action@main</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #116329">id</span><span style="color: #24292F">: </span><span style="color: #0A3069">release</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #116329">with</span><span style="color: #24292F">:</span></span>
<span class="line"><span style="color: #24292F">          </span><span style="color: #116329">version</span><span style="color: #24292F">: </span><span style="color: #0A3069">$</span></span>
<span class="line"><span style="color: #24292F">          </span><span style="color: #116329">crates-token</span><span style="color: #24292F">: </span><span style="color: #0A3069">$</span></span>
<span class="line"><span style="color: #24292F">      - </span><span style="color: #116329">name</span><span style="color: #24292F">: </span><span style="color: #0A3069">Push updated Cargo.toml</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #116329">run</span><span style="color: #24292F">: </span><span style="color: #CF222E">|</span></span>
<span class="line"><span style="color: #0A3069">          git add .</span></span>
<span class="line"><span style="color: #0A3069">          git commit -m "Release: $"</span></span>
<span class="line"><span style="color: #0A3069">          git tag "release/$"</span></span>
<span class="line"><span style="color: #0A3069">          git push --tags origin main</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>It handles:</p>
<ul>
<li>Finding manifests</li>
<li>Applying <code>major</code>, <code>minor</code> or <code>patch</code> to a version (or an exact version) and updating the contents of <code>Cargo.toml</code></li>
<li>Finding local manifests that reference it as a path dependency to update their version</li>
<li>Publishing to <a href="https://crates.io/">crates.io</a></li>
<li>Outputting the new version(s) in a machine-readable format (so it can be referenced in commit names and tags)</li>
</ul>
<p>You can run it through <a href="https://docs.github.com/en/actions/managing-workflow-runs/manually-running-a-workflow">github.com</a></p>
<img src="../../media/demos/github-publish-crate-ui.png" alt="GitHub publish crate UI">
<p>Or from the command line with <a href="https://cli.github.com/">gh</a></p>
<video src="../../media/demos/crates-gh-push.mp4" controls="" title="Crates GH push"></video>
<p>Which I can watch</p>
<img src="../../media/demos/github-publish-crate-cl-watch.png" alt="GitHub publish crate watch">
<p>Behind the scenes, it updates the packages in the order of least dependency (I don't want to rely on myself for ordering arguments, <a href="https://github.com/kaleidawave/crates-release-gh-action/blob/4dd293538aec8fc068acf08f35e60c0d015b7547/updater.py#L54-L66">it can be calculated</a>). It also uses a TOML parser that retains the TOML formatting. It is currently written in Python. If anyone wants to rewrite it in Rust and/or add more functionality, LMK!</p>
<blockquote>
<p>It is a manual action currently, and isn't particularly automated. It doesn't track changes in a workspace, or figure out <em>Semver</em> or build changelogs. I want the base to be simple and un-opinionated</p>
</blockquote>
<hr>
<p>I didn't have space but two more crates I have made are: <a href="https://crates.io/crates/multiline-term-input">multiline-term-input</a>, which is a way to break into new lines during console input (<a href="https://github.com/kaleidawave/multiline-term-input/issues/1">I need a wiz to add Linux support</a>) and <a href="https://crates.io/crates/temporary-annex">temporary-annex</a> that helps to work with appending data temporarily while reusing <strong>the same</strong> backing (linear) buffer.</p>
<p>And that is all. If you have built or used any cool Rust libraries or additional tools let me know in the comments!</p>

</div>

<div class="discussions">
    <script src="https://giscus.app/client.js" data-repo="kaleidawave/discussions" data-repo-id="R_kgDOIy08KA" data-category="Comments" data-category-id="DIC_kwDOIy08KM4CTpn8" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async="">
            </script>
</div>

<script defer="">
    for (const video of document.querySelectorAll("video")) {
        video.addEventListener("mouseover", (ev) => {
            ev.target.play();
        })
    }
</script>

        </div>
        
    </main>
    <footer>
        <div class="width-box">
            <form>
                <label for="toggle-theme">Light Mode</label>
                <input type="checkbox" name="toggle-theme" id="toggle-theme">
            </form>
            <nav>
                <ul>
                    <li>
                        <a href="https://bsky.app/profile/kaleidawave.bsky.social">Bluesky <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/kaleidawave">Twitter <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://github.com/kaleidawave">GitHub <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a>
                    </li>
                    <li>
                        Built with <a href="https://www.11ty.dev/"><svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3.398 12V0h17.204v24H3.398zm13.17 6.07a1.07 1.07 0 00.373-.107c.432-.213.68-.672.877-1.626.076-.372 1.195-6.168 1.209-6.263.026-.186-.008-.382-.084-.476a.325.325 0 00-.087-.064l-.06-.031h-.291c-.253 0-.298 0-.348.02-.113.039-.207.156-.255.316-.011.038-.168.881-.348 1.873l-.328 1.802-.046-.21c-.56-2.547-.764-3.452-.794-3.532a.383.383 0 00-.103-.16c-.105-.107-.117-.11-.567-.11-.411 0-.422 0-.5.074-.086.079-.122.216-.111.42.006.115.045.27.688 2.784.663 2.587.751 2.943.787 3.177.046.3-.05.713-.208.893-.032.037-.037.039-.084.032-.028 0-.12-.027-.204-.051-.268-.078-.362-.072-.462.028-.096.096-.137.248-.138.51 0 .256.028.34.159.473.131.133.324.208.595.23.164.012.22.012.33-.001zm-1.896-1.712a.31.31 0 00.16-.192c.02-.058.022-.098.022-.356 0-.255-.003-.299-.021-.354-.04-.121-.136-.196-.278-.217-.041-.01-.2-.01-.355-.01-.365-.001-.378-.01-.446-.184-.068-.18-.096-.326-.113-.602a85.799 85.799 0 01-.012-1.94v-1.765h.35c.454 0 .507-.01.602-.113a.465.465 0 00.102-.24 3.273 3.273 0 000-.534c-.026-.16-.099-.271-.211-.322-.057-.025-.065-.026-.45-.03h-.392l-.003-1.22c-.003-1.09-.005-1.227-.021-1.278a.378.378 0 00-.201-.247c-.052-.024-.072-.025-.32-.029-.27 0-.356 0-.429.038-.087.042-.148.133-.185.278-.014.054-.032.346-.076 1.262l-.06 1.194s-.08 0-.18.01c-.206.01-.263.022-.327.086-.092.092-.12.19-.127.455-.01.334.02.487.115.588.075.081.134.1.345.106l.173.01v1.785c0 1.7.006 2.019.034 2.274.041.37.13.709.241.928.194.38.544.617.988.668h1.005l.07-.04zm-7.447 0c.098-.053.16-.154.2-.332.016-.077.018-.401.018-4.518 0-4.184-.001-4.44-.02-4.51-.05-.194-.19-.29-.378-.26-.035.01-.344.084-.686.175-.343.09-.684.18-.758.198-.17.043-.214.062-.281.126-.105.098-.122.185-.122.606 0 .416.016.5.12.604.094.095.189.1.456.03.103-.026.193-.048.2-.048.01 0 .014.784.017 3.763.003 3.436.005 3.77.021 3.84.048.202.113.296.236.34.034.013.133.016.487.014.435 0 .445 0 .49-.027zm3.203 0c.092-.046.152-.135.197-.29l.024-.084.003-4.435c.002-3.194 0-4.456-.01-4.509-.033-.2-.145-.308-.322-.308-.066 0-.198.03-.857.204-.56.147-.799.214-.849.239a.34.34 0 00-.17.184c-.024.06-.024.071-.024.479 0 .415 0 .417.026.483a.362.362 0 00.083.12c.1.1.172.105.456.034a5.46 5.46 0 01.208-.05c.008 0 .012 1.202.014 3.791l.003 3.79.026.086a.48.48 0 00.135.23c.078.062.085.063.57.06.414 0 .447 0 .487-.024z"></path></svg> Eleventy</a> and
                        <a href="/architecture">others</a>
                    </li>
                </ul>
            </nav>
        </div>
    </footer>
    <script>
        if (localStorage.getItem("theme") === null) {
    changeScheme();
} else {
    updateThemeClass();
}

function changeScheme(darkTheme = null) {
    if (darkTheme === null) {
        if ("matchMedia" in window) {
            darkTheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
        } else {
            darkTheme = false;
        }
    }
    localStorage.setItem("theme", darkTheme ? "dark" : "light");
    updateThemeClass();
}

function updateThemeClass(value = null) {
    if (value === null) {
        value = localStorage.getItem("theme") === "dark";
    }
    if (value) {
        document.documentElement.classList.add("dark");
    } else {
        document.documentElement.classList.remove("dark");
    }
}

{
    const themeSwitch = document.querySelector("#toggle-theme");
    themeSwitch.checked = localStorage.getItem("theme") !== "dark";
    themeSwitch.addEventListener("change", (ev) => {
        const darkTheme = !ev.target.checked;
        changeScheme(darkTheme);
    });
}

// Clicking on headers stores their reference
document.addEventListener("click", (ev) => {
    if (ev.target.matches(".post > *:is(h2, h3, h4, h5)")) {
        const id = ev.target.getAttribute("id");
        if (id !== null) {
            location.href = '#' + id;
        }
    }
});

const titleBar = document.querySelector("header .icon-title")

titleBar.querySelector("img").addEventListener("dragend", () => {
    const r = document.createElement("video");
    const s = document.createElement("source");
    s.src = "/media/boom.webm";
    r.append(s);
    r.controls = false;
    titleBar.appendChild(r);
    r.addEventListener("ended", () => {
        titleBar.querySelector(".header-title").innerText = "Bengineering";
        r.style.display = "none";
    });
    r.play();

})

// TODO temp hack for highlighted rows in code blocks
for (const element of document.querySelectorAll("[data-highlight]")) {
    const indexes = element.getAttribute("data-highlight").split(",").map(a => parseInt(a));
    for (const pres of element.children[0].children) {
        // TODO adjacent indices don't style well, could do something here
        for (const index of indexes) {
            const line = pres.children[0].children[index];
            const firstChild = line.children[0];
            const newContent = firstChild.textContent.trimLeft();
            const indent = firstChild.textContent.length - newContent.length;
            firstChild.childNodes[0].data = newContent;
            line.style.marginLeft = indent + 'ch';
            line.classList.add("highlight");
        }
    }
}

    </script>


</body></html>