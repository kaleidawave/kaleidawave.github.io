<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="google-site-verification" content="pi8qBei6qHxHyGxm9Eh4WDhPwxU672uIJmfdIqcgIGs">
    <meta name="referrer" content="no-referrer-when-downgrade">

    
    <!-- Cloudflare Web Analytics -->
    <script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;9a3f0b71c0ea4b3d99621e1b084c24cd&quot;}"></script>
    <!-- End Cloudflare Web Analytics -->
    

    <title>Ideas on type inference</title>

    <meta name="title" content="Ideas on type inference">
    <meta property="og:title" content="Ideas on type inference">
    <meta property="twitter:title" content="Ideas on type inference">

    <meta name="description" content="TypeScript sans annotations">
    <meta property="og:description" content="TypeScript sans annotations">
    <meta property="twitter:description" content="TypeScript sans annotations">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kaleidawave.github.io/">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kaleidawave.github.io/">

    
    <meta property="twitter:image" content="https://kaleidawave.github.io/media/banners/ideas-on-inference.png">
    <meta property="og:image" content="https://kaleidawave.github.io/media/banners/ideas-on-inference.png">
    

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link rel="preconnect" href="https://fonts.gstatic.com"><link data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap" rel="stylesheet"><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap">/* vietnamese */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW86Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW87Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW81Rb0JcBao.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZJhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZthjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* greek-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZNhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+1F00-1FFF;
}
/* greek */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZxhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
/* vietnamese */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZBhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZFhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl618BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6R8BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* vietnamese */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl698BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl658BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6B8BtxaV4jcFw.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style>

    <style>:root {
    font-family: "SF Pro Display", "SF Pro Icons", "Inter", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
    font-weight: 400;

    --text-color: #1a1a1a;
    --border: var(--text-color);
    --background: #F2F0EB;
    --muted-background: #f9f5f8;
    --muted-background-opaque: #e4e0da80;
    --accent: #bc3b3b;
    --muted-accent: #993b33;
    --code-highlight: #e2ccb7;
}

@media screen {
    :root.dark {
        --text-color: #dbdbdb;
        --background: #0f0f10;
        --muted-background: #1f1f23;
        --muted-background-opaque: #1f1f2380;
        --accent: #a8ff8e;
        --muted-accent: #81b47c;
        --code-highlight: #549463;
    }
}

:root.dark .shiki-light {
    display: none;
}

:root:not(.dark) .shiki-dark {
    display: none;
}

html,
body {
    margin: 0;
    padding: 0;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    font-size: 16px;
}

body {
    background-color: var(--background, white);
    color: var(--text-color, black);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

header {
    background-color: var(--muted-background-opaque, white);
    display: flex;
    justify-content: space-around;
    align-items: center;
    font-size: 16px;
    padding: 14px;
}

:root:not(.dark) header {
    border-bottom: 2px solid var(--border);
}

header>div {
    width: 100% !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

header video {
    position: absolute;
}

header h1 {
    font-weight: 100;
    font-size: 20px;
    color: var(--text-color);
}

header h1>a {
    color: var(--text-color) !important;
}

header .icon-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

header img {
    position: relative;
    top: -4px;
    height: 26px;
    width: auto;
}

@media print {
    header nav {
        display: none;
    }

    footer {
        display: none;
    }
}

header nav>ul {
    padding-left: 0;
    display: flex;
    list-style: none;
}

header nav>ul>li {
    margin-left: 10px;
    text-transform: lowercase;
}

h1,
h2,
h3,
h4,
h5 {
    font-family: "Be Vietnam Pro", sans-serif;
    font-weight: 600;
    scroll-margin: 100px;
}

*::selection {
    background: var(--muted-accent);
    color: var(--background);
}

em {
    position: relative;
    left: -2px;
}

ul,
ol {
    margin: 0px;
    padding-left: 20px;
}

hr {
    width: 100%;
    margin: 30px auto;
    border: none;
    border-top: 1px solid var(--text-color);
}

main {
    margin: 20px 0 80px;
}

.width-box {
    width: 95%;
    margin: 0 auto;
}

svg.icon {
    height: 10pt;
    fill: var(--muted-accent);
    position: relative;
    top: 2px;
}

a {
    color: var(--accent, white);
    text-decoration: none;
}

a:visited {
    color: var(--muted-accent, white);
}

pre code {
    white-space: break-spaces !important;
    overflow-x: hidden;
    tab-size: 4;
}

/* Shrink inline code a little bit */
:is(div, p, a, li)>code {
    font-size: 90%;
}

pre,
code {
    background-color: var(--muted-background) !important;
    font-family: 'JetBrains Mono', 'Fira Code light', consolas, monospace;
    font-size: 14px;
}

footer {
    margin-top: auto;
    background-color: var(--muted-background-opaque, white);
    padding: 22px;
}

:root:not(.dark) footer {
    border-top: 2px solid var(--border);
}

footer>div {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

footer h3 {
    margin: 0;
    font-weight: inherit;
    font-size: 16px;
}

footer nav ul {
    list-style: none;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

footer nav ul>li:not(:first-child) {
    border-left: 2px solid var(--muted-accent);
    padding-left: 6px;
}

footer>div>*:nth-child(2n) {
    margin-left: auto;
    font-size: 10pt;
}

@media screen and (max-width: 480px) {
    header>div {
        flex-direction: column;
    }

    body {
        width: 100vw;
        box-sizing: border-box;
    }

    .posts>ul>li img {
        width: 100%;
        height: auto;
    }
}

@media screen and (min-width: 480px) {
    @supports (backdrop-filter: blur(20px)) {
        header {
            backdrop-filter: blur(20px);
        }
    }

    header {
        position: sticky;
        top: 0;
        right: 0;
        left: 0;
        z-index: 100;
    }

    .width-box {
        width: 100%;
        max-width: min(80vw, 840px);
    }
}</style>
    <link rel="alternate" type="application/rss+xml" href="/feed.xml">
</head>

<body>
    <header>
        <div class="width-box">
            <a class="icon-title" href="/">
                <h1 class="header-title">Ben's Engineering Blog</h1>
                <img draggable="true" src="/media/icon.png" width="256" height="256" alt="">
                
            </a>
            <nav>
                <ul>
                    <li><a href="/posts">Posts</a></li>
                    <li><a href="/about">About</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main>
        
        <div class="width-box">
            <style>.post {
    display: flex;
    flex-direction: column;
}

.post>p,
.post li,
.post blockquote {
    line-height: 1.6em;
    margin: 6px 0;
    font-weight: inherit;
    font-family: "Inter", "Helvetica", sans-serif;
}

.post>*:is(h1, h2, h3, h4, h5) {
    margin: 12pt 0;
}

.post img,
.post video,
.post pre:not(.shiki) {
    margin: 20px 0;
}

.post pre.shiki {
    margin: 0;
}

/* Dark mode by default */
:root:not(.dark) .post img.invertible,
:root:not(.dark) .post video.invertible {
    filter: invert(1);
}

.post img {
    border-radius: 10px;
}

.post svg.icon {
    height: 1em;
    fill: var(--text-color);
}

.post span.line.highlight {
    font-weight: bold;
    background-color: var(--code-highlight);
    outline: 4px var(--code-highlight) solid;
}

.post .shiki-container {
    padding: 20px;
}

.post .math {
    margin: auto;
}

.post .math>svg {
    width: auto;
    height: 200%;
    margin: 10px;
}

.post .quote {
    font-style: italic;
}

.post .quote::before {
    content: '"';
}

.post .quote::after {
    content: '"';
}

.post *[role="caption"] {
    font-size: 14px;
    margin: 6px 0 20px;
    padding: 6px;
    text-align: center;
    font-weight: normal;
    opacity: 0.8;
}

.post time {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 11pt;
    font-family: monospace;
}

.post .center {
    text-align: center;
    font-weight: inherit;
    padding: 30px;
}

.post .note {
    font-style: italic;
    font-size: 12pt;
    opacity: 0.8;
}

*:is(h1, h2, h3, h4, h5, h6)>code {
    font-size: 0.8em;
}

*:is(h1, h2, h3, h4, h5, h6, p, li)>code {
    padding: 2px 6px;
}

/* For footnotes */
.post a[href^="#foot"] {
    font-family: monospace;
    position: relative;
    top: -5px;
    left: 2px;
}

.post #footnotes~* {
    font-size: 14px;
    margin: 4px 0;
    width: 100%;
}

video.small {
    max-height: 300px !important;
}

.callout {
    margin-top: 18px;
    padding: 20px;
    font-size: 15pt;
    background-color: var(--muted-background);
    border-radius: 16px;
    border: 3px solid var(--muted-accent);
}

.post h1.title {
    font-size: 40px;
}

.post h1 {
    font-size: 32px;
}

.post h2 {
    font-size: 28px;
}

.post h3 {
    font-size: 24px;
}

.post h4 {
    font-size: 20px;
}

.post h5 {
    font-size: 16px;
}

.post a.media-container>img {
    width: 100%;
}

.post table {
    border-spacing: 0;
    border-collapse: collapse;
    margin: 40px 0;
    /* max-width: 100%;
    overflow: scroll; */
}

.post table td,
.post table th {
    border: 2px solid var(--text-color);
    padding: 6px 8px;
    text-align: left;
}

.post blockquote {
    border-left: 4px solid var(--muted-accent);
    margin: 10px 0;
    padding: 5px 10px;
    background: var(--muted-background-opaque);
}

.post blockquote>p {
    margin: 0;
}

.post .widget {
    background: white;
    border-radius: 6px;
    padding: 50px;
    margin: 40px 0;
}

.discussions {
    margin: 80px 0px;
}

.parralel pre:not(.shiki) {
    font-size: 12px;
}

@media screen and (max-width: 480px) {
    .center {
        text-align: center;
        font-weight: inherit;
        padding: 10px 0px;
    }

    .post>p,
    .post li {
        font-size: 12pt;
        line-height: 1.4em;
    }

    .post img,
    .post pre,
    .post table,
    .post .widget,
    .post video {
        width: 100%;
        height: auto;
    }

    .post pre {
        overflow-x: auto;
    }
}

@media screen and (min-width: 480px) {
    .post>.parralel {
        display: flex;
        gap: 30px;
    }

    .post>.parralel>div {
        flex-grow: 1;
    }

    .post img,
    .post video,
    .post pre:not(.shiki) {
        align-self: center;
        height: auto;
    }

    .post>img,
    .post>video,
    .post table,
    .post .widget,
    .post>a.media-container,
    .post>.parralel,
    .post>pre:not(.shiki) {
        width: 105%;
        align-self: center;
    }
}

@media print {
    .post video {
        display: none;
    }
}</style>

<div class="post">
    <h1 class="title">Ideas on type inference</h1>
    
    <time datetime="2025-09-26">
        Published on Friday 26<sup>th</sup> September 2025
        
    </time>
    
    <p>In the third and final post of Ezno week, we will take a look at two kinds of type inference. One kind what I refer to as <code>forward</code> and the other as <code>backward</code>. One <em>implemented</em> and the other a <em>work-in-progress</em>.</p>
<p>The words inference in a type-checker refers to creating (or finding) a type <strong>for a parameter</strong> (or variable in some cases). Often because the annotation is elided (fancy compiler speak for missing). Inference is a subset of a more general term of <em>type synthesis</em>.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #8B949E">//                          ‚Üì no annotation here</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">y</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">].</span><span style="color: #D2A8FF">map</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">item</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> item)</span></span>
<span class="line"><span style="color: #8B949E">//                          	 ‚Üë `item` *has* type `number` here</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #6E7781">//                          ‚Üì no annotation here</span></span>
<span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">y</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> [</span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #0550AE">2</span><span style="color: #24292F">, </span><span style="color: #0550AE">3</span><span style="color: #24292F">].</span><span style="color: #8250DF">map</span><span style="color: #24292F">(</span><span style="color: #953800">item</span><span style="color: #24292F"> </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> item)</span></span>
<span class="line"><span style="color: #6E7781">//                          	 ‚Üë `item` *has* type `number` here</span></span>
<span class="line"></span></code></pre></div></code></pre>
<h3 id="forward-inference%3A-pushing-an-annotation-forwards" tabindex="-1">Forward inference: pushing an annotation forwards</h3>
<p>The first kind that I refer to forward is in partially annotated (or realised) source text. We have a function parameter <strong>without an annotation</strong> but we can figure <em>a type</em> out through looking at the context of where the containing function is written in.</p>
<blockquote>
<p>If you have read <a href="/posts/specification-speed-schedule">the section on performance in the last post</a>, you may have seen that TSC records a time for a <code>bind</code> pass but Ezno does not. I am not hiding that result, but infact the bind phase and check phase are merged in Ezno. Excluding the pass on top level declarations in a block used for <a href="https://developer.mozilla.org/en-US/docs/Glossary/Hoisting">hoisting</a>, the AST is only walked once (compared to twice in TSC <em>I think</em>).</p>
</blockquote>
<p>This can happen with and without annotations. If we declare a function as the value of variable <strong>that is annotated</strong> we need to <em>push</em> the annotation forward</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #8B949E">//                                        ‚Üì no annotation here</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">increment</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">x</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">//                      ‚Üò----------------‚Üó</span></span>
<span class="line"><span style="color: #8B949E">//         we push the `number` parameter annotation forward</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #6E7781">//                                        ‚Üì no annotation here</span></span>
<span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #8250DF">increment</span><span style="color: #CF222E">:</span><span style="color: #24292F"> (</span><span style="color: #953800">x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F">) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">x</span><span style="color: #24292F"> </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> x </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #0550AE">1</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #6E7781">//                      ‚Üò----------------‚Üó</span></span>
<span class="line"><span style="color: #6E7781">//         we push the `number` parameter annotation forward</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>But we also have cases where the user source is not annotated. For example in <code>Promise.prototype.then</code></p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #8B949E">//                           ‚Üì no annotation here</span></span>
<span class="line"><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"..."</span><span style="color: #C9D1D9">).</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">res</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #8B949E">//  using information about  ‚Üì</span></span>
<span class="line"><span style="color: #8B949E">//  what `fetch` returns     ‚Üì</span></span>
<span class="line"><span style="color: #8B949E">//  we can figure out that `res` is a `Response`</span></span>
<span class="line"><span style="color: #C9D1D9">})</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #6E7781">//                           ‚Üì no annotation here</span></span>
<span class="line"><span style="color: #8250DF">fetch</span><span style="color: #24292F">(</span><span style="color: #0A3069">"..."</span><span style="color: #24292F">).</span><span style="color: #8250DF">then</span><span style="color: #24292F">(</span><span style="color: #CF222E">function</span><span style="color: #24292F"> (</span><span style="color: #953800">res</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #6E7781">//  using information about  ‚Üì</span></span>
<span class="line"><span style="color: #6E7781">//  what `fetch` returns     ‚Üì</span></span>
<span class="line"><span style="color: #6E7781">//  we can figure out that `res` is a `Response`</span></span>
<span class="line"><span style="color: #24292F">})</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>This is why I refer to it as <em>forward</em>. Using an annotation or other context we pass information forward in the source / buffer to figure out the <em>type</em> of the parameter.</p>
<h4 id="the-basics-of-the-implementation" tabindex="-1">The basics of the implementation</h4>
<p>The implementation is quite simple, we pass an <em>expected type</em> through our <code>synthesise_expression</code> function.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">synthesise_expression</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">	expression</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;</span><span style="color: #FFA657">ezno_parser</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ast</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Expression</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #8B949E">	// ‚Üì</span></span>
<span class="line"><span style="color: #C9D1D9">	expected_type</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TypeId</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #8B949E">	// ‚Üë</span></span>
<span class="line"><span style="color: #C9D1D9">	environment</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9">, </span></span>
<span class="line"><span style="color: #C9D1D9">	checking_data</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9"> etc</span></span>
<span class="line"><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TypeId</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">synthesise_expression</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">	expression</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #953800">ezno_parser</span><span style="color: #CF222E">::</span><span style="color: #953800">ast</span><span style="color: #CF222E">::</span><span style="color: #953800">Expression</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #6E7781">	// ‚Üì</span></span>
<span class="line"><span style="color: #24292F">	expected_type</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">TypeId</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #6E7781">	// ‚Üë</span></span>
<span class="line"><span style="color: #24292F">	environment</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">...</span><span style="color: #24292F">, </span></span>
<span class="line"><span style="color: #24292F">	checking_data</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">...</span><span style="color: #24292F"> etc</span></span>
<span class="line"><span style="color: #24292F">) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #953800">TypeId</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>So in the above example, we pass the <em>resolved</em> type in the variable</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">synthesise_variable_declaration</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">	variable_declaration</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;</span><span style="color: #FFA657">ezno_parser</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ast</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Expression</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">...</span></span>
<span class="line"><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #8B949E">	// ...</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> expected_type </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">synthesise_type_annotation</span><span style="color: #C9D1D9">(variable_declaration</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">type_annotation, </span><span style="color: #8B949E">/* ... */</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> value </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">synthesise_expression</span><span style="color: #C9D1D9">(variable_declaration</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">expression, expected_type, </span><span style="color: #8B949E">/* ... */</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #8B949E">	// ...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">synthesise_variable_declaration</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">	variable_declaration</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #953800">ezno_parser</span><span style="color: #CF222E">::</span><span style="color: #953800">ast</span><span style="color: #CF222E">::</span><span style="color: #953800">Expression</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">...</span></span>
<span class="line"><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #6E7781">	// ...</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">let</span><span style="color: #24292F"> expected_type </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">synthesise_type_annotation</span><span style="color: #24292F">(variable_declaration</span><span style="color: #CF222E">.</span><span style="color: #24292F">type_annotation, </span><span style="color: #6E7781">/* ... */</span><span style="color: #24292F">);</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">let</span><span style="color: #24292F"> value </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">synthesise_expression</span><span style="color: #24292F">(variable_declaration</span><span style="color: #CF222E">.</span><span style="color: #24292F">expression, expected_type, </span><span style="color: #6E7781">/* ... */</span><span style="color: #24292F">);</span></span>
<span class="line"><span style="color: #6E7781">	// ...</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>We do this passing in several places</p>
<ul>
<li>Variable declarations pass their resolved annotation</li>
<li>Function arguments pass there respective parameter type</li>
<li>The resolved function return type annotation is stored in the environment and passed to the expression in <code>return</code> statements</li>
<li><code>satisfies</code> passes its RHS annotation to the LHS. (so technically not forwards. Another to add to my gripes on the <code>satisfies</code> operator üò©)</li>
<li>Class declarations with an <code>implements</code> clause (<code>extends</code> is contraversial)</li>
</ul>
<p>When we arrive at a function or method declaration <strong>and</strong> this type is a function, we pass the expected parameter types forward to <code>synthesise_function</code>. When synthesising parameters if we arrive at a parameter without an annotation, we can pick it from the expected parameter.</p>
<h4 id="forward-inference-on-properties-gives-unexpected-member-warnings-for-free" tabindex="-1">Forward inference on properties gives unexpected member warnings for free</h4>
<p>We do some transformation and passing in some cases. For example on object literals we get the property on the expected type</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">myobj</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> { </span><span style="color: #D2A8FF">mymethod</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">p</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// we evaluate `{ mymethod: (p: string) =&gt; string }["mymethod"]` to get the</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// expected type of `(p: string) =&gt; string`. The un-annoted parameter `p` </span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// therefore has a type of `string`</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">//       ‚Üì</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">mymethod</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">p</span><span style="color: #C9D1D9"> ) {</span></span>
<span class="line"><span style="color: #C9D1D9">		p </span><span style="color: #8B949E">// ‚Üê string</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">myobj</span><span style="color: #CF222E">:</span><span style="color: #24292F"> { </span><span style="color: #8250DF">mymethod</span><span style="color: #CF222E">:</span><span style="color: #24292F"> (</span><span style="color: #953800">p</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F"> } </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// we evaluate `{ mymethod: (p: string) =&gt; string }["mymethod"]` to get the</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// expected type of `(p: string) =&gt; string`. The un-annoted parameter `p` </span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// therefore has a type of `string`</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">//       ‚Üì</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">mymethod</span><span style="color: #24292F">(</span><span style="color: #953800">p</span><span style="color: #24292F"> ) {</span></span>
<span class="line"><span style="color: #24292F">		p </span><span style="color: #6E7781">// ‚Üê string</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>After adding the inference here, I had an an idea about <a href="https://github.com/kaleidawave/ezno/issues/42#issuecomment-2067326659">how to add in the comment on an issue</a>.</p>
<p>Thanks to the work of <a href="https://github.com/PatrickLaflamme">Patrick Laflamme</a> who implemented this in <a href="https://github.com/kaleidawave/ezno/pull/139">PR #139</a> we can raise an early error for excess properties.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> property </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> environment</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_property</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">	expected,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">Publicity</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Public</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9">key,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">...</span></span>
<span class="line"><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> property</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_none</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">	checking_data</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">diagnostics_container</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">add_warning</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">TypeCheckWarning</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ExcessProperty</span><span style="color: #C9D1D9"> { </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9"> })</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> property </span><span style="color: #CF222E">=</span><span style="color: #24292F"> environment</span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_property</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">	expected,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">Publicity</span><span style="color: #CF222E">::</span><span style="color: #953800">Public</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">key,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">...</span></span>
<span class="line"><span style="color: #24292F">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> property</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_none</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">	checking_data</span><span style="color: #CF222E">.</span><span style="color: #24292F">diagnostics_container</span><span style="color: #CF222E">.</span><span style="color: #8250DF">add_warning</span><span style="color: #24292F">(</span><span style="color: #953800">TypeCheckWarning</span><span style="color: #CF222E">::</span><span style="color: #953800">ExcessProperty</span><span style="color: #24292F"> { </span><span style="color: #CF222E">...</span><span style="color: #24292F"> })</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p><a href="https://github.com/PatrickLaflamme/ezno/blob/854f5e832b7729580a3180935241c656f8b3d31f/checker/src/synthesis/expressions.rs#L1061-L1088">Currently implementation here</a></p>
</blockquote>
<hr>
<p>There are several decisions we take for the expected type for different kinds of expressions.</p>
<ul>
<li>For assignments we use the constraint (variable or property type) on the LHS</li>
<li>For conditionals we pass the expected type to both branches</li>
<li>For object spreads we pass down the whole expected type</li>
</ul>
<blockquote>
<p>The last two <a href="https://kaleidawave.github.io/ezno/comparison/#excesspropertychecksthroughspreadandcondition">assist in catching excess-property cases that for an unknown reason TypeScript doesn't catch</a>.</p>
</blockquote>
<h4 id="complications" tabindex="-1">Complications</h4>
<p>One of the problems is around generics. Sometimes we might have a parameter that is based on generics.</p>
<p>For example <code>addEventListener</code>, the second function parameter is based of the first argument.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">EventMap</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #A5D6FF">"mousedown"</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">MouseEvent</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Node</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">addEventListener</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extends</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">EventMap</span><span style="color: #C9D1D9">&gt;(</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">, </span><span style="color: #D2A8FF">cb</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">ev</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">EventMap</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">void</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">EventMap</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #0A3069">"mousedown"</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">MouseEvent</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">Node</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">addEventListener</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">extends</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">EventMap</span><span style="color: #24292F">&gt;(</span><span style="color: #953800">name</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">, </span><span style="color: #8250DF">cb</span><span style="color: #CF222E">:</span><span style="color: #24292F"> (</span><span style="color: #953800">ev</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">EventMap</span><span style="color: #24292F">[</span><span style="color: #953800">T</span><span style="color: #24292F">]) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">void</span><span style="color: #24292F">);</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>We can do this by specialising generics left-to-right before the next parameter. This is <a href="https://github.com/kaleidawave/ezno/issues/236">and some more and currently unimplemented</a>.</p>
<p>One neat example I forgot I got working is computed generics! <a href="https://kaleidawave.github.io/ezno/playground/?id=9fm77k">Here</a> we get a union of the members, not just <code>number</code>. (more explanation in the future).</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">x</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">x.</span><span style="color: #D2A8FF">map</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">a</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> (a satisfies string, </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">)) </span><span style="color: #8B949E">// Expected string, found 1 | 2 | 3</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">x</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> [</span><span style="color: #0550AE">1</span><span style="color: #24292F">, </span><span style="color: #0550AE">2</span><span style="color: #24292F">, </span><span style="color: #0550AE">3</span><span style="color: #24292F">];</span></span>
<span class="line"><span style="color: #24292F">x.</span><span style="color: #8250DF">map</span><span style="color: #24292F">(</span><span style="color: #953800">a</span><span style="color: #24292F"> </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> (a satisfies string, </span><span style="color: #0550AE">2</span><span style="color: #24292F">)) </span><span style="color: #6E7781">// Expected string, found 1 | 2 | 3</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>However, there are cases where forward is not enough</p>
<h4 id="wrong-direction" tabindex="-1">Wrong direction</h4>
<p>One of the problems with this simple <em>forward pass</em> is when things are not forwards.</p>
<p>For example if we have functions of the form</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">func</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt;(</span><span style="color: #D2A8FF">cb</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">ev</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">EventKind</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">void</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">kind</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D2A8FF">func</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">ev</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {}, </span><span style="color: #A5D6FF">"mousedown"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">func</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt;(</span><span style="color: #8250DF">cb</span><span style="color: #CF222E">:</span><span style="color: #24292F"> (</span><span style="color: #953800">ev</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">EventKind</span><span style="color: #24292F">[</span><span style="color: #953800">T</span><span style="color: #24292F">]) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">void</span><span style="color: #24292F">, </span><span style="color: #953800">kind</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8250DF">func</span><span style="color: #24292F">((</span><span style="color: #953800">ev</span><span style="color: #24292F">) </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> {}, </span><span style="color: #0A3069">"mousedown"</span><span style="color: #24292F">)</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>We do not know the expected type of the first paramter, until we have looked at the second parameter.</p>
<p>Similarily if we write our function outside of the context of usage. Because forwards runs in the same direction as checking we cannot infer <code>ev</code> here until afterwards.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">doWhenMouseDown</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">ev</span><span style="color: #C9D1D9">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">document.</span><span style="color: #D2A8FF">addEventListener</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"mousedown"</span><span style="color: #C9D1D9">, doWhenMouseDown);</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">doWhenMouseDown</span><span style="color: #24292F">(</span><span style="color: #953800">ev</span><span style="color: #24292F">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">document.</span><span style="color: #8250DF">addEventListener</span><span style="color: #24292F">(</span><span style="color: #0A3069">"mousedown"</span><span style="color: #24292F">, doWhenMouseDown);</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>While the forward single pass has a ceiling, there are ways to performance inference above this.</p>
<h3 id="backward-inference" tabindex="-1">Backward inference</h3>
<p>This is the harder and still work-in-progress kind of inference. It is also something new, an interpolation inside of existing TypeScript.</p>
<p>Where forwards involves <strong>context</strong> on the written parameter, backwards involves <strong>usage</strong> of the reference to the parameter.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">sin</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">parameter</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">) { </span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// ...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">func</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">param</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">property</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> parameter.value; </span><span style="color: #8B949E">// require the `parameter` to have a property under key `value`</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">sin</span><span style="color: #C9D1D9">(property) </span><span style="color: #8B949E">// require `parameter.property` to have type `number`</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">sin</span><span style="color: #24292F">(</span><span style="color: #953800">parameter</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F">) { </span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// ...</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">func</span><span style="color: #24292F">(</span><span style="color: #953800">param</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">property</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> parameter.value; </span><span style="color: #6E7781">// require the `parameter` to have a property under key `value`</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">return</span><span style="color: #24292F"> </span><span style="color: #8250DF">sin</span><span style="color: #24292F">(property) </span><span style="color: #6E7781">// require `parameter.property` to have type `number`</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>This feature has been implemented before <a href="https://hegel.js.org/docs#benefits-and-disadvantages-over-typescript">in the Hegel type checker</a>.</p>
</blockquote>
<p>The idea here is that <strong>usage</strong> of the value adds requirements to the <em>constraint</em> of the parameter (or any of its descendents).</p>
<p>You can see attempt #2 <a href="https://github.com/kaleidawave/ezno/pull/197">working in a branch I started last year</a>.</p>
<blockquote>
<p>This is attempt #2 at the feature. Attempt <a href="https://kaleidawave.github.io/posts/introducing-ezno/#free-variables-(hidden-parameters)-of-functions">#1 was partially working 3 years ago</a>, but the implementation required mutating the parameter type during checking of the body, which caused all sort of problems. This new one pushes a sequence of requirement or constraints to the current context. At the end of checking the body, these requirements are collapsed into a final type.</p>
</blockquote>
<h4 id="steps-for-backward-inference-landing-in-0.1.0" tabindex="-1">Steps for backward inference landing in <code>0.1.0</code></h4>
<p>While three of the <a href="https://github.com/kaleidawave/ezno/pull/197/files#diff-8a0b8f92efee334818b42e62974af189aecb8ac866f988815040531489bb7062">fundamental tests are passing</a>, there is still a bit more to do to move this from a demonstration to something that could make writing real-world type-safe code easier.</p>
<p>The first is to collect more examples of <a href="https://github.com/kaleidawave/ezno/discussions/195">untyped code</a>, to see whether there are more cases to collect and implement.</p>
<p>One of those is the cases is free-variables. Ezno does not infer constraints for variable in standard flow (which is a whole other topic). But when a variable crosses a function boundary, there is some special handling under the title of <em>free-variables</em>.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> a </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">initialiseA</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">	a </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">data</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">doThing</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> a</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> a </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">null</span><span style="color: #24292F">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">initialiseA</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">	a </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">data</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">doThing</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> a</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here <code>doThing</code> requires <code>a</code> to be <code>string</code> (not <code>null</code>). Some assignment needs to happen before any calls to <code>doThing</code>.</p>
<p>The inference can treat find requirements for free variables (treating them the same as parameters), but currently attempt #2 checking for these constraints. Attempt #1 <a href="https://kaleidawave.github.io/posts/introducing-ezno/#free-variables-(hidden-parameters)-of-functions">did do this</a> but I have concerns about performing this eagerly...</p>
<p>Another is conditionals, this is something attempt #1 could not achieve because of the mutations. Here <code>item</code> should infer as <code>{ tag: "a", data: number } | { tag: "b", data: string }</code> rather than <code>{ tag: any, data: string &amp; number }</code>.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (item.tag </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"a"</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> a.data;</span></span>
<span class="line"><span style="color: #C9D1D9">} </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> (item.tag </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"b"</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">y</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> a.data;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (item.tag </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"a"</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> a.data;</span></span>
<span class="line"><span style="color: #24292F">} </span><span style="color: #CF222E">else</span><span style="color: #24292F"> (item.tag </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"b"</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">y</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> a.data;</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<h4 id="allowing-valid-javascript%2C-with-new-intrinsics" tabindex="-1">Allowing valid JavaScript, with new intrinsics</h4>
<p>One of the aims of this feature is to allow JavaScript code to be checked. Here we want to catch <strong>false-negatives</strong>, errors that occur at runtime but are uncaught by the checker. But we also have to consider this could introduce <strong>false-positives</strong>. For example <code>Math.sin("2.2")</code> is totally valid, the string "2.2" can be passed and we do not get an error (Infact it returns <code>0.808...</code> as the function performs an implict cast). In fact any value passed to the <code>Math.sin</code> is valid (unless its <code>toPrimitive</code> throws). In the following, one argument is a <code>number</code> <em>type</em> and another <em>is not</em>, yet we get identical output...</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #79C0FF">Math</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">sin</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #FF7B72">/</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) </span><span style="color: #8B949E">// NaN</span></span>
<span class="line"><span style="color: #79C0FF">Math</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">sin</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">class</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">X</span><span style="color: #C9D1D9"> {})) </span><span style="color: #8B949E">// (also) NaN</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #0550AE">Math</span><span style="color: #24292F">.</span><span style="color: #0550AE">sin</span><span style="color: #24292F">(</span><span style="color: #0550AE">1</span><span style="color: #CF222E">/</span><span style="color: #0550AE">0</span><span style="color: #24292F">) </span><span style="color: #6E7781">// NaN</span></span>
<span class="line"><span style="color: #0550AE">Math</span><span style="color: #24292F">.</span><span style="color: #0550AE">sin</span><span style="color: #24292F">(</span><span style="color: #CF222E">new</span><span style="color: #24292F"> (</span><span style="color: #CF222E">class</span><span style="color: #24292F"> </span><span style="color: #953800">X</span><span style="color: #24292F"> {})) </span><span style="color: #6E7781">// (also) NaN</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Currently the second call is outlawed by the rules TypeScript, which <em>technically</em> does not make a JavaScript superset...</p>
<p>In a previous post I outlined some <a href="/posts/experimental-types/">intrinsic types</a> I added to the checker. These are types different to the standard root, union, interesection, generic etc types in that they have specific behavior for a situation. Most of them narrow down on some type, such as <a href="/posts/experimental-types#multipleof"><code>MultipleOf</code></a> that only allows numbers that are of some multiple to be passed. Some like TSCs <code>NoInfer</code> controls behavior around inference.</p>
<p>So a solution we could invent here is a new intrinsic type called <code>Warn</code>. This could have a type and tag associated with it. When the checker see that the RHS of the subtype matches the first type argument we could allow it but also emit an error that it was matched.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">NumberLike</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Warn</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">"implicit cast"</span><span style="color: #C9D1D9">&gt;;</span></span>
<span class="line"><span style="color: #8B949E">//                         ^^^^</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Math</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">sin</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">NumberLike</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">declare</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Math</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Math</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">// Warning (not error): "2.2" is allowed but is a "implicit cast"</span></span>
<span class="line"><span style="color: #79C0FF">Math</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">sin</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"2.2"</span><span style="color: #C9D1D9">) </span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">NumberLike</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F"> </span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #953800">Warn</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">any</span><span style="color: #24292F">, </span><span style="color: #0A3069">"implicit cast"</span><span style="color: #24292F">&gt;;</span></span>
<span class="line"><span style="color: #6E7781">//                         ^^^^</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">Math</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">sin</span><span style="color: #24292F">(</span><span style="color: #953800">x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">NumberLike</span><span style="color: #24292F">)</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">declare</span><span style="color: #24292F"> </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">Math</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Math</span><span style="color: #24292F">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">// Warning (not error): "2.2" is allowed but is a "implicit cast"</span></span>
<span class="line"><span style="color: #0550AE">Math</span><span style="color: #24292F">.</span><span style="color: #0550AE">sin</span><span style="color: #24292F">(</span><span style="color: #0A3069">"2.2"</span><span style="color: #24292F">) </span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>Any suggestions: for the name, usage etc are welcome on <a href="https://github.com/kaleidawave/ezno/issues/235">this issue</a>.</p>
</blockquote>
<p>Then anything inferred from the argument passing would be valid as it currently <a href="https://github.com/kaleidawave/ezno/blob/d4142fe9471e688e2c03b228d6ecb7b8fde1b236/checker/specification/staging.md#from-argument">can create a false posiitive</a>.</p>
<h3 id="wrapping-up" tabindex="-1">Wrapping up</h3>
<p>There are still somethings to say about what backward inference can solve, but I will cut it here on the ideas and share them once it works.</p>
<p>You can read about <a href="/posts/specification-speed-schedule/#schedule">when the next release will be in the previous blog post</a>.</p>
<p>If you want to see more of this kind of thing you can follow me on <a href="https://x.com/kaleidawave">x</a>, <a href="https://bsky.app/profile/kaleidawave.bsky.social">bluesky</a> and <a href="https://github.com/sponsors/kaleidawave">join the existing great sponsors of the project!</a>.</p>

</div>

<div class="discussions">
    <script src="https://giscus.app/client.js" data-repo="kaleidawave/discussions" data-repo-id="R_kgDOIy08KA" data-category="Comments" data-category-id="DIC_kwDOIy08KM4CTpn8" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async="">
            </script>
</div>

<script defer="">
    for (const video of document.querySelectorAll("video")) {
        video.addEventListener("mouseover", (ev) => {
            ev.target.play();
        })
    }
</script>

        </div>
        
    </main>
    <footer>
        <div class="width-box">
            <form>
                <label for="toggle-theme">Light Mode</label>
                <input type="checkbox" name="toggle-theme" id="toggle-theme">
            </form>
            <nav>
                <ul>
                    <li>
                        <a href="https://bsky.app/profile/kaleidawave.bsky.social">Bluesky <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/kaleidawave">Twitter <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://github.com/kaleidawave">GitHub <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a>
                    </li>
                    <li>
                        Built with <a href="https://www.11ty.dev/"><svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3.398 12V0h17.204v24H3.398zm13.17 6.07a1.07 1.07 0 00.373-.107c.432-.213.68-.672.877-1.626.076-.372 1.195-6.168 1.209-6.263.026-.186-.008-.382-.084-.476a.325.325 0 00-.087-.064l-.06-.031h-.291c-.253 0-.298 0-.348.02-.113.039-.207.156-.255.316-.011.038-.168.881-.348 1.873l-.328 1.802-.046-.21c-.56-2.547-.764-3.452-.794-3.532a.383.383 0 00-.103-.16c-.105-.107-.117-.11-.567-.11-.411 0-.422 0-.5.074-.086.079-.122.216-.111.42.006.115.045.27.688 2.784.663 2.587.751 2.943.787 3.177.046.3-.05.713-.208.893-.032.037-.037.039-.084.032-.028 0-.12-.027-.204-.051-.268-.078-.362-.072-.462.028-.096.096-.137.248-.138.51 0 .256.028.34.159.473.131.133.324.208.595.23.164.012.22.012.33-.001zm-1.896-1.712a.31.31 0 00.16-.192c.02-.058.022-.098.022-.356 0-.255-.003-.299-.021-.354-.04-.121-.136-.196-.278-.217-.041-.01-.2-.01-.355-.01-.365-.001-.378-.01-.446-.184-.068-.18-.096-.326-.113-.602a85.799 85.799 0 01-.012-1.94v-1.765h.35c.454 0 .507-.01.602-.113a.465.465 0 00.102-.24 3.273 3.273 0 000-.534c-.026-.16-.099-.271-.211-.322-.057-.025-.065-.026-.45-.03h-.392l-.003-1.22c-.003-1.09-.005-1.227-.021-1.278a.378.378 0 00-.201-.247c-.052-.024-.072-.025-.32-.029-.27 0-.356 0-.429.038-.087.042-.148.133-.185.278-.014.054-.032.346-.076 1.262l-.06 1.194s-.08 0-.18.01c-.206.01-.263.022-.327.086-.092.092-.12.19-.127.455-.01.334.02.487.115.588.075.081.134.1.345.106l.173.01v1.785c0 1.7.006 2.019.034 2.274.041.37.13.709.241.928.194.38.544.617.988.668h1.005l.07-.04zm-7.447 0c.098-.053.16-.154.2-.332.016-.077.018-.401.018-4.518 0-4.184-.001-4.44-.02-4.51-.05-.194-.19-.29-.378-.26-.035.01-.344.084-.686.175-.343.09-.684.18-.758.198-.17.043-.214.062-.281.126-.105.098-.122.185-.122.606 0 .416.016.5.12.604.094.095.189.1.456.03.103-.026.193-.048.2-.048.01 0 .014.784.017 3.763.003 3.436.005 3.77.021 3.84.048.202.113.296.236.34.034.013.133.016.487.014.435 0 .445 0 .49-.027zm3.203 0c.092-.046.152-.135.197-.29l.024-.084.003-4.435c.002-3.194 0-4.456-.01-4.509-.033-.2-.145-.308-.322-.308-.066 0-.198.03-.857.204-.56.147-.799.214-.849.239a.34.34 0 00-.17.184c-.024.06-.024.071-.024.479 0 .415 0 .417.026.483a.362.362 0 00.083.12c.1.1.172.105.456.034a5.46 5.46 0 01.208-.05c.008 0 .012 1.202.014 3.791l.003 3.79.026.086a.48.48 0 00.135.23c.078.062.085.063.57.06.414 0 .447 0 .487-.024z"></path></svg> Eleventy</a> and
                        <a href="/architecture">others</a>
                    </li>
                </ul>
            </nav>
        </div>
    </footer>
    <script>
        if (localStorage.getItem("theme") === null) {
    changeScheme();
} else {
    updateThemeClass();
}

function changeScheme(darkTheme = null) {
    if (darkTheme === null) {
        if ("matchMedia" in window) {
            darkTheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
        } else {
            darkTheme = false;
        }
    }
    localStorage.setItem("theme", darkTheme ? "dark" : "light");
    updateThemeClass();
}

function updateThemeClass(value = null) {
    if (value === null) {
        value = localStorage.getItem("theme") === "dark";
    }
    if (value) {
        document.documentElement.classList.add("dark");
    } else {
        document.documentElement.classList.remove("dark");
    }
}

{
    const themeSwitch = document.querySelector("#toggle-theme");
    themeSwitch.checked = localStorage.getItem("theme") !== "dark";
    themeSwitch.addEventListener("change", (ev) => {
        const darkTheme = !ev.target.checked;
        changeScheme(darkTheme);
    });
}

// Clicking on headers stores their reference
document.addEventListener("click", (ev) => {
    if (ev.target.matches(".post > *:is(h2, h3, h4, h5)")) {
        const id = ev.target.getAttribute("id");
        if (id !== null) {
            location.href = '#' + id;
        }
    }
});

const titleBar = document.querySelector("header .icon-title")

titleBar.querySelector("img").addEventListener("dragend", () => {
    const r = document.createElement("video");
    const s = document.createElement("source");
    s.src = "/media/boom.webm";
    r.append(s);
    r.controls = false;
    titleBar.appendChild(r);
    r.addEventListener("ended", () => {
        titleBar.querySelector(".header-title").innerText = "Bengineering";
        r.style.display = "none";
    });
    r.play();

})

// TODO temp hack for highlighted rows in code blocks
for (const element of document.querySelectorAll("[data-highlight]")) {
    const indexes = element.getAttribute("data-highlight").split(",").map(a => parseInt(a));
    for (const pres of element.children[0].children) {
        // TODO adjacent indices don't style well, could do something here
        for (const index of indexes) {
            const line = pres.children[0].children[index];
            const firstChild = line.children[0];
            const newContent = firstChild.textContent.trimLeft();
            const indent = firstChild.textContent.length - newContent.length;
            firstChild.childNodes[0].data = newContent;
            line.style.marginLeft = indent + 'ch';
            line.classList.add("highlight");
        }
    }
}

    </script>


</body></html>