<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="google-site-verification" content="pi8qBei6qHxHyGxm9Eh4WDhPwxU672uIJmfdIqcgIGs">
    <meta name="referrer" content="no-referrer-when-downgrade">

    
    <!-- Cloudflare Web Analytics -->
    <script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;9a3f0b71c0ea4b3d99621e1b084c24cd&quot;}"></script>
    <!-- End Cloudflare Web Analytics -->
    

    <title>Hacker News Clone with Prism &amp; Rust</title>

    <meta name="title" content="Hacker News Clone with Prism &amp; Rust">
    <meta property="og:title" content="Hacker News Clone with Prism &amp; Rust">
    <meta property="twitter:title" content="Hacker News Clone with Prism &amp; Rust">

    <meta name="description" content="Building a universally rendered Hacker News Clone using Prism, Rust and Actix-Web">
    <meta property="og:description" content="Building a universally rendered Hacker News Clone using Prism, Rust and Actix-Web">
    <meta property="twitter:description" content="Building a universally rendered Hacker News Clone using Prism, Rust and Actix-Web">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kaleidawave.github.io/">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kaleidawave.github.io/">

    
    <meta property="twitter:image" content="https://kaleidawave.github.io/media/banners/hackernews-clone.png">
    <meta property="og:image" content="https://kaleidawave.github.io/media/banners/hackernews-clone.png">
    

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link rel="preconnect" href="https://fonts.gstatic.com"><link data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap" rel="stylesheet"><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap">/* vietnamese */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW86Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW87Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW81Rb0JcBao.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZJhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZthjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* greek-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZNhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+1F00-1FFF;
}
/* greek */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZxhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
/* vietnamese */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZBhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZFhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl618BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6R8BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* vietnamese */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl698BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl658BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6B8BtxaV4jcFw.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style>

    <style>:root {
    font-family: "SF Pro Display", "SF Pro Icons", "Inter", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
    font-weight: 400;

    --text-color: #1a1a1a;
    --border: var(--text-color);
    --background: #F2F0EB;
    --muted-background: #f9f5f8;
    --muted-background-opaque: #e4e0da80;
    --accent: #bc3b3b;
    --muted-accent: #993b33;
    --code-highlight: #e2ccb7;
}

@media screen {
    :root.dark {
        --text-color: #dbdbdb;
        --background: #0f0f10;
        --muted-background: #1f1f23;
        --muted-background-opaque: #1f1f2380;
        --accent: #a8ff8e;
        --muted-accent: #81b47c;
        --code-highlight: #549463;
    }
}

:root.dark .shiki-light {
    display: none;
}

:root:not(.dark) .shiki-dark {
    display: none;
}

html,
body {
    margin: 0;
    padding: 0;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    font-size: 16px;
}

body {
    background-color: var(--background, white);
    color: var(--text-color, black);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

header {
    background-color: var(--muted-background-opaque, white);
    display: flex;
    justify-content: space-around;
    align-items: center;
    font-size: 16px;
    padding: 14px;
}

:root:not(.dark) header {
    border-bottom: 2px solid var(--border);
}

header>div {
    width: 100% !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

header video {
    position: absolute;
}

header h1 {
    font-weight: 100;
    font-size: 20px;
    color: var(--text-color);
}

header h1>a {
    color: var(--text-color) !important;
}

header .icon-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

header img {
    position: relative;
    top: -4px;
    height: 26px;
    width: auto;
}

@media print {
    header nav {
        display: none;
    }

    footer {
        display: none;
    }
}

header nav>ul {
    padding-left: 0;
    display: flex;
    list-style: none;
}

header nav>ul>li {
    margin-left: 10px;
    text-transform: lowercase;
}

h1,
h2,
h3,
h4,
h5 {
    font-family: "Be Vietnam Pro", sans-serif;
    font-weight: 600;
    scroll-margin: 100px;
}

*::selection {
    background: var(--muted-accent);
    color: var(--background);
}

em {
    position: relative;
    left: -2px;
}

ul,
ol {
    margin: 0px;
    padding-left: 20px;
}

hr {
    width: 100%;
    margin: 30px auto;
    border: none;
    border-top: 1px solid var(--text-color);
}

main {
    margin: 20px 0 80px;
}

.width-box {
    width: 95%;
    margin: 0 auto;
}

svg.icon {
    height: 10pt;
    fill: var(--muted-accent);
    position: relative;
    top: 2px;
}

a {
    color: var(--accent, white);
    text-decoration: none;
}

a:visited {
    color: var(--muted-accent, white);
}

pre code {
    white-space: break-spaces !important;
    overflow-x: hidden;
    tab-size: 4;
}

/* Shrink inline code a little bit */
:is(div, p, a, li)>code {
    font-size: 90%;
}

pre,
code {
    background-color: var(--muted-background) !important;
    font-family: 'JetBrains Mono', 'Fira Code light', consolas, monospace;
    font-size: 14px;
}

footer {
    margin-top: auto;
    background-color: var(--muted-background-opaque, white);
    padding: 22px;
}

:root:not(.dark) footer {
    border-top: 2px solid var(--border);
}

footer>div {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

footer h3 {
    margin: 0;
    font-weight: inherit;
    font-size: 16px;
}

footer nav ul {
    list-style: none;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

footer nav ul>li:not(:first-child) {
    border-left: 2px solid var(--muted-accent);
    padding-left: 6px;
}

footer>div>*:nth-child(2n) {
    margin-left: auto;
    font-size: 10pt;
}

@media screen and (max-width: 480px) {
    header>div {
        flex-direction: column;
    }

    body {
        width: 100vw;
        box-sizing: border-box;
    }

    .posts>ul>li img {
        width: 100%;
        height: auto;
    }
}

@media screen and (min-width: 480px) {
    @supports (backdrop-filter: blur(20px)) {
        header {
            backdrop-filter: blur(20px);
        }
    }

    header {
        position: sticky;
        top: 0;
        right: 0;
        left: 0;
        z-index: 100;
    }

    .width-box {
        width: 100%;
        max-width: min(80vw, 840px);
    }
}</style>
    <link rel="alternate" type="application/rss+xml" href="/feed.xml">
</head>

<body>
    <header>
        <div class="width-box">
            <a class="icon-title" href="/">
                <h1 class="header-title">Ben's Engineering Blog</h1>
                <img draggable="true" src="/media/icon.png" width="256" height="256" alt="">
                
            </a>
            <nav>
                <ul>
                    <li><a href="/posts">Posts</a></li>
                    <li><a href="/about">About</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main>
        
        <div class="width-box">
            <style>.post {
    display: flex;
    flex-direction: column;
}

.post>p,
.post li,
.post blockquote {
    line-height: 1.6em;
    margin: 6px 0;
    font-weight: inherit;
    font-family: "Inter", "Helvetica", sans-serif;
}

.post>*:is(h1, h2, h3, h4, h5) {
    margin: 12pt 0;
}

.post img,
.post video,
.post pre:not(.shiki) {
    margin: 20px 0;
}

.post pre.shiki {
    margin: 0;
}

/* Dark mode by default */
:root:not(.dark) .post img.invertible,
:root:not(.dark) .post video.invertible {
    filter: invert(1);
}

.post img {
    border-radius: 10px;
}

.post svg.icon {
    height: 1em;
    fill: var(--text-color);
}

.post span.line.highlight {
    font-weight: bold;
    background-color: var(--code-highlight);
    outline: 4px var(--code-highlight) solid;
}

.post .shiki-container {
    padding: 20px;
}

.post .math {
    margin: auto;
}

.post .math>svg {
    width: auto;
    height: 200%;
    margin: 10px;
}

.post .quote {
    font-style: italic;
}

.post .quote::before {
    content: '"';
}

.post .quote::after {
    content: '"';
}

.post *[role="caption"] {
    font-size: 14px;
    margin: 6px 0 20px;
    padding: 6px;
    text-align: center;
    font-weight: normal;
    opacity: 0.8;
}

.post time {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 11pt;
    font-family: monospace;
}

.post .center {
    text-align: center;
    font-weight: inherit;
    padding: 30px;
}

.post .note {
    font-style: italic;
    font-size: 12pt;
    opacity: 0.8;
}

*:is(h1, h2, h3, h4, h5, h6)>code {
    font-size: 0.8em;
}

*:is(h1, h2, h3, h4, h5, h6, p, li)>code {
    padding: 2px 6px;
}

/* For footnotes */
.post a[href^="#foot"] {
    font-family: monospace;
    position: relative;
    top: -5px;
    left: 2px;
}

.post #footnotes~* {
    font-size: 14px;
    margin: 4px 0;
    width: 100%;
}

video.small {
    max-height: 300px !important;
}

.callout {
    margin-top: 18px;
    padding: 20px;
    font-size: 15pt;
    background-color: var(--muted-background);
    border-radius: 16px;
    border: 3px solid var(--muted-accent);
}

.post h1.title {
    font-size: 40px;
}

.post h1 {
    font-size: 32px;
}

.post h2 {
    font-size: 28px;
}

.post h3 {
    font-size: 24px;
}

.post h4 {
    font-size: 20px;
}

.post h5 {
    font-size: 16px;
}

.post a.media-container>img {
    width: 100%;
}

.post table {
    border-spacing: 0;
    border-collapse: collapse;
    margin: 40px 0;
    /* max-width: 100%;
    overflow: scroll; */
}

.post table td,
.post table th {
    border: 2px solid var(--text-color);
    padding: 6px 8px;
    text-align: left;
}

.post blockquote {
    border-left: 4px solid var(--muted-accent);
    margin: 10px 0;
    padding: 5px 10px;
    background: var(--muted-background-opaque);
}

.post blockquote>p {
    margin: 0;
}

.post .widget {
    background: white;
    border-radius: 6px;
    padding: 50px;
    margin: 40px 0;
}

.discussions {
    margin: 80px 0px;
}

.parralel pre:not(.shiki) {
    font-size: 12px;
}

@media screen and (max-width: 480px) {
    .center {
        text-align: center;
        font-weight: inherit;
        padding: 10px 0px;
    }

    .post>p,
    .post li {
        font-size: 12pt;
        line-height: 1.4em;
    }

    .post img,
    .post pre,
    .post table,
    .post .widget,
    .post video {
        width: 100%;
        height: auto;
    }

    .post pre {
        overflow-x: auto;
    }
}

@media screen and (min-width: 480px) {
    .post>.parralel {
        display: flex;
        gap: 30px;
    }

    .post>.parralel>div {
        flex-grow: 1;
    }

    .post img,
    .post video,
    .post pre:not(.shiki) {
        align-self: center;
        height: auto;
    }

    .post>img,
    .post>video,
    .post table,
    .post .widget,
    .post>a.media-container,
    .post>.parralel,
    .post>pre:not(.shiki) {
        width: 105%;
        align-self: center;
    }
}

@media print {
    .post video {
        display: none;
    }
}</style>

<div class="post">
    <h1 class="title">Hacker News Clone with Prism &amp; Rust</h1>
    
    <time datetime="2020-11-10">
        Published on Tuesday 10<sup>th</sup> November 2020
        
    </time>
    
    <p>Last week I recreated the <a href="https://news.ycombinator.com/news">Hacker News site</a>. It is built as an isomorphic site with a Prism compiled frontend and a Rust backend. In this post, I will illustrate some of the benefits that using <a href="https://github.com/kaleidawave/prism">Prism compiler</a> has on this site.</p>
<h3 id="rust" tabindex="-1">Isomorphic sites with a Rust backend</h3>
<p>Currently, most sites are client-side rendered apps built with a framework. client-side frameworks make development easier by using a more declarative programming style. Using the client runtime can add more reactive interactions without going back to the network. client-side frameworks make SPA's easier to develop.</p>
<p>However, a pure client-side site lacks fast start-up times. Before any content is added to the DOM JavaScript must be downloaded, parsed and executed. This relies on the network speed and speed of the client device. There is also the problem that if this process fails then you end up with a white page without any content. Another problem is that each request returns the same empty HTML so there are problems with search engine indexing and link metadata previews between different pages if the bots don't evaluate the JS.</p>
<p>Client-side rendering is acceptable for mostly interactive sites (e.g. <a href="https://www.figma.com/">Figma</a>) but does not suit more contentful sites where content is more important than reactivity.</p>
<p>So instead of a server do server-side rendering (SSR) to generate the initial page. SSR fixes the above problems as there is no reliance on the client runtime for generating content. SSR responses contain relevant non-unique markup so search engine indexers and link metadata bots can work without them running JS.</p>
<p>This is true for the <a href="https://news.ycombinator.com/news">Hacker News site</a> that renders pages on the server, which is a good architecture as reading posts and comments is more important than interactions.</p>
<p>Server-side rendering client-side code is already being down within frameworks. <a href="https://www.npmjs.com/package/react-dom">react-server/dom</a> has <code>renderToString</code>, and <a href="https://svelte.dev/docs#Server-side_component_API">Svelte components have a similar method</a>. Then there are isomorphic frameworks like <a href="https://github.com/vercel/next.js">Nextjs</a> and <a href="https://github.com/sveltejs/sapper">sapper</a> which tie this all in together.</p>
<h3 class="center"><p>However the above methods require a JavaScript runtime</p>
</h3>
<p>So in my own framework, I experimented with the feature to compile views to Rust functions. All <code>.prism</code> components are compiled to native Rust string concatenation functions. This has many benefits:</p>
<ul>
<li>Single source, no need to rewrite for different server languages</li>
<li>Changes to <code>.prism</code> components are reflected and kept inline with the Rust methods</li>
<li>client-side markup and server-side markup are kept in sync preventing issues when making components interactive</li>
</ul>
<p>It also compiles across the <code>interface</code> definitions to Rust's <code>struct</code> definitions, which retains the strong type safety. The Rust compiler will pick up any other issues with the outputted Rust functions. This is a step above <a href="https://handlebarsjs.com/">handlebars</a> where type errors are left to runtime.</p>
<p>It is not as complete as Nextjs which builds the whole backend for you. Prism only builds out functions which then must be connected up. But I prefer this design as getting data on the server and the client is very different (not for this example but for applications where you have full control over the stack). Prism is not a full-stack framework as while it exposes the render methods in Rust modules, it doesn't generate the routing needed in Rust.</p>
<p>Prism hackernews uses actix-web under the hood which is in the <a href="https://www.techempower.com/benchmarks/#section=data-r19">top 5 fastest backend frameworks in the tech empower benchmarks</a>, of that list raw NodeJS server places 152nd. According to the benchmark it makes actix-web 7x faster than a raw NodeJS server.</p>
<p>For this example it doesn't really make much of a difference as the biggest time here is making HTTP requests to the <a href="https://github.com/HackerNews/API">HN API</a>. A single request to the homepage takes 11 http requests with a lot of them being chained.</p>
<p>Aside from the speed improvements it also means that if you have written your REST API in Rust then you can add SSR to your site reusing the same server and logic rather than having to rewrite server-side data fetching in a new NodeJS server.</p>
<p>It is already possible to server render SPAs in other languages:</p>
<ul>
<li>Through calling directly to v8 API. However, this has a bit of overhead and isn't as fast as compiling to native. It loses strong typing and can be complex to integrate.</li>
<li>Rewriting the client view code in a templating engine supported in the language. As well as taking a lot of work initially, it is difficult to maintain the client code with changes to the server-side templates. Mismatches can lead to issues when the frontend logic gets a different response than what the client-side was expecting.</li>
</ul>
<h3 id="jit-hydration" tabindex="-1">JIT hydration</h3>
<p>When building isomorphic sites it often makes the frontend more confusing. Now the frontend it is not the start of the world and there is existing markup. The biggest issue from this is recreating the state that was on the server now on the front-end. With both server and client-rendered DOM the view is the same but the JS state is not there on server responses. Getting the state in JS by doing a data fetch is not good as it may be out of sync with the server content. So the approach used by most SSR frameworks is to send down a JSON or JS blob in a script tag that contains the JS object used to generate the markup response.</p>
<p>This is a common practice and can be seen on nytimes where (at the time of this being written) ~75% of the home page response is the state loaded into the <code>window.__preloadedData</code> variable:</p>
<img src="../../media/demos/new_york_times_preload_data.png" alt="lots of JSON">
<p>There are a few issues with this approach:</p>
<ul>
<li>Some of the object is not used. Some implementations use <code>Proxy</code>s to identify unused "leaves" but this is complex and expensive to do.</li>
<li>Most of the data is already sent down in the markup.</li>
<li>JSON cannot represent types other than <code>string</code>, <code>number</code>, <code>boolean</code>, <code>object</code> and <code>Array</code>. No <code>Date</code> :(</li>
</ul>
<p>Prism's approach ditches any sort of JSON or JS blob and the server response only sends markup:</p>
<pre><code class="language-html"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">&lt;!</span><span style="color: #7EE787">DOCTYPE</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">html</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">&lt;</span><span style="color: #7EE787">html</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">lang</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"en"</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    &lt;</span><span style="color: #7EE787">head</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">        &lt;</span><span style="color: #7EE787">script</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">type</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"module"</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">src</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"/bundle.1w99.js"</span><span style="color: #C9D1D9">&gt;&lt;/</span><span style="color: #7EE787">script</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">        &lt;</span><span style="color: #7EE787">link</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">rel</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"stylesheet"</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">href</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"/bundle.lxt.css"</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">        &lt;</span><span style="color: #7EE787">title</span><span style="color: #C9D1D9">&gt;Hacker News&lt;/</span><span style="color: #7EE787">title</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">        &lt;</span><span style="color: #7EE787">meta</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">name</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"description"</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">content</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"Prism &amp; Rust based HN clone"</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">        ...</span></span>
<span class="line"><span style="color: #C9D1D9">    &lt;/</span><span style="color: #7EE787">head</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    &lt;</span><span style="color: #7EE787">body</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">        &lt;</span><span style="color: #7EE787">router-component</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">            &lt;</span><span style="color: #7EE787">main-layout</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">data-ssr</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                &lt;</span><span style="color: #7EE787">header</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                    ...</span></span>
<span class="line"><span style="color: #C9D1D9">                &lt;/</span><span style="color: #7EE787">header</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                &lt;</span><span style="color: #7EE787">main</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"p900"</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                    &lt;</span><span style="color: #7EE787">index-page</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">data-ssr</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                        &lt;</span><span style="color: #7EE787">ol</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"pwf4"</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                        &lt;</span><span style="color: #7EE787">li</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                            &lt;</span><span style="color: #7EE787">story-preview</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">data-ssr</span><span style="color: #C9D1D9"> &gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                &lt;</span><span style="color: #7EE787">div</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"buttons"</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                    &lt;</span><span style="color: #7EE787">button</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"p1lb2"</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">disabled</span><span style="color: #C9D1D9">&gt;</span><span style="color: #79C0FF">&amp;#9650;</span><span style="color: #C9D1D9">&lt;/</span><span style="color: #7EE787">button</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                    &lt;</span><span style="color: #7EE787">button</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"plwi"</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">disabled</span><span style="color: #C9D1D9">&gt;</span><span style="color: #79C0FF">&amp;#9660;</span><span style="color: #C9D1D9">&lt;/</span><span style="color: #7EE787">button</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                &lt;/</span><span style="color: #7EE787">div</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                &lt;</span><span style="color: #7EE787">div</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                    &lt;</span><span style="color: #7EE787">h2</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"pavi"</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                        &lt;</span><span style="color: #7EE787">a</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">...</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"p1kxi"</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">href</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"..."</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                            Fire declared in OVH SBG2 datacentre building</span></span>
<span class="line"><span style="color: #C9D1D9">                                        &lt;/</span><span style="color: #7EE787">a</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                    &lt;/</span><span style="color: #7EE787">h2</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                    &lt;</span><span style="color: #7EE787">span</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                        &lt;</span><span style="color: #7EE787">span</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"pxwh"</span><span style="color: #C9D1D9">&gt;660</span><span style="color: #8B949E">&lt;!----&gt;</span><span style="color: #C9D1D9"> points | by&lt;/</span><span style="color: #7EE787">span</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                        &lt;</span><span style="color: #7EE787">a</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"p1ztd"</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">href</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"..."</span><span style="color: #C9D1D9">&gt; </span></span>
<span class="line"><span style="color: #C9D1D9">                                            </span><span style="color: #8B949E">&lt;!----&gt;</span><span style="color: #C9D1D9">finniananderson</span><span style="color: #8B949E">&lt;!----&gt;</span><span style="color: #C9D1D9"> | </span></span>
<span class="line"><span style="color: #C9D1D9">                                        &lt;/</span><span style="color: #7EE787">a</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                        &lt;</span><span style="color: #7EE787">a</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"pos3"</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">href</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"..."</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                            304</span><span style="color: #8B949E">&lt;!----&gt;</span><span style="color: #C9D1D9"> comments</span></span>
<span class="line"><span style="color: #C9D1D9">                                        &lt;/</span><span style="color: #7EE787">a</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                    &lt;/</span><span style="color: #7EE787">span</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                                &lt;/</span><span style="color: #7EE787">div</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                            &lt;/</span><span style="color: #7EE787">story-preview</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                        &lt;/</span><span style="color: #7EE787">li</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                        ...</span></span>
<span class="line"><span style="color: #C9D1D9">                        &lt;/</span><span style="color: #7EE787">ol</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                    &lt;/</span><span style="color: #7EE787">index-page</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                &lt;/</span><span style="color: #7EE787">main</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                &lt;</span><span style="color: #7EE787">footer</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">                    ...</span></span>
<span class="line"><span style="color: #C9D1D9">                &lt;/</span><span style="color: #7EE787">footer</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">            &lt;/</span><span style="color: #7EE787">main-layout</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">        &lt;/</span><span style="color: #7EE787">router-component</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    &lt;/</span><span style="color: #7EE787">body</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">&lt;/</span><span style="color: #7EE787">html</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">&lt;!</span><span style="color: #116329">DOCTYPE</span><span style="color: #24292F"> </span><span style="color: #0550AE">html</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">&lt;</span><span style="color: #116329">html</span><span style="color: #24292F"> </span><span style="color: #0550AE">lang</span><span style="color: #24292F">=</span><span style="color: #0A3069">"en"</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    &lt;</span><span style="color: #116329">head</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">        &lt;</span><span style="color: #116329">script</span><span style="color: #24292F"> </span><span style="color: #0550AE">type</span><span style="color: #24292F">=</span><span style="color: #0A3069">"module"</span><span style="color: #24292F"> </span><span style="color: #0550AE">src</span><span style="color: #24292F">=</span><span style="color: #0A3069">"/bundle.1w99.js"</span><span style="color: #24292F">&gt;&lt;/</span><span style="color: #116329">script</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">        &lt;</span><span style="color: #116329">link</span><span style="color: #24292F"> </span><span style="color: #0550AE">rel</span><span style="color: #24292F">=</span><span style="color: #0A3069">"stylesheet"</span><span style="color: #24292F"> </span><span style="color: #0550AE">href</span><span style="color: #24292F">=</span><span style="color: #0A3069">"/bundle.lxt.css"</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">        &lt;</span><span style="color: #116329">title</span><span style="color: #24292F">&gt;Hacker News&lt;/</span><span style="color: #116329">title</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">        &lt;</span><span style="color: #116329">meta</span><span style="color: #24292F"> </span><span style="color: #0550AE">name</span><span style="color: #24292F">=</span><span style="color: #0A3069">"description"</span><span style="color: #24292F"> </span><span style="color: #0550AE">content</span><span style="color: #24292F">=</span><span style="color: #0A3069">"Prism &amp; Rust based HN clone"</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">        ...</span></span>
<span class="line"><span style="color: #24292F">    &lt;/</span><span style="color: #116329">head</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    &lt;</span><span style="color: #116329">body</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">        &lt;</span><span style="color: #116329">router-component</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">            &lt;</span><span style="color: #116329">main-layout</span><span style="color: #24292F"> </span><span style="color: #0550AE">data-ssr</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                &lt;</span><span style="color: #116329">header</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                    ...</span></span>
<span class="line"><span style="color: #24292F">                &lt;/</span><span style="color: #116329">header</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                &lt;</span><span style="color: #116329">main</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"p900"</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                    &lt;</span><span style="color: #116329">index-page</span><span style="color: #24292F"> </span><span style="color: #0550AE">data-ssr</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                        &lt;</span><span style="color: #116329">ol</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"pwf4"</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                        &lt;</span><span style="color: #116329">li</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                            &lt;</span><span style="color: #116329">story-preview</span><span style="color: #24292F"> </span><span style="color: #0550AE">data-ssr</span><span style="color: #24292F"> &gt;</span></span>
<span class="line"><span style="color: #24292F">                                &lt;</span><span style="color: #116329">div</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"buttons"</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                    &lt;</span><span style="color: #116329">button</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"p1lb2"</span><span style="color: #24292F"> </span><span style="color: #0550AE">disabled</span><span style="color: #24292F">&gt;</span><span style="color: #0550AE">&amp;#9650;</span><span style="color: #24292F">&lt;/</span><span style="color: #116329">button</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                    &lt;</span><span style="color: #116329">button</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"plwi"</span><span style="color: #24292F"> </span><span style="color: #0550AE">disabled</span><span style="color: #24292F">&gt;</span><span style="color: #0550AE">&amp;#9660;</span><span style="color: #24292F">&lt;/</span><span style="color: #116329">button</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                &lt;/</span><span style="color: #116329">div</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                &lt;</span><span style="color: #116329">div</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                    &lt;</span><span style="color: #116329">h2</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"pavi"</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                        &lt;</span><span style="color: #116329">a</span><span style="color: #24292F"> </span><span style="color: #0550AE">...</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"p1kxi"</span><span style="color: #24292F"> </span><span style="color: #0550AE">href</span><span style="color: #24292F">=</span><span style="color: #0A3069">"..."</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                            Fire declared in OVH SBG2 datacentre building</span></span>
<span class="line"><span style="color: #24292F">                                        &lt;/</span><span style="color: #116329">a</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                    &lt;/</span><span style="color: #116329">h2</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                    &lt;</span><span style="color: #116329">span</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                        &lt;</span><span style="color: #116329">span</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"pxwh"</span><span style="color: #24292F">&gt;660</span><span style="color: #6E7781">&lt;!----&gt;</span><span style="color: #24292F"> points | by&lt;/</span><span style="color: #116329">span</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                        &lt;</span><span style="color: #116329">a</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"p1ztd"</span><span style="color: #24292F"> </span><span style="color: #0550AE">href</span><span style="color: #24292F">=</span><span style="color: #0A3069">"..."</span><span style="color: #24292F">&gt; </span></span>
<span class="line"><span style="color: #24292F">                                            </span><span style="color: #6E7781">&lt;!----&gt;</span><span style="color: #24292F">finniananderson</span><span style="color: #6E7781">&lt;!----&gt;</span><span style="color: #24292F"> | </span></span>
<span class="line"><span style="color: #24292F">                                        &lt;/</span><span style="color: #116329">a</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                        &lt;</span><span style="color: #116329">a</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"pos3"</span><span style="color: #24292F"> </span><span style="color: #0550AE">href</span><span style="color: #24292F">=</span><span style="color: #0A3069">"..."</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                            304</span><span style="color: #6E7781">&lt;!----&gt;</span><span style="color: #24292F"> comments</span></span>
<span class="line"><span style="color: #24292F">                                        &lt;/</span><span style="color: #116329">a</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                    &lt;/</span><span style="color: #116329">span</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                                &lt;/</span><span style="color: #116329">div</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                            &lt;/</span><span style="color: #116329">story-preview</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                        &lt;/</span><span style="color: #116329">li</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                        ...</span></span>
<span class="line"><span style="color: #24292F">                        &lt;/</span><span style="color: #116329">ol</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                    &lt;/</span><span style="color: #116329">index-page</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                &lt;/</span><span style="color: #116329">main</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                &lt;</span><span style="color: #116329">footer</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">                    ...</span></span>
<span class="line"><span style="color: #24292F">                &lt;/</span><span style="color: #116329">footer</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">            &lt;/</span><span style="color: #116329">main-layout</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">        &lt;/</span><span style="color: #116329">router-component</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    &lt;/</span><span style="color: #116329">body</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">&lt;/</span><span style="color: #116329">html</span><span style="color: #24292F">&gt;</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>But can still get the state of the application at runtime:</p>
<pre><code class="language-js"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">JSON</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">stringify</span><span style="color: #C9D1D9">(document.</span><span style="color: #D2A8FF">querySelector</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"index-page"</span><span style="color: #C9D1D9">).data)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">JSON</span><span style="color: #24292F">.</span><span style="color: #0550AE">stringify</span><span style="color: #24292F">(document.</span><span style="color: #8250DF">querySelector</span><span style="color: #24292F">(</span><span style="color: #0A3069">"index-page"</span><span style="color: #24292F">).data)</span></span>
<span class="line"></span></code></pre></div></code></pre>
<pre><code class="language-json"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">{</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">"stories"</span><span style="color: #C9D1D9">: [</span></span>
<span class="line"><span style="color: #C9D1D9">        {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">"url"</span><span style="color: #C9D1D9">:</span><span style="color: #A5D6FF">"http://travaux.ovh.net/?do=details&amp;id=49471&amp;"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">"title"</span><span style="color: #C9D1D9">:</span><span style="color: #A5D6FF">"Fire declared in OVH SBG2 datacentre building"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">"score"</span><span style="color: #C9D1D9">:</span><span style="color: #79C0FF">660</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">"by"</span><span style="color: #C9D1D9">:</span><span style="color: #A5D6FF">"finniananderson"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">"id"</span><span style="color: #C9D1D9">:</span><span style="color: #79C0FF">26407323</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #79C0FF">"descendants"</span><span style="color: #C9D1D9">:</span><span style="color: #79C0FF">304</span></span>
<span class="line"><span style="color: #C9D1D9">        },</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA198; font-style: italic">...</span></span>
<span class="line"><span style="color: #C9D1D9">    ]</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">{</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #0550AE">"stories"</span><span style="color: #24292F">: [</span></span>
<span class="line"><span style="color: #24292F">        {</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #0550AE">"url"</span><span style="color: #24292F">:</span><span style="color: #0A3069">"http://travaux.ovh.net/?do=details&amp;id=49471&amp;"</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #0550AE">"title"</span><span style="color: #24292F">:</span><span style="color: #0A3069">"Fire declared in OVH SBG2 datacentre building"</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #0550AE">"score"</span><span style="color: #24292F">:</span><span style="color: #0550AE">660</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #0550AE">"by"</span><span style="color: #24292F">:</span><span style="color: #0A3069">"finniananderson"</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #0550AE">"id"</span><span style="color: #24292F">:</span><span style="color: #0550AE">26407323</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #0550AE">"descendants"</span><span style="color: #24292F">:</span><span style="color: #0550AE">304</span></span>
<span class="line"><span style="color: #24292F">        },</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #82071E; font-style: italic">...</span></span>
<span class="line"><span style="color: #24292F">    ]</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>So how does it do this?</p>
<p>As Prism is a compiler, it knows the bindings at build time. With the knowledge of bindings, Prism can compile in getters for each property that accesses the DOM. Once values are retrieved from the DOM they are cached in the component state and will act the same way as if the data was instantiated on the client.</p>
<p>The runtime does this in quite a special way to be efficient. Getting the data is only done once that member is evaluated, rather when the document or component loads. If you evaluate <code>temp1.data.stories[2].title</code> it will only load in the 3rd story, and from the story only the title property rather than bringing in every story and constructing the whole state (not that the getting the state from the HTML is expensive, in practice getting the whole state via JSON took 6ms. But in applications with more than 10 stories on the home page the improvement is visible).</p>
<p>Some of the advantages of JIT hydration:</p>
<ul>
<li>Smaller HTML payload sizes.</li>
<li>Simplicity, all a component needs to have data is SSR DOM content.</li>
<li>Complications for objects that cannot be represented in JSON (DateTime 👀).</li>
</ul>
<p>Although values in the DOM are all strings, Prism converts the string to the correct types. This can be seen from the <code>id</code> and <code>score</code> value on each story in the state.</p>
<p>Recreating the state from the rendered markup is not a new thing. Many existing SSR sites manually write JS in the runtime script to get values. The actual HN site does this in its vote logic to where it pulls in the story identifer from the elements identifer:</p>
<pre><code class="language-js"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">vote</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">ev</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">el</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">how</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> id </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> el.id.</span><span style="color: #D2A8FF">split</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">/_/</span><span style="color: #C9D1D9">)[</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> up </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">$</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">'up_'</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> id);</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">vis</span><span style="color: #C9D1D9">(up, how </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">'un'</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">vote</span><span style="color: #24292F">(</span><span style="color: #953800">ev</span><span style="color: #24292F">, </span><span style="color: #953800">el</span><span style="color: #24292F">, </span><span style="color: #953800">how</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">  </span><span style="color: #CF222E">var</span><span style="color: #24292F"> id </span><span style="color: #CF222E">=</span><span style="color: #24292F"> el.id.</span><span style="color: #8250DF">split</span><span style="color: #24292F">(</span><span style="color: #0A3069">/_/</span><span style="color: #24292F">)[</span><span style="color: #0550AE">1</span><span style="color: #24292F">];</span></span>
<span class="line"><span style="color: #24292F">  </span><span style="color: #CF222E">var</span><span style="color: #24292F"> up </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">$</span><span style="color: #24292F">(</span><span style="color: #0A3069">'up_'</span><span style="color: #24292F"> </span><span style="color: #CF222E">+</span><span style="color: #24292F"> id);</span></span>
<span class="line"><span style="color: #24292F">  </span><span style="color: #8250DF">vis</span><span style="color: #24292F">(up, how </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #0A3069">'un'</span><span style="color: #24292F">);</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>But Prism automates this process for a declarative input. In contrast to the about logic in <code>hn.js</code>, which is handwritten and relies on the fact that the server-rendered element's id includes the id of the post.</p>
<h3 id="bundle-size" tabindex="-1">Bundle size</h3>
<p>The JS bundle for hacker news is 12.6kb uncompressed (3.5kb Gzip or 3.2kb Brotli). This includes:</p>
<ul>
<li>All the render logic for the pages</li>
<li>All the reactivity</li>
<li>A single-page router</li>
<li>All the client data fetching logic</li>
</ul>
<p>Actual HN runs on ~4kb of uncompressed JS but then it is not a spa or framework built so I don't think there is any comparison with it. On the other hand, the Svelte HN implementation runs on 30kb of JS (although it doesn't seem to be minified). But when it comes to these small numbers it doesn't matter, as long as it's under 50kb of JS it's pretty responsive.</p>
<p>Coming back to the size, with any abstraction or automated approach there is bound to be more JS outputted than writing it out by hand. Prism automates a lot of stuff, and provides the declarative approach that exists in all other client-side frameworks while keeping the bundle size very low:</p>
<pre><code class="language-html"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">&lt;</span><span style="color: #7EE787">template</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    &lt;</span><span style="color: #7EE787">div</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">#html</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"text"</span><span style="color: #C9D1D9">&gt;&lt;/</span><span style="color: #7EE787">div</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    &lt;</span><span style="color: #7EE787">span</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"by"</span><span style="color: #C9D1D9">&gt;by {by}&lt;/</span><span style="color: #7EE787">span</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    &lt;</span><span style="color: #7EE787">ul</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">class</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"sub-comments"</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">#for</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"const subComment of subComments"</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">        &lt;</span><span style="color: #7EE787">li</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">            &lt;</span><span style="color: #FFA198; font-style: italic">This</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">$data</span><span style="color: #C9D1D9">=</span><span style="color: #A5D6FF">"subComment"</span><span style="color: #C9D1D9">&gt;&lt;/</span><span style="color: #FFA198; font-style: italic">This</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">        &lt;/</span><span style="color: #7EE787">li</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    &lt;/</span><span style="color: #7EE787">ul</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">&lt;/</span><span style="color: #7EE787">template</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">&lt;</span><span style="color: #7EE787">script</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// @useRustStatement #[derive(Clone, Debug, serde::Deserialize)]</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">export</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">IComment</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">by</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">id</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        @</span><span style="color: #D2A8FF">useRustStatement</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`#[serde(default)]`</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">text</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">        @</span><span style="color: #D2A8FF">useRustStatement</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`#[serde(default)]`</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">subComments</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">IComment</span><span style="color: #C9D1D9">&gt;,</span></span>
<span class="line"><span style="color: #C9D1D9">        @</span><span style="color: #D2A8FF">useRustStatement</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`#[serde(default)]`</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FFA657">kids</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">maxCommentDepth</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">export</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">class</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Comment</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extends</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Component</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">IComment</span><span style="color: #C9D1D9">&gt; {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">static</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">getComment</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">id</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">depth</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">endpoint</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">`https://hacker-news.firebaseio.com/v0/item/${</span><span style="color: #C9D1D9">id</span><span style="color: #A5D6FF">}.json`</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">request</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(endpoint);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">comment</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> request.</span><span style="color: #D2A8FF">json</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">comment) </span><span style="color: #FF7B72">throw</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Error</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`Could not find comment under id ${</span><span style="color: #C9D1D9">id</span><span style="color: #A5D6FF">}`</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (comment.kids </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> depth </span><span style="color: #FF7B72">&lt;</span><span style="color: #C9D1D9"> maxCommentDepth) {</span></span>
<span class="line"><span style="color: #C9D1D9">                </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">subComments</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> comment.kids</span></span>
<span class="line"><span style="color: #C9D1D9">                    .</span><span style="color: #D2A8FF">slice</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">                    .</span><span style="color: #D2A8FF">map</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">kidID</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> Comment.</span><span style="color: #D2A8FF">getComment</span><span style="color: #C9D1D9">(kidID, depth </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #C9D1D9">                comment.subComments </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">all</span><span style="color: #C9D1D9">(subComments);</span></span>
<span class="line"><span style="color: #C9D1D9">            } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">                comment.subComments </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [];</span></span>
<span class="line"><span style="color: #C9D1D9">            }</span></span>
<span class="line"><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> comment;</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">&lt;/</span><span style="color: #7EE787">script</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">&lt;</span><span style="color: #7EE787">style</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">    &amp; {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">display</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">block</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">margin</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">10</span><span style="color: #FF7B72">px</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #7EE787">div</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">font-size</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">14</span><span style="color: #FF7B72">px</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #7EE787">span</span><span style="color: #79C0FF">.by</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">display</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">block</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">margin-top</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">12</span><span style="color: #FF7B72">px</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">font-style</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">italic</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">font-size</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">12</span><span style="color: #FF7B72">px</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #7EE787">ul</span><span style="color: #79C0FF">.sub-comments</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #79C0FF">padding-left</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">24</span><span style="color: #FF7B72">px</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">&lt;/</span><span style="color: #7EE787">style</span><span style="color: #C9D1D9">&gt;</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">&lt;</span><span style="color: #116329">template</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    &lt;</span><span style="color: #116329">div</span><span style="color: #24292F"> </span><span style="color: #0550AE">#html</span><span style="color: #24292F">=</span><span style="color: #0A3069">"text"</span><span style="color: #24292F">&gt;&lt;/</span><span style="color: #116329">div</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    &lt;</span><span style="color: #116329">span</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"by"</span><span style="color: #24292F">&gt;by {by}&lt;/</span><span style="color: #116329">span</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    &lt;</span><span style="color: #116329">ul</span><span style="color: #24292F"> </span><span style="color: #0550AE">class</span><span style="color: #24292F">=</span><span style="color: #0A3069">"sub-comments"</span><span style="color: #24292F"> </span><span style="color: #0550AE">#for</span><span style="color: #24292F">=</span><span style="color: #0A3069">"const subComment of subComments"</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">        &lt;</span><span style="color: #116329">li</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">            &lt;</span><span style="color: #82071E; font-style: italic">This</span><span style="color: #24292F"> </span><span style="color: #0550AE">$data</span><span style="color: #24292F">=</span><span style="color: #0A3069">"subComment"</span><span style="color: #24292F">&gt;&lt;/</span><span style="color: #82071E; font-style: italic">This</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">        &lt;/</span><span style="color: #116329">li</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    &lt;/</span><span style="color: #116329">ul</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">&lt;/</span><span style="color: #116329">template</span><span style="color: #24292F">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">&lt;</span><span style="color: #116329">script</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #6E7781">// @useRustStatement #[derive(Clone, Debug, serde::Deserialize)]</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">export</span><span style="color: #24292F"> </span><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">IComment</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">by</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        @</span><span style="color: #8250DF">useRustStatement</span><span style="color: #24292F">(</span><span style="color: #0A3069">`#[serde(default)]`</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">text</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">        @</span><span style="color: #8250DF">useRustStatement</span><span style="color: #24292F">(</span><span style="color: #0A3069">`#[serde(default)]`</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">subComments</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;</span><span style="color: #953800">IComment</span><span style="color: #24292F">&gt;,</span></span>
<span class="line"><span style="color: #24292F">        @</span><span style="color: #8250DF">useRustStatement</span><span style="color: #24292F">(</span><span style="color: #0A3069">`#[serde(default)]`</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #953800">kids</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">number</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">maxCommentDepth</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">3</span><span style="color: #24292F">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">export</span><span style="color: #24292F"> </span><span style="color: #CF222E">class</span><span style="color: #24292F"> </span><span style="color: #953800">Comment</span><span style="color: #24292F"> </span><span style="color: #CF222E">extends</span><span style="color: #24292F"> </span><span style="color: #0550AE">Component</span><span style="color: #24292F">&lt;</span><span style="color: #953800">IComment</span><span style="color: #24292F">&gt; {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">static</span><span style="color: #24292F"> </span><span style="color: #CF222E">async</span><span style="color: #24292F"> </span><span style="color: #8250DF">getComment</span><span style="color: #24292F">(</span><span style="color: #953800">id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F">, </span><span style="color: #953800">depth</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">1</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">endpoint</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">`https://hacker-news.firebaseio.com/v0/item/${</span><span style="color: #24292F">id</span><span style="color: #0A3069">}.json`</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">request</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> </span><span style="color: #8250DF">fetch</span><span style="color: #24292F">(endpoint);</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">comment</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> request.</span><span style="color: #8250DF">json</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #CF222E">!</span><span style="color: #24292F">comment) </span><span style="color: #CF222E">throw</span><span style="color: #24292F"> </span><span style="color: #0550AE">Error</span><span style="color: #24292F">(</span><span style="color: #0A3069">`Could not find comment under id ${</span><span style="color: #24292F">id</span><span style="color: #0A3069">}`</span><span style="color: #24292F">);</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">if</span><span style="color: #24292F"> (comment.kids </span><span style="color: #CF222E">&amp;&amp;</span><span style="color: #24292F"> depth </span><span style="color: #CF222E">&lt;</span><span style="color: #24292F"> maxCommentDepth) {</span></span>
<span class="line"><span style="color: #24292F">                </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">subComments</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> comment.kids</span></span>
<span class="line"><span style="color: #24292F">                    .</span><span style="color: #8250DF">slice</span><span style="color: #24292F">(</span><span style="color: #0550AE">0</span><span style="color: #24292F">, </span><span style="color: #0550AE">3</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">                    .</span><span style="color: #8250DF">map</span><span style="color: #24292F">(</span><span style="color: #953800">kidID</span><span style="color: #24292F"> </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> Comment.</span><span style="color: #8250DF">getComment</span><span style="color: #24292F">(kidID, depth </span><span style="color: #CF222E">+</span><span style="color: #24292F"> </span><span style="color: #0550AE">1</span><span style="color: #24292F">));</span></span>
<span class="line"><span style="color: #24292F">                comment.subComments </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> </span><span style="color: #0550AE">Promise</span><span style="color: #24292F">.</span><span style="color: #8250DF">all</span><span style="color: #24292F">(subComments);</span></span>
<span class="line"><span style="color: #24292F">            } </span><span style="color: #CF222E">else</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">                comment.subComments </span><span style="color: #CF222E">=</span><span style="color: #24292F"> [];</span></span>
<span class="line"><span style="color: #24292F">            }</span></span>
<span class="line"><span style="color: #24292F">            </span><span style="color: #CF222E">return</span><span style="color: #24292F"> comment;</span></span>
<span class="line"><span style="color: #24292F">        }</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"><span style="color: #24292F">&lt;/</span><span style="color: #116329">script</span><span style="color: #24292F">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">&lt;</span><span style="color: #116329">style</span><span style="color: #24292F">&gt;</span></span>
<span class="line"><span style="color: #24292F">    &amp; {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">display</span><span style="color: #24292F">: </span><span style="color: #0550AE">block</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">margin</span><span style="color: #24292F">: </span><span style="color: #0550AE">10</span><span style="color: #CF222E">px</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #116329">div</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">font-size</span><span style="color: #24292F">: </span><span style="color: #0550AE">14</span><span style="color: #CF222E">px</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #116329">span</span><span style="color: #0550AE">.by</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">display</span><span style="color: #24292F">: </span><span style="color: #0550AE">block</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">margin-top</span><span style="color: #24292F">: </span><span style="color: #0550AE">12</span><span style="color: #CF222E">px</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">font-style</span><span style="color: #24292F">: </span><span style="color: #0550AE">italic</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">font-size</span><span style="color: #24292F">: </span><span style="color: #0550AE">12</span><span style="color: #CF222E">px</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #116329">ul</span><span style="color: #0550AE">.sub-comments</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #0550AE">padding-left</span><span style="color: #24292F">: </span><span style="color: #0550AE">24</span><span style="color: #CF222E">px</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"><span style="color: #24292F">&lt;/</span><span style="color: #116329">style</span><span style="color: #24292F">&gt;</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>When Prism's HN app launches, the custom elements connected events fire and add event listeners to the existing markup. Here the upvote and downvote buttons on the story preview are connected as event listeners. Prism recognizes that the server is not the client and all elements with events will be server-rendered with the disable attribute (which is removed once the listener is added).</p>
<p>When the button is clicked, the upvote method will fire and inside it will increment <code>this.data.score</code>. If the value is not already in the data cache it will be hydrated in. The increment operator will then fire a set which under the hood fires an imperative DOM call to update the view and the view will now show <code>score + 1</code> points.</p>
<p>Prism also has a built-in static router. Clicking on the comments anchor tag will route to the story's page. This is just a regular anchor tag under the hood so if the JS fails it will do a regular redirect and hit the server.</p>
<p>SPA routing has the benefits over the MPA that HN has. On a redirect, it only has to load the data for that new view in and not the whole markup. This can reduce the payload. On redirecting the HN header is retained in the DOM and only the page is switched out. Not used here but also animations can be done rather than a flash of content. It also means that this site works without SSR and can be cached in a service worker.</p>
<hr>
<blockquote>
<p>This is only experimental at the moment, there is a lot of stuff hacked together in the compiler to get this example to work. The compilation is shaky at best and only works for simple examples such as this. This is not a drop in replacement for a nextjs site. And lacks a lot of the reactivity that React, Vue and Svelte have to offer.</p>
<p>For now this is a proposal and a experiment to see whether there are improvements that can be made in this.</p>
</blockquote>
<h3 id="future" tabindex="-1">Future</h3>
<p>One improvement that would improve page response times is streaming the document to the client. Currently, the server-rendered page is only sent to the client once the whole server response has been built. Using streaming, the client here would get the header to render in before the backend has even hit the HN API. With each backend request the response could be immediately sent to the client to be rendered in. This would also work really well with the JIT hydration.</p>
<p>With the addition of Rust to the target outputs for Prism it proves that there is the ability to construct SSR functions for other languages. The addition took less than 2 weeks to implement and a lot of that was opening up the pipeline to be less language-oriented (and a lot of wrangling with Rust's memory safety model). There is an opportunity to add support for more languages if this is a beneficial feature but I think the Rust implementation needs to be scrutinized and tightened up before that happens.</p>
<p>This clone is also missing many features from the actual version that I would still like to implement. But I only spun this example up in a week and before then I had no experience with Rust. Also during development Prism was missing a few features such as recursive components (used for the comments) and unsafe html (HN text field includes raw HTML) so I added them for version 1.3.0.</p>
<p>For now, you can clone the clone and try it out here: <a href="https://github.com/kaleidawave/hackernews-prism">kaleidawave/hackernews-prism</a>.</p>
<p>For a JS-based isomorphic site, there is <a href="https://github.com/kaleidawave/prism-ssr-demo">kaleidawave/prism-ssr-demo</a> and can be run on <a href="https://repl.it/github/kaleidawave/prism-ssr-demo">replit</a>.</p>

</div>

<div class="discussions">
    <script src="https://giscus.app/client.js" data-repo="kaleidawave/discussions" data-repo-id="R_kgDOIy08KA" data-category="Comments" data-category-id="DIC_kwDOIy08KM4CTpn8" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async="">
            </script>
</div>

<script defer="">
    for (const video of document.querySelectorAll("video")) {
        video.addEventListener("mouseover", (ev) => {
            ev.target.play();
        })
    }
</script>

        </div>
        
    </main>
    <footer>
        <div class="width-box">
            <form>
                <label for="toggle-theme">Light Mode</label>
                <input type="checkbox" name="toggle-theme" id="toggle-theme">
            </form>
            <nav>
                <ul>
                    <li>
                        <a href="https://bsky.app/profile/kaleidawave.bsky.social">Bluesky <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/kaleidawave">Twitter <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://github.com/kaleidawave">GitHub <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a>
                    </li>
                    <li>
                        Built with <a href="https://www.11ty.dev/"><svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3.398 12V0h17.204v24H3.398zm13.17 6.07a1.07 1.07 0 00.373-.107c.432-.213.68-.672.877-1.626.076-.372 1.195-6.168 1.209-6.263.026-.186-.008-.382-.084-.476a.325.325 0 00-.087-.064l-.06-.031h-.291c-.253 0-.298 0-.348.02-.113.039-.207.156-.255.316-.011.038-.168.881-.348 1.873l-.328 1.802-.046-.21c-.56-2.547-.764-3.452-.794-3.532a.383.383 0 00-.103-.16c-.105-.107-.117-.11-.567-.11-.411 0-.422 0-.5.074-.086.079-.122.216-.111.42.006.115.045.27.688 2.784.663 2.587.751 2.943.787 3.177.046.3-.05.713-.208.893-.032.037-.037.039-.084.032-.028 0-.12-.027-.204-.051-.268-.078-.362-.072-.462.028-.096.096-.137.248-.138.51 0 .256.028.34.159.473.131.133.324.208.595.23.164.012.22.012.33-.001zm-1.896-1.712a.31.31 0 00.16-.192c.02-.058.022-.098.022-.356 0-.255-.003-.299-.021-.354-.04-.121-.136-.196-.278-.217-.041-.01-.2-.01-.355-.01-.365-.001-.378-.01-.446-.184-.068-.18-.096-.326-.113-.602a85.799 85.799 0 01-.012-1.94v-1.765h.35c.454 0 .507-.01.602-.113a.465.465 0 00.102-.24 3.273 3.273 0 000-.534c-.026-.16-.099-.271-.211-.322-.057-.025-.065-.026-.45-.03h-.392l-.003-1.22c-.003-1.09-.005-1.227-.021-1.278a.378.378 0 00-.201-.247c-.052-.024-.072-.025-.32-.029-.27 0-.356 0-.429.038-.087.042-.148.133-.185.278-.014.054-.032.346-.076 1.262l-.06 1.194s-.08 0-.18.01c-.206.01-.263.022-.327.086-.092.092-.12.19-.127.455-.01.334.02.487.115.588.075.081.134.1.345.106l.173.01v1.785c0 1.7.006 2.019.034 2.274.041.37.13.709.241.928.194.38.544.617.988.668h1.005l.07-.04zm-7.447 0c.098-.053.16-.154.2-.332.016-.077.018-.401.018-4.518 0-4.184-.001-4.44-.02-4.51-.05-.194-.19-.29-.378-.26-.035.01-.344.084-.686.175-.343.09-.684.18-.758.198-.17.043-.214.062-.281.126-.105.098-.122.185-.122.606 0 .416.016.5.12.604.094.095.189.1.456.03.103-.026.193-.048.2-.048.01 0 .014.784.017 3.763.003 3.436.005 3.77.021 3.84.048.202.113.296.236.34.034.013.133.016.487.014.435 0 .445 0 .49-.027zm3.203 0c.092-.046.152-.135.197-.29l.024-.084.003-4.435c.002-3.194 0-4.456-.01-4.509-.033-.2-.145-.308-.322-.308-.066 0-.198.03-.857.204-.56.147-.799.214-.849.239a.34.34 0 00-.17.184c-.024.06-.024.071-.024.479 0 .415 0 .417.026.483a.362.362 0 00.083.12c.1.1.172.105.456.034a5.46 5.46 0 01.208-.05c.008 0 .012 1.202.014 3.791l.003 3.79.026.086a.48.48 0 00.135.23c.078.062.085.063.57.06.414 0 .447 0 .487-.024z"></path></svg> Eleventy</a> and
                        <a href="/architecture">others</a>
                    </li>
                </ul>
            </nav>
        </div>
    </footer>
    <script>
        if (localStorage.getItem("theme") === null) {
    changeScheme();
} else {
    updateThemeClass();
}

function changeScheme(darkTheme = null) {
    if (darkTheme === null) {
        if ("matchMedia" in window) {
            darkTheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
        } else {
            darkTheme = false;
        }
    }
    localStorage.setItem("theme", darkTheme ? "dark" : "light");
    updateThemeClass();
}

function updateThemeClass(value = null) {
    if (value === null) {
        value = localStorage.getItem("theme") === "dark";
    }
    if (value) {
        document.documentElement.classList.add("dark");
    } else {
        document.documentElement.classList.remove("dark");
    }
}

{
    const themeSwitch = document.querySelector("#toggle-theme");
    themeSwitch.checked = localStorage.getItem("theme") !== "dark";
    themeSwitch.addEventListener("change", (ev) => {
        const darkTheme = !ev.target.checked;
        changeScheme(darkTheme);
    });
}

// Clicking on headers stores their reference
document.addEventListener("click", (ev) => {
    if (ev.target.matches(".post > *:is(h2, h3, h4, h5)")) {
        const id = ev.target.getAttribute("id");
        if (id !== null) {
            location.href = '#' + id;
        }
    }
});

const titleBar = document.querySelector("header .icon-title")

titleBar.querySelector("img").addEventListener("dragend", () => {
    const r = document.createElement("video");
    const s = document.createElement("source");
    s.src = "/media/boom.webm";
    r.append(s);
    r.controls = false;
    titleBar.appendChild(r);
    r.addEventListener("ended", () => {
        titleBar.querySelector(".header-title").innerText = "Bengineering";
        r.style.display = "none";
    });
    r.play();

})

// TODO temp hack for highlighted rows in code blocks
for (const element of document.querySelectorAll("[data-highlight]")) {
    const indexes = element.getAttribute("data-highlight").split(",").map(a => parseInt(a));
    for (const pres of element.children[0].children) {
        // TODO adjacent indices don't style well, could do something here
        for (const index of indexes) {
            const line = pres.children[0].children[index];
            const firstChild = line.children[0];
            const newContent = firstChild.textContent.trimLeft();
            const indent = firstChild.textContent.length - newContent.length;
            firstChild.childNodes[0].data = newContent;
            line.style.marginLeft = indent + 'ch';
            line.classList.add("highlight");
        }
    }
}

    </script>


</body></html>