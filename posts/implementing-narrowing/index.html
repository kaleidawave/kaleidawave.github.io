<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="google-site-verification" content="pi8qBei6qHxHyGxm9Eh4WDhPwxU672uIJmfdIqcgIGs">
    <meta name="referrer" content="no-referrer-when-downgrade">

    
    <!-- Cloudflare Web Analytics -->
    <script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;9a3f0b71c0ea4b3d99621e1b084c24cd&quot;}"></script>
    <!-- End Cloudflare Web Analytics -->
    

    <title>Implementing narrowing</title>

    <meta name="title" content="Implementing narrowing">
    <meta property="og:title" content="Implementing narrowing">
    <meta property="twitter:title" content="Implementing narrowing">

    <meta name="description" content="Narrowing types">
    <meta property="og:description" content="Narrowing types">
    <meta property="twitter:description" content="Narrowing types">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kaleidawave.github.io/">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kaleidawave.github.io/">

    
    <meta property="twitter:image" content="https://kaleidawave.github.io/media/banners/implementing-narrowing.png">
    <meta property="og:image" content="https://kaleidawave.github.io/media/banners/implementing-narrowing.png">
    

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link rel="preconnect" href="https://fonts.gstatic.com"><link data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap" rel="stylesheet"><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap">/* vietnamese */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW86Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW87Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW81Rb0JcBao.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZJhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZthjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* greek-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZNhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+1F00-1FFF;
}
/* greek */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZxhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
/* vietnamese */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZBhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZFhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl618BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6R8BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* vietnamese */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl698BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl658BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6B8BtxaV4jcFw.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style>

    <style>:root {
    font-family: "SF Pro Display", "SF Pro Icons", "Inter", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
    font-weight: 400;

    --text-color: #1a1a1a;
    --border: var(--text-color);
    --background: #F2F0EB;
    --muted-background: #f9f5f8;
    --muted-background-opaque: #e4e0da80;
    --accent: #bc3b3b;
    --muted-accent: #993b33;
    --code-highlight: #e2ccb7;
}

@media screen {
    :root.dark {
        --text-color: #dbdbdb;
        --background: #0f0f10;
        --muted-background: #1f1f23;
        --muted-background-opaque: #1f1f2380;
        --accent: #a8ff8e;
        --muted-accent: #81b47c;
        --code-highlight: #549463;
    }
}

:root.dark .shiki-light {
    display: none;
}

:root:not(.dark) .shiki-dark {
    display: none;
}

html,
body {
    margin: 0;
    padding: 0;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    font-size: 16px;
}

body {
    background-color: var(--background, white);
    color: var(--text-color, black);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

header {
    background-color: var(--muted-background-opaque, white);
    display: flex;
    justify-content: space-around;
    align-items: center;
    font-size: 16px;
    padding: 14px;
}

:root:not(.dark) header {
    border-bottom: 2px solid var(--border);
}

header>div {
    width: 100% !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

header video {
    position: absolute;
}

header h1 {
    font-weight: 100;
    font-size: 20px;
    color: var(--text-color);
}

header h1>a {
    color: var(--text-color) !important;
}

header .icon-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

header img {
    position: relative;
    top: -4px;
    height: 26px;
    width: auto;
}

@media print {
    header nav {
        display: none;
    }

    footer {
        display: none;
    }
}

header nav>ul {
    padding-left: 0;
    display: flex;
    list-style: none;
}

header nav>ul>li {
    margin-left: 10px;
    text-transform: lowercase;
}

h1,
h2,
h3,
h4,
h5 {
    font-family: "Be Vietnam Pro", sans-serif;
    font-weight: 600;
    scroll-margin: 100px;
}

*::selection {
    background: var(--muted-accent);
    color: var(--background);
}

em {
    position: relative;
    left: -2px;
}

ul,
ol {
    margin: 0px;
    padding-left: 20px;
}

hr {
    width: 100%;
    margin: 30px auto;
    border: none;
    border-top: 1px solid var(--text-color);
}

main {
    margin: 20px 0 80px;
}

.width-box {
    width: 95%;
    margin: 0 auto;
}

svg.icon {
    height: 10pt;
    fill: var(--muted-accent);
    position: relative;
    top: 2px;
}

a {
    color: var(--accent, white);
    text-decoration: none;
}

a:visited {
    color: var(--muted-accent, white);
}

pre code {
    white-space: break-spaces !important;
    overflow-x: hidden;
    tab-size: 4;
}

/* Shrink inline code a little bit */
:is(div, p, a, li)>code {
    font-size: 90%;
}

pre,
code {
    background-color: var(--muted-background) !important;
    font-family: 'JetBrains Mono', 'Fira Code light', consolas, monospace;
    font-size: 14px;
}

footer {
    margin-top: auto;
    background-color: var(--muted-background-opaque, white);
    padding: 22px;
}

:root:not(.dark) footer {
    border-top: 2px solid var(--border);
}

footer>div {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

footer h3 {
    margin: 0;
    font-weight: inherit;
    font-size: 16px;
}

footer nav ul {
    list-style: none;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

footer nav ul>li:not(:first-child) {
    border-left: 2px solid var(--muted-accent);
    padding-left: 6px;
}

footer>div>*:nth-child(2n) {
    margin-left: auto;
    font-size: 10pt;
}

@media screen and (max-width: 480px) {
    header>div {
        flex-direction: column;
    }

    body {
        width: 100vw;
        box-sizing: border-box;
    }

    .posts>ul>li img {
        width: 100%;
        height: auto;
    }
}

@media screen and (min-width: 480px) {
    @supports (backdrop-filter: blur(20px)) {
        header {
            backdrop-filter: blur(20px);
        }
    }

    header {
        position: sticky;
        top: 0;
        right: 0;
        left: 0;
        z-index: 100;
    }

    .width-box {
        width: 100%;
        max-width: min(80vw, 840px);
    }
}</style>
    <link rel="alternate" type="application/rss+xml" href="/feed.xml">
</head>

<body>
    <header>
        <div class="width-box">
            <a class="icon-title" href="/">
                <h1 class="header-title">Ben's Engineering Blog</h1>
                <img draggable="true" src="/media/icon.png" width="256" height="256" alt="">
                
            </a>
            <nav>
                <ul>
                    <li><a href="/posts">Posts</a></li>
                    <li><a href="/about">About</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main>
        
        <div class="width-box">
            <style>.post {
    display: flex;
    flex-direction: column;
}

.post>p,
.post li,
.post blockquote {
    line-height: 1.6em;
    margin: 6px 0;
    font-weight: inherit;
    font-family: "Inter", "Helvetica", sans-serif;
}

.post>*:is(h1, h2, h3, h4, h5) {
    margin: 12pt 0;
}

.post img,
.post video,
.post pre:not(.shiki) {
    margin: 20px 0;
}

.post pre.shiki {
    margin: 0;
}

/* Dark mode by default */
:root:not(.dark) .post img.invertible,
:root:not(.dark) .post video.invertible {
    filter: invert(1);
}

.post img {
    border-radius: 10px;
}

.post svg.icon {
    height: 1em;
    fill: var(--text-color);
}

.post span.line.highlight {
    font-weight: bold;
    background-color: var(--code-highlight);
    outline: 4px var(--code-highlight) solid;
}

.post .shiki-container {
    padding: 20px;
}

.post .math {
    margin: auto;
}

.post .math>svg {
    width: auto;
    height: 200%;
    margin: 10px;
}

.post .quote {
    font-style: italic;
}

.post .quote::before {
    content: '"';
}

.post .quote::after {
    content: '"';
}

.post *[role="caption"] {
    font-size: 14px;
    margin: 6px 0 20px;
    padding: 6px;
    text-align: center;
    font-weight: normal;
    opacity: 0.8;
}

.post time {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 11pt;
    font-family: monospace;
}

.post .center {
    text-align: center;
    font-weight: inherit;
    padding: 30px;
}

.post .note {
    font-style: italic;
    font-size: 12pt;
    opacity: 0.8;
}

*:is(h1, h2, h3, h4, h5, h6)>code {
    font-size: 0.8em;
}

*:is(h1, h2, h3, h4, h5, h6, p, li)>code {
    padding: 2px 6px;
}

/* For footnotes */
.post a[href^="#foot"] {
    font-family: monospace;
    position: relative;
    top: -5px;
    left: 2px;
}

.post #footnotes~* {
    font-size: 14px;
    margin: 4px 0;
    width: 100%;
}

video.small {
    max-height: 300px !important;
}

.callout {
    margin-top: 18px;
    padding: 20px;
    font-size: 15pt;
    background-color: var(--muted-background);
    border-radius: 16px;
    border: 3px solid var(--muted-accent);
}

.post h1.title {
    font-size: 40px;
}

.post h1 {
    font-size: 32px;
}

.post h2 {
    font-size: 28px;
}

.post h3 {
    font-size: 24px;
}

.post h4 {
    font-size: 20px;
}

.post h5 {
    font-size: 16px;
}

.post a.media-container>img {
    width: 100%;
}

.post table {
    border-spacing: 0;
    border-collapse: collapse;
    margin: 40px 0;
    /* max-width: 100%;
    overflow: scroll; */
}

.post table td,
.post table th {
    border: 2px solid var(--text-color);
    padding: 6px 8px;
    text-align: left;
}

.post blockquote {
    border-left: 4px solid var(--muted-accent);
    margin: 10px 0;
    padding: 5px 10px;
    background: var(--muted-background-opaque);
}

.post blockquote>p {
    margin: 0;
}

.post .widget {
    background: white;
    border-radius: 6px;
    padding: 50px;
    margin: 40px 0;
}

.discussions {
    margin: 80px 0px;
}

.parralel pre:not(.shiki) {
    font-size: 12px;
}

@media screen and (max-width: 480px) {
    .center {
        text-align: center;
        font-weight: inherit;
        padding: 10px 0px;
    }

    .post>p,
    .post li {
        font-size: 12pt;
        line-height: 1.4em;
    }

    .post img,
    .post pre,
    .post table,
    .post .widget,
    .post video {
        width: 100%;
        height: auto;
    }

    .post pre {
        overflow-x: auto;
    }
}

@media screen and (min-width: 480px) {
    .post>.parralel {
        display: flex;
        gap: 30px;
    }

    .post>.parralel>div {
        flex-grow: 1;
    }

    .post img,
    .post video,
    .post pre:not(.shiki) {
        align-self: center;
        height: auto;
    }

    .post>img,
    .post>video,
    .post table,
    .post .widget,
    .post>a.media-container,
    .post>.parralel,
    .post>pre:not(.shiki) {
        width: 105%;
        align-self: center;
    }
}

@media print {
    .post video {
        display: none;
    }
}</style>

<div class="post">
    <h1 class="title">Implementing narrowing</h1>
    
    <time datetime="2025-09-22">
        Published on Monday 22<sup>nd</sup> September 2025
        
    </time>
    
    <p>This post is on implementing the type-narrowing feature from TypeScript into my own type-checker <a href="https://github.com/kaleidawave/ezno">ezno</a>.</p>
<h2 id="what-is-type-narrowing%3F" tabindex="-1">What is type narrowing?</h2>
<p>TypeScript is an extension to JavaScript. In JavaScript every value has a type.</p>
<pre><code class="language-javascript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #C9D1D9">) </span><span style="color: #8B949E">// number</span></span>
<span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"hiya"</span><span style="color: #C9D1D9">) </span><span style="color: #8B949E">// string</span></span>
<span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">) </span><span style="color: #8B949E">// boolean</span></span>
<span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> { a: </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> }) </span><span style="color: #8B949E">// object</span></span>
<span class="line"><span style="color: #C9D1D9">console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> (() </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)) </span><span style="color: #8B949E">// function</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">console.</span><span style="color: #8250DF">log</span><span style="color: #24292F">(</span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> </span><span style="color: #0550AE">4</span><span style="color: #24292F">) </span><span style="color: #6E7781">// number</span></span>
<span class="line"><span style="color: #24292F">console.</span><span style="color: #8250DF">log</span><span style="color: #24292F">(</span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> </span><span style="color: #0A3069">"hiya"</span><span style="color: #24292F">) </span><span style="color: #6E7781">// string</span></span>
<span class="line"><span style="color: #24292F">console.</span><span style="color: #8250DF">log</span><span style="color: #24292F">(</span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> </span><span style="color: #0550AE">false</span><span style="color: #24292F">) </span><span style="color: #6E7781">// boolean</span></span>
<span class="line"><span style="color: #24292F">console.</span><span style="color: #8250DF">log</span><span style="color: #24292F">(</span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> { a: </span><span style="color: #0550AE">2</span><span style="color: #24292F"> }) </span><span style="color: #6E7781">// object</span></span>
<span class="line"><span style="color: #24292F">console.</span><span style="color: #8250DF">log</span><span style="color: #24292F">(</span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> (() </span><span style="color: #CF222E">=&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">3</span><span style="color: #24292F">)) </span><span style="color: #6E7781">// function</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>We can reason about values and variables before run-time using type checkers and types annotations.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #D2A8FF">print_type</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">) </span><span style="color: #8B949E">// 2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">func</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">param</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">print_type</span><span style="color: #C9D1D9">(param) </span><span style="color: #8B949E">// string</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #8250DF">print_type</span><span style="color: #24292F">(</span><span style="color: #0550AE">2</span><span style="color: #24292F">) </span><span style="color: #6E7781">// 2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">func</span><span style="color: #24292F">(</span><span style="color: #953800">param</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">print_type</span><span style="color: #24292F">(param) </span><span style="color: #6E7781">// string</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>There are many places where types annotations can exist. These annotations can inform the checker about the shapes of the values a reference can have so that the checker program can report errors and more ahead of time.</p>
<p>There are other ways <em>types</em> are <em>realised</em> within the checker aside from annotations. One of them is the information present in the assumption of a condition holding in a branching structure.</p>
<p>Here we see that because of the condition <code>param === "hi"</code>, we can <strong>narrow</strong> in on the type string to knowing that value of <code>param</code> in the branch is a constant string <code>"hi"</code>.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">func</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">param</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (param </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"hi"</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #D2A8FF">print_type</span><span style="color: #C9D1D9">(param) </span><span style="color: #8B949E">// "hi"</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">func</span><span style="color: #24292F">(</span><span style="color: #953800">param</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (param </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"hi"</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #8250DF">print_type</span><span style="color: #24292F">(param) </span><span style="color: #6E7781">// "hi"</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<h2 id="why-type-narrowing%3F" tabindex="-1">Why type narrowing?</h2>
<p>This functionality enables a few things</p>
<p>1. We can branch on the tags of sum types</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Kinds</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> { </span><span style="color: #FFA657">tag</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"person"</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">name</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">age</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> { </span><span style="color: #FFA657">tag</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"vehicle"</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">horsepower</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">print_kind</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">item</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Kinds</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (item.tag </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"vehicle"</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #D2A8FF">print_type</span><span style="color: #C9D1D9">(item.horsepower)</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Kinds</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">|</span><span style="color: #24292F"> { </span><span style="color: #953800">tag</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0A3069">"person"</span><span style="color: #24292F">, </span><span style="color: #953800">name</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">, </span><span style="color: #953800">age</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F"> }</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">|</span><span style="color: #24292F"> { </span><span style="color: #953800">tag</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0A3069">"vehicle"</span><span style="color: #24292F">, </span><span style="color: #953800">horsepower</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">print_kind</span><span style="color: #24292F">(</span><span style="color: #953800">item</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Kinds</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (item.tag </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"vehicle"</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #8250DF">print_type</span><span style="color: #24292F">(item.horsepower)</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>2. We can <em>filter</em> out <code>null</code> values through early returns</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">print</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">item</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">MyObject</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (item </span><span style="color: #FF7B72">!==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">return</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">	console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(item.name)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">print</span><span style="color: #24292F">(</span><span style="color: #953800">item</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">MyObject</span><span style="color: #24292F"> </span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #0550AE">null</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (item </span><span style="color: #CF222E">!==</span><span style="color: #24292F"> </span><span style="color: #0550AE">null</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">return</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">	console.</span><span style="color: #8250DF">log</span><span style="color: #24292F">(item.name)</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>and through short-circuiting operators</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> x.</span><span style="color: #D2A8FF">contains</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"blue"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">typeof</span><span style="color: #24292F"> x </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"string"</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;&amp;</span><span style="color: #24292F"> x.</span><span style="color: #8250DF">contains</span><span style="color: #24292F">(</span><span style="color: #0A3069">"blue"</span><span style="color: #24292F">)</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>3. We can detect exact values (here through a free-variable)</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">""</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">print</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (x </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"hello"</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #8B949E">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #8B949E">// Warning here!</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (x </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"hello"</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span></span>
<span class="line"><span style="color: #C9D1D9">		}</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">	</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">""</span><span style="color: #24292F">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">print</span><span style="color: #24292F">() {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (x </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"hello"</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #6E7781">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #6E7781">// Warning here!</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (x </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"hello"</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">		</span></span>
<span class="line"><span style="color: #24292F">		}</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">	</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>4. Checking data exterior to the program</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">item</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">fetch</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"./my_api.json"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> item.property </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"string"</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(item.property);</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">item</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">await</span><span style="color: #24292F"> </span><span style="color: #8250DF">fetch</span><span style="color: #24292F">(</span><span style="color: #0A3069">"./my_api.json"</span><span style="color: #24292F">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> item.property </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"string"</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	console.</span><span style="color: #8250DF">log</span><span style="color: #24292F">(item.property);</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Effectively it enables</p>
<ul>
<li>Using properties of data of varying structure</li>
<li>Using properties of data of unknown types</li>
<li>Catching truthy values</li>
</ul>
<hr>
<p>The idea behind narrowing is to pick a new type (that is a subset of the current type) based on properties enforced by the condition.</p>
<p>We can do that given we have in the context</p>
<ol>
<li>Some <em>unknown</em> type: parameter or from some external source.</li>
<li>A conditional expression</li>
</ol>
<h2 id="information-on-types" tabindex="-1">Information on types</h2>
<p>Now we know what narrowing is and why it exists as a feature, we can see how we may go about implementing it.</p>
<blockquote>
<p>Ezno is not a rewrite or port of the TypeScript Compiler (TSC), so this implemention was built on my own intuition and may be completely different to how it is built in TSC. We can see thought that it <a href="https://kaleidawave.github.io/ezno/comparison/##narrowing">matches much of the same functionality of TSC</a>.</p>
</blockquote>
<hr>
<p>The first thing to know is how Ezno represents types. Here parameter types and external types are <em>wrapped</em> in special types similar to generics. These wrapper types therefore have a flag and as they are <em>new</em> types, a unique <code>TypeId</code>.</p>
<pre><code><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #c9d1d9">#5: string</span></span>
<span class="line"><span style="color: #c9d1d9">...</span></span>
<span class="line"><span style="color: #c9d1d9">#1232: Parameter { name: "param", backing: #5 }</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292f">#5: string</span></span>
<span class="line"><span style="color: #24292f">...</span></span>
<span class="line"><span style="color: #24292f">#1232: Parameter { name: "param", backing: #5 }</span></span>
<span class="line"><span style="color: #24292f"></span></span></code></pre></div></code></pre>
<p>When we use a parameter type we add more information onto it. These information is achieved under <code>Constructor</code>. So <code>param === "hi"</code> and <code>param.length</code> become <code>Constructor::Operation { operation: StrictEqual, lhs: #1232, rhs: *"hi"* }</code> and <code>Constructor::Property { lhs: #1232, rhs: *"length"* }</code> respectively. We can reduce these constructors to their base types of <code>boolean</code> and <code>number</code> when using them but storing them, we hold onto these richer properties.</p>
<h2 id="narrowing%3A-the-implementation" tabindex="-1">Narrowing: the implementation</h2>
<p>The main <strong>narrow</strong> function takes the type of the expression and returns a list of new constraints for various values.</p>
<p>For example given our above example, we have something like these (described in TypeScript rather than Rust).</p>
<pre><code class="language-js"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">narrow</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">expression</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Parameter</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Constructor</span><span style="color: #C9D1D9">) -&gt; </span><span style="color: #D2A8FF">Map</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">Id</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">Type</span><span style="color: #C9D1D9">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D2A8FF">narrow</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">c </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> [[</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">c</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">, </span><span style="color: #D2A8FF">Constant</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">)]]</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">narrow</span><span style="color: #24292F">(</span><span style="color: #953800">expression</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Parameter</span><span style="color: #24292F"> </span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #953800">Constructor</span><span style="color: #24292F">) -&gt; </span><span style="color: #8250DF">Map</span><span style="color: #24292F">&lt;</span><span style="color: #953800">Id</span><span style="color: #24292F">, </span><span style="color: #953800">Type</span><span style="color: #24292F">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8250DF">narrow</span><span style="color: #24292F">(</span><span style="color: #CF222E">*</span><span style="color: #24292F">c </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #0550AE">3</span><span style="color: #CF222E">*</span><span style="color: #24292F">) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> [[</span><span style="color: #CF222E">*</span><span style="color: #24292F">c</span><span style="color: #CF222E">*</span><span style="color: #24292F">, </span><span style="color: #8250DF">Constant</span><span style="color: #24292F">(</span><span style="color: #0550AE">3</span><span style="color: #24292F">)]]</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>Producing a narrowed map is implemented in the single file <a href="https://github.com/kaleidawave/ezno/blob/main/checker/src/features/narrowing.rs"><code>checker/src/features/narrowing.rs</code></a>.</p>
</blockquote>
<p>The <code>narrow</code> implementation is quite simple: we take our <code>Parameter</code> and <code>Constructor</code> objects and figure out narrowed type-to-type key-value entries in our returned map.</p>
<h3 id="operator-constructors" tabindex="-1">Operator <code>Constructor</code>s</h3>
<p>There are many kinds of expressions that give more information about values</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">a </span><span style="color: #8B949E">// a is truthy</span></span>
<span class="line"><span style="color: #C9D1D9">a </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9"> </span><span style="color: #8B949E">// a now has the type of the RHS</span></span>
<span class="line"><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> a </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9"> </span><span style="color: #8B949E">// a now has a type defined by </span></span>
<span class="line"><span style="color: #C9D1D9">a[prop] </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9"> </span><span style="color: #8B949E">// a has prop of type</span></span>
<span class="line"><span style="color: #C9D1D9">prop </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> a </span><span style="color: #8B949E">// a has a prop</span></span>
<span class="line"><span style="color: #C9D1D9">a </span><span style="color: #FF7B72">instanceof</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9"> </span><span style="color: #8B949E">// a is an object with prototype</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">a </span><span style="color: #6E7781">// a is truthy</span></span>
<span class="line"><span style="color: #24292F">a </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #CF222E">?</span><span style="color: #24292F"> </span><span style="color: #6E7781">// a now has the type of the RHS</span></span>
<span class="line"><span style="color: #CF222E">typeof</span><span style="color: #24292F"> a </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #CF222E">?</span><span style="color: #24292F"> </span><span style="color: #6E7781">// a now has a type defined by </span></span>
<span class="line"><span style="color: #24292F">a[prop] </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #CF222E">?</span><span style="color: #24292F"> </span><span style="color: #6E7781">// a has prop of type</span></span>
<span class="line"><span style="color: #24292F">prop </span><span style="color: #CF222E">in</span><span style="color: #24292F"> a </span><span style="color: #6E7781">// a has a prop</span></span>
<span class="line"><span style="color: #24292F">a </span><span style="color: #CF222E">instanceof</span><span style="color: #24292F"> </span><span style="color: #CF222E">?</span><span style="color: #24292F"> </span><span style="color: #6E7781">// a is an object with prototype</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here each has types that are structured as</p>
<ul>
<li><code>*parameter*</code></li>
<li><code>Constructor::Equal { lhs: *parameter*, rhs: ? }</code></li>
<li><code>Constructor::Equal { lhs: Constructor::TypeOf { operand: *parameter* }, rhs: ? }</code></li>
<li><code>Constructor::Equal { lhs: Constructor::Propery { operand: *parameter*, property: *prop* }, rhs: ? }</code></li>
<li><code>Constructor::HasProperty { lhs: *parameter*, rhs: *prop* }</code></li>
<li><code>Constructor::InstanceOf { lhs: *parameter*, rhs: ? }</code></li>
</ul>
<p>When we are passed one of these constructors we can return a key value pair. There is more going on but it is almost as simple as the following</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">narrow</span><span style="color: #C9D1D9">(ty</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TypeId</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">HashMap</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">TypeId</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">TypeId</span><span style="color: #C9D1D9">&gt; {</span></span>
<span class="line"><span style="color: #8B949E">	// ...</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Constructor</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">InstanceOf</span><span style="color: #C9D1D9"> { lhs, rhs } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> ty_object {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">HashMap</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">from_iter</span><span style="color: #C9D1D9">([(lhs, rhs)]);</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #8B949E">	// ...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">narrow</span><span style="color: #24292F">(ty</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">TypeId</span><span style="color: #24292F">) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #953800">HashMap</span><span style="color: #24292F">&lt;</span><span style="color: #953800">TypeId</span><span style="color: #24292F">, </span><span style="color: #953800">TypeId</span><span style="color: #24292F">&gt; {</span></span>
<span class="line"><span style="color: #6E7781">	// ...</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #953800">Constructor</span><span style="color: #CF222E">::</span><span style="color: #953800">InstanceOf</span><span style="color: #24292F"> { lhs, rhs } </span><span style="color: #CF222E">=</span><span style="color: #24292F"> ty_object {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">return</span><span style="color: #24292F"> </span><span style="color: #953800">HashMap</span><span style="color: #CF222E">::</span><span style="color: #8250DF">from_iter</span><span style="color: #24292F">([(lhs, rhs)]);</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #6E7781">	// ...</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>While roots are relatively simple, we have to do a bit more when the <code>lhs</code> is a union type.</p>
<h3 id="union-filtering" tabindex="-1">Union filtering</h3>
<p>If we have <code>x: string | number</code> (a union type) and a check of <code>typeof x === "string"</code>, we want to find types from the <code>[string, number]</code> vector that pass the check (in this case <code>string</code>).</p>
<p>Union types are represented as trees, so we do a <a href="https://github.com/kaleidawave/ezno/blob/01b1fd1368d008059abd20111ea38a788304b156/checker/src/features/narrowing.rs#L635">recursive walk yielding types that pass the filter to a <code>found</code> array</a>.</p>
<p>There are (currently) six kinds of filter</p>
<ul>
<li><code>HasProperty</code></li>
<li><code>HasPrototype</code></li>
<li><code>IsType</code></li>
<li><code>null | undefined</code></li>
<li><code>Falsy</code></li>
<li><em><code>Not&lt;Filter&gt;</code></em></li>
</ul>
<p>These each yield <code>true</code> or <code>false</code> for each type passed by the filter. If <code>true</code> we add that field to vector to build the new, filtered union type.</p>
<h3 id="logical-operations%3A-appending-ands" tabindex="-1">Logical operations: appending ands</h3>
<p>Conditions can be combined. One of those is the logical and <code>&amp;&amp;</code>, which can requires the two operands to hold.</p>
<p>To narrow these we collect each side and concatenate the left cases with the right cases. Here <code>isNumber(a) -&gt; a is number</code> and <code>isString(b) -&gt; b is string</code> get combined to yield a narrowed result of <code>isNumber(a) &amp;&amp; isString(b) -&gt; [a is number, b is string]</code></p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">isNumber</span><span style="color: #C9D1D9">(a) </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">isString</span><span style="color: #C9D1D9">(b)) {</span></span>
<span class="line"><span style="color: #C9D1D9">	a </span><span style="color: #8B949E">// is number</span></span>
<span class="line"><span style="color: #C9D1D9">	b </span><span style="color: #8B949E">// is string</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #8250DF">isNumber</span><span style="color: #24292F">(a) </span><span style="color: #CF222E">&amp;&amp;</span><span style="color: #24292F"> </span><span style="color: #8250DF">isString</span><span style="color: #24292F">(b)) {</span></span>
<span class="line"><span style="color: #24292F">	a </span><span style="color: #6E7781">// is number</span></span>
<span class="line"><span style="color: #24292F">	b </span><span style="color: #6E7781">// is string</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<h3 id="logical-operations%3A-or" tabindex="-1">Logical operations: or</h3>
<p>The other logical operator is the inclusive or: <code>||</code>. This requires a bit more handling. The following if body can run with <code>a is boolean</code> and <code>b is string</code> therefore we can make no conclusions about <code>a</code> (and vice versa).</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">isNumber</span><span style="color: #C9D1D9">(a) </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">isString</span><span style="color: #C9D1D9">(b)) {</span></span>
<span class="line"><span style="color: #C9D1D9">	a </span><span style="color: #8B949E">// is ?</span></span>
<span class="line"><span style="color: #C9D1D9">	b </span><span style="color: #8B949E">// is ?</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #8250DF">isNumber</span><span style="color: #24292F">(a) </span><span style="color: #CF222E">||</span><span style="color: #24292F"> </span><span style="color: #8250DF">isString</span><span style="color: #24292F">(b)) {</span></span>
<span class="line"><span style="color: #24292F">	a </span><span style="color: #6E7781">// is ?</span></span>
<span class="line"><span style="color: #24292F">	b </span><span style="color: #6E7781">// is ?</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>Here we find the keys of the narrowed maps to be disjoint and so produce an empty narrowed map</p>
</blockquote>
<p>However, if both operands of the logical operator yield a key-value pair for the same LHS parameter type we can <em>union</em> the results.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">isNumber</span><span style="color: #C9D1D9">(x) </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">isString</span><span style="color: #C9D1D9">(x)) {</span></span>
<span class="line"><span style="color: #C9D1D9">	x </span><span style="color: #8B949E">// is number or x is string</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #8250DF">isNumber</span><span style="color: #24292F">(x) </span><span style="color: #CF222E">||</span><span style="color: #24292F"> </span><span style="color: #8250DF">isString</span><span style="color: #24292F">(x)) {</span></span>
<span class="line"><span style="color: #24292F">	x </span><span style="color: #6E7781">// is number or x is string</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<pre><code><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #c9d1d9">x is number --\</span></span>
<span class="line"><span style="color: #c9d1d9">			   |---&gt; x is number | string</span></span>
<span class="line"><span style="color: #c9d1d9">x is string --/			   </span></span>
<span class="line"><span style="color: #c9d1d9"></span></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292f">x is number --\</span></span>
<span class="line"><span style="color: #24292f">			   |---&gt; x is number | string</span></span>
<span class="line"><span style="color: #24292f">x is string --/			   </span></span>
<span class="line"><span style="color: #24292f"></span></span></code></pre></div></code></pre>
<blockquote>
<p>You can see this merging <a href="https://github.com/kaleidawave/ezno/blob/01b1fd1368d008059abd20111ea38a788304b156/checker/src/features/narrowing.rs#L432-L433">here</a></p>
</blockquote>
<h3 id="logical-operators%3A-negation-operators" tabindex="-1">Logical operators: negation operators</h3>
<p>The final logical operation is negation. We control this through an additional parameter in our <code>narrow</code> function. When the <code>negate</code> parameter is <code>true</code> it mostly disables narrowing, but as we will see later we it can be useful with additional intrinsic types.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">func</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (x </span><span style="color: #FF7B72">!==</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">		x </span><span style="color: #8B949E">// is not 3?</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">func</span><span style="color: #24292F">(</span><span style="color: #953800">x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (x </span><span style="color: #CF222E">!==</span><span style="color: #24292F"> </span><span style="color: #0550AE">3</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">		x </span><span style="color: #6E7781">// is not 3?</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Negation is not always through the bash (<code>!</code>) operator. We sometimes see it crop up implicitly through <code>else</code> branches.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">isNumber</span><span style="color: #C9D1D9">(x)) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// ...</span></span>
<span class="line"><span style="color: #C9D1D9">} </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	x </span><span style="color: #8B949E">// is not number</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">// as this is equivalent to</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #D2A8FF">isNumber</span><span style="color: #C9D1D9">(x)) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// ...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #D2A8FF">isNumber</span><span style="color: #C9D1D9">(x)) {</span></span>
<span class="line"><span style="color: #C9D1D9">	x </span><span style="color: #8B949E">// is not number</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #8250DF">isNumber</span><span style="color: #24292F">(x)) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// ...</span></span>
<span class="line"><span style="color: #24292F">} </span><span style="color: #CF222E">else</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	x </span><span style="color: #6E7781">// is not number</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">// as this is equivalent to</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #8250DF">isNumber</span><span style="color: #24292F">(x)) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// ...</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #CF222E">!</span><span style="color: #8250DF">isNumber</span><span style="color: #24292F">(x)) {</span></span>
<span class="line"><span style="color: #24292F">	x </span><span style="color: #6E7781">// is not number</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<h3 id="logical-operators%3A-de-morgan's-laws" tabindex="-1">Logical operators: De Morgan's laws</h3>
<p>We can combine negation with the <code>&amp;&amp;</code> and <code>||</code> operators. Those familiar with <a href="https://en.wikipedia.org/wiki/De_Morgan%27s_laws">De Morgan's laws</a> may know what we can do here.</p>
<p>If we have a <code>!(a || b)</code>, we can treat it as <code>!a &amp;&amp; !b</code>. So for the following we find the following value for <code>x</code> in the else branch</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (x </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">10</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">} </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	x </span><span style="color: #8B949E">// is not 2 and not 10</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (x </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0550AE">2</span><span style="color: #24292F"> </span><span style="color: #CF222E">||</span><span style="color: #24292F"> x </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0550AE">10</span><span style="color: #24292F">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">} </span><span style="color: #CF222E">else</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	x </span><span style="color: #6E7781">// is not 2 and not 10</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>This can be seen <a href="https://github.com/kaleidawave/ezno/blob/01b1fd1368d008059abd20111ea38a788304b156/checker/src/features/narrowing.rs#L403-L409">here</a></p>
</blockquote>
<blockquote>
<p>We have the same logic for treating <code>!(a &amp;&amp; b)</code> as <code>!a &amp;&amp; !b</code></p>
</blockquote>
<h3 id="aside%3A-logical-operation-representation" tabindex="-1">Aside: logical operation representation</h3>
<p>For those who may be digging through the code wondering where <code>Constructor::LogicalOr</code> or <code>Constructor::LogicalNegation</code> is. There is a interesting <em>short-cut</em> taken by the compiler in representing these types.</p>
<p>We do this by realising the following.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">b      b </span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">x </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> y  x </span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> y;</span></span>
<span class="line"><span style="color: #C9D1D9">x </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> y  x </span><span style="color: #FF7B72">?</span><span style="color: #C9D1D9"> y </span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> x;</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">!</span><span style="color: #24292F">b      b </span><span style="color: #CF222E">?</span><span style="color: #24292F"> </span><span style="color: #0550AE">false</span><span style="color: #24292F"> </span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">true</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">x </span><span style="color: #CF222E">||</span><span style="color: #24292F"> y  x </span><span style="color: #CF222E">?</span><span style="color: #24292F"> x </span><span style="color: #CF222E">:</span><span style="color: #24292F"> y;</span></span>
<span class="line"><span style="color: #24292F">x </span><span style="color: #CF222E">&amp;&amp;</span><span style="color: #24292F"> y  x </span><span style="color: #CF222E">?</span><span style="color: #24292F"> y </span><span style="color: #CF222E">:</span><span style="color: #24292F"> x;</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>So the actual represention of these types is <code>Constructor::ConditionalResult</code>.</p>
<p>Sometimes we want this <em>lifted</em> form, so there are <a href="https://github.com/kaleidawave/ezno/blob/01b1fd1368d008059abd20111ea38a788304b156/checker/src/types/mod.rs#L476">helper methods</a> for finding these.</p>
<h3 id="control-flow" tabindex="-1">Control flow</h3>
<p>As mentioned above, when checking the <code>else</code> branch, we take the <code>condition</code> in the truthy and run narrowing again with <code>negate = true</code> this time.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #8B949E">//   </span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> negate </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">//   </span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> values </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">super</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">narrowing</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">narrow_based_on_expression_into_vec</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">	condition,</span></span>
<span class="line"><span style="color: #8B949E">	// passed here</span></span>
<span class="line"><span style="color: #C9D1D9">	negate,</span></span>
<span class="line"><span style="color: #C9D1D9">	environment,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">&amp;mut</span><span style="color: #C9D1D9"> checking_data</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">types,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9">options,</span></span>
<span class="line"><span style="color: #C9D1D9">);</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #6E7781">//   </span></span>
<span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> negate </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">true</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #6E7781">//   </span></span>
<span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> values </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">super</span><span style="color: #CF222E">::</span><span style="color: #953800">narrowing</span><span style="color: #CF222E">::</span><span style="color: #8250DF">narrow_based_on_expression_into_vec</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">	condition,</span></span>
<span class="line"><span style="color: #6E7781">	// passed here</span></span>
<span class="line"><span style="color: #24292F">	negate,</span></span>
<span class="line"><span style="color: #24292F">	environment,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">&amp;mut</span><span style="color: #24292F"> checking_data</span><span style="color: #CF222E">.</span><span style="color: #24292F">types,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">options,</span></span>
<span class="line"><span style="color: #24292F">);</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>This may be duplicate type scanning and <a href="https://github.com/kaleidawave/ezno/issues/193">maybe could be made faster in the future</a></p>
</blockquote>
<h3 id="building-new-objects" tabindex="-1">Building new objects</h3>
<p>For the following</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">func</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">obj</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> obj.property </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"number"</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #8B949E">// ...</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">func</span><span style="color: #24292F">(</span><span style="color: #953800">obj</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">any</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> obj.property </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"number"</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #6E7781">// ...</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>We build up a new object <code>{ property: number }</code> for <code>obj</code>.</p>
<h2 id="what-to-do-with-the-narrowed-values%3F" tabindex="-1">What to do with the narrowed values?</h2>
<p>Now we have a map of narrowed values, we then store these on the context local to the branch body.</p>
<p>At several stages, when using the reference, we <a href="https://github.com/kaleidawave/ezno/blob/01b1fd1368d008059abd20111ea38a788304b156/checker/src/context/mod.rs#L1016">swap out the backing type with a narrowed value from the context</a>.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">pub</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">crate</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">get_value_of_variable</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #8B949E">	/// ...</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> current_value </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> current_value</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">or_else</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> fact</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">variable_current_value</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9">on)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">copied</span><span style="color: #C9D1D9">());</span></span>
<span class="line"><span style="color: #C9D1D9">	</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(current_value) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> current_value {</span></span>
<span class="line"><span style="color: #8B949E">		// info = property on context</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> narrowed </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> info</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">get_narrowed_or_object</span><span style="color: #C9D1D9">(current_value, types); </span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(narrowed) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> narrowed {</span></span>
<span class="line"><span style="color: #C9D1D9">			</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(narrowed);</span></span>
<span class="line"><span style="color: #C9D1D9">		} </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">			</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Some</span><span style="color: #C9D1D9">(current_value);</span></span>
<span class="line"><span style="color: #C9D1D9">		}</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #8B949E">	/// ...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">pub</span><span style="color: #24292F">(</span><span style="color: #CF222E">crate</span><span style="color: #24292F">) </span><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">get_value_of_variable</span><span style="color: #24292F">(</span><span style="color: #CF222E">...</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #6E7781">	/// ...</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">let</span><span style="color: #24292F"> current_value </span><span style="color: #CF222E">=</span><span style="color: #24292F"> current_value</span><span style="color: #CF222E">.</span><span style="color: #8250DF">or_else</span><span style="color: #24292F">(</span><span style="color: #CF222E">||</span><span style="color: #24292F"> fact</span><span style="color: #CF222E">.</span><span style="color: #24292F">variable_current_value</span><span style="color: #CF222E">.</span><span style="color: #8250DF">get</span><span style="color: #24292F">(</span><span style="color: #CF222E">&amp;</span><span style="color: #24292F">on)</span><span style="color: #CF222E">.</span><span style="color: #8250DF">copied</span><span style="color: #24292F">());</span></span>
<span class="line"><span style="color: #24292F">	</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #953800">Some</span><span style="color: #24292F">(current_value) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> current_value {</span></span>
<span class="line"><span style="color: #6E7781">		// info = property on context</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">let</span><span style="color: #24292F"> narrowed </span><span style="color: #CF222E">=</span><span style="color: #24292F"> info</span><span style="color: #CF222E">.</span><span style="color: #8250DF">get_narrowed_or_object</span><span style="color: #24292F">(current_value, types); </span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #953800">Some</span><span style="color: #24292F">(narrowed) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> narrowed {</span></span>
<span class="line"><span style="color: #24292F">			</span><span style="color: #CF222E">return</span><span style="color: #24292F"> </span><span style="color: #953800">Some</span><span style="color: #24292F">(narrowed);</span></span>
<span class="line"><span style="color: #24292F">		} </span><span style="color: #CF222E">else</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">			</span><span style="color: #CF222E">return</span><span style="color: #24292F"> </span><span style="color: #953800">Some</span><span style="color: #24292F">(current_value);</span></span>
<span class="line"><span style="color: #24292F">		}</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #6E7781">	/// ...</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Thus concluding how narrowing is implemented:</p>
<ol>
<li>Have types that store information about operators etc</li>
<li><em>Visit</em> the condition type, producing a map of narrowed constraints. Apply logical operator rules and run filters</li>
<li>Store that information in the branch context</li>
<li>When looking up a type of variable etc, look for a narrowed type</li>
</ol>
<h2 id="more-narrowing" tabindex="-1">More narrowing</h2>
<p>We have covered that basics of narrowing. Here are some other interesting things I also implemented.</p>
<h3 id="explicit-type-annotation-type-guards" tabindex="-1">Explicit type annotation type guards</h3>
<p>While we can write expression type guards, sometimes this functionality is hidden behind functions. To do this we have <a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#typeof-type-guards">return type guards</a>.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">isNumber</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">x</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">is</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">typeof</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"number"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">isNumber</span><span style="color: #24292F">(</span><span style="color: #953800">x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">any</span><span style="color: #24292F">)</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">x</span><span style="color: #24292F"> </span><span style="color: #CF222E">is</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">  </span><span style="color: #CF222E">return</span><span style="color: #24292F"> </span><span style="color: #CF222E">typeof</span><span style="color: #24292F"> x </span><span style="color: #CF222E">===</span><span style="color: #24292F"> </span><span style="color: #0A3069">"number"</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>This works simply again with <code>x</code> being an implict generic. For <code>x is y</code> type annotations, we look up the parameter type of <code>x</code> and <a href="https://github.com/kaleidawave/ezno/blob/01b1fd1368d008059abd20111ea38a788304b156/checker/src/synthesis/type_annotations.rs#L728-L751">use that type</a>. At usage, this is done by specialisation like other generics.</p>
<blockquote>
<p>The checker has not be tested on schema libraries like <a href="https://arktype.io/">arktype</a> or <a href="https://zod.dev/">zod</a> which use return type guards. Other features of the type system are missing to support this</p>
</blockquote>
<p>These type guards are synthesised as annotations into a constructor not producible from JavaScript expressions (at the moment ). However, because of the <code>Constructor</code> type, we get <a href="https://devblogs.microsoft.com/typescript/announcing-typescript-5-5/#inferred-type-predicates">inferred type guards for free</a>.</p>
<p>We also can <a href="https://kaleidawave.github.io/ezno/playground/?id=9plseg">check them</a> (a feature TypeScript does not currently have).</p>
<img src="../../media/ezno-screenshots/guard-checking.png" alt="guard checking">
<blockquote>
<p>This is <a href="https://github.com/kaleidawave/ezno/blob/01b1fd1368d008059abd20111ea38a788304b156/checker/src/types/subtyping.rs#L1201-L1239">implemented in type subtyping</a></p>
</blockquote>
<h3 id="inference-of-not-intrinsic" tabindex="-1">Inference of <code>Not</code> intrinsic</h3>
<p>Ezno has additional types that can represent things not possible in TypeScript. One of those is the <code>Not&lt;Type&gt;</code>. <a href="/posts/experimental-types/">You can read more about these additional types in a previous post</a>.</p>
<p>With the <code>Not</code> intrinsic generated by narrowing <a href="https://kaleidawave.github.io/ezno/playground/?id=9q89hk">we can find invariants in the program</a>.</p>
<img src="../../media/ezno-screenshots/narrowing-not.png" alt="narrow-not">
<h3 id="inference-of-other-number-intrinsics" tabindex="-1">Inference of other number intrinsics</h3>
<p>We can also do this <a href="https://kaleidawave.github.io/ezno/playground/?id=8vn0g0">for numbers</a>.</p>
<img src="../../media/ezno-screenshots/narrowing-numbers.png" alt="narrowing-numbers">
<blockquote>
<p><a href="/posts/experimental-types/">Again find out more about these additional types in the previous 'experimental types' post</a>.</p>
</blockquote>
<h3 id="performance-and-type-overhead-concerns" tabindex="-1">Performance and type overhead concerns</h3>
<p>Current benchmarking shows roughly <code>1%</code> of checking time is on building the narrowing map.</p>
<pre><code><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #c9d1d9">Diagnostics: 4320</span></span>
<span class="line"><span style="color: #c9d1d9">Types:       48667</span></span>
<span class="line"><span style="color: #c9d1d9">Lines:       21990</span></span>
<span class="line"><span style="color: #c9d1d9">Cache read:  231.702s</span></span>
<span class="line"><span style="color: #c9d1d9">FS read:     1.620879ms</span></span>
<span class="line"><span style="color: #c9d1d9">Parsed in:   28.493175ms</span></span>
<span class="line"><span style="color: #c9d1d9">Checked in:  43.683541ms</span></span>
<span class="line"><span style="color: #c9d1d9">Narrowing:   400.151s</span></span>
<span class="line"><span style="color: #c9d1d9">Reporting:   903.007s</span></span>
<span class="line"><span style="color: #c9d1d9"></span></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292f">Diagnostics: 4320</span></span>
<span class="line"><span style="color: #24292f">Types:       48667</span></span>
<span class="line"><span style="color: #24292f">Lines:       21990</span></span>
<span class="line"><span style="color: #24292f">Cache read:  231.702s</span></span>
<span class="line"><span style="color: #24292f">FS read:     1.620879ms</span></span>
<span class="line"><span style="color: #24292f">Parsed in:   28.493175ms</span></span>
<span class="line"><span style="color: #24292f">Checked in:  43.683541ms</span></span>
<span class="line"><span style="color: #24292f">Narrowing:   400.151s</span></span>
<span class="line"><span style="color: #24292f">Reporting:   903.007s</span></span>
<span class="line"><span style="color: #24292f"></span></span></code></pre></div></code></pre>
<p>The extra intermediate types with deep properties may be a general concern though for performance.</p>
<h2 id="wrapping-up" tabindex="-1">Wrapping up</h2>
<p>Hopefully this was interesting short explanation on how I implemented type narrowing. More posts coming soon!</p>

</div>

<div class="discussions">
    <script src="https://giscus.app/client.js" data-repo="kaleidawave/discussions" data-repo-id="R_kgDOIy08KA" data-category="Comments" data-category-id="DIC_kwDOIy08KM4CTpn8" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async="">
            </script>
</div>

<script defer="">
    for (const video of document.querySelectorAll("video")) {
        video.addEventListener("mouseover", (ev) => {
            ev.target.play();
        })
    }
</script>

        </div>
        
    </main>
    <footer>
        <div class="width-box">
            <form>
                <label for="toggle-theme">Light Mode</label>
                <input type="checkbox" name="toggle-theme" id="toggle-theme">
            </form>
            <nav>
                <ul>
                    <li>
                        <a href="https://bsky.app/profile/kaleidawave.bsky.social">Bluesky <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/kaleidawave">Twitter <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://github.com/kaleidawave">GitHub <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a>
                    </li>
                    <li>
                        Built with <a href="https://www.11ty.dev/"><svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3.398 12V0h17.204v24H3.398zm13.17 6.07a1.07 1.07 0 00.373-.107c.432-.213.68-.672.877-1.626.076-.372 1.195-6.168 1.209-6.263.026-.186-.008-.382-.084-.476a.325.325 0 00-.087-.064l-.06-.031h-.291c-.253 0-.298 0-.348.02-.113.039-.207.156-.255.316-.011.038-.168.881-.348 1.873l-.328 1.802-.046-.21c-.56-2.547-.764-3.452-.794-3.532a.383.383 0 00-.103-.16c-.105-.107-.117-.11-.567-.11-.411 0-.422 0-.5.074-.086.079-.122.216-.111.42.006.115.045.27.688 2.784.663 2.587.751 2.943.787 3.177.046.3-.05.713-.208.893-.032.037-.037.039-.084.032-.028 0-.12-.027-.204-.051-.268-.078-.362-.072-.462.028-.096.096-.137.248-.138.51 0 .256.028.34.159.473.131.133.324.208.595.23.164.012.22.012.33-.001zm-1.896-1.712a.31.31 0 00.16-.192c.02-.058.022-.098.022-.356 0-.255-.003-.299-.021-.354-.04-.121-.136-.196-.278-.217-.041-.01-.2-.01-.355-.01-.365-.001-.378-.01-.446-.184-.068-.18-.096-.326-.113-.602a85.799 85.799 0 01-.012-1.94v-1.765h.35c.454 0 .507-.01.602-.113a.465.465 0 00.102-.24 3.273 3.273 0 000-.534c-.026-.16-.099-.271-.211-.322-.057-.025-.065-.026-.45-.03h-.392l-.003-1.22c-.003-1.09-.005-1.227-.021-1.278a.378.378 0 00-.201-.247c-.052-.024-.072-.025-.32-.029-.27 0-.356 0-.429.038-.087.042-.148.133-.185.278-.014.054-.032.346-.076 1.262l-.06 1.194s-.08 0-.18.01c-.206.01-.263.022-.327.086-.092.092-.12.19-.127.455-.01.334.02.487.115.588.075.081.134.1.345.106l.173.01v1.785c0 1.7.006 2.019.034 2.274.041.37.13.709.241.928.194.38.544.617.988.668h1.005l.07-.04zm-7.447 0c.098-.053.16-.154.2-.332.016-.077.018-.401.018-4.518 0-4.184-.001-4.44-.02-4.51-.05-.194-.19-.29-.378-.26-.035.01-.344.084-.686.175-.343.09-.684.18-.758.198-.17.043-.214.062-.281.126-.105.098-.122.185-.122.606 0 .416.016.5.12.604.094.095.189.1.456.03.103-.026.193-.048.2-.048.01 0 .014.784.017 3.763.003 3.436.005 3.77.021 3.84.048.202.113.296.236.34.034.013.133.016.487.014.435 0 .445 0 .49-.027zm3.203 0c.092-.046.152-.135.197-.29l.024-.084.003-4.435c.002-3.194 0-4.456-.01-4.509-.033-.2-.145-.308-.322-.308-.066 0-.198.03-.857.204-.56.147-.799.214-.849.239a.34.34 0 00-.17.184c-.024.06-.024.071-.024.479 0 .415 0 .417.026.483a.362.362 0 00.083.12c.1.1.172.105.456.034a5.46 5.46 0 01.208-.05c.008 0 .012 1.202.014 3.791l.003 3.79.026.086a.48.48 0 00.135.23c.078.062.085.063.57.06.414 0 .447 0 .487-.024z"></path></svg> Eleventy</a> and
                        <a href="/architecture">others</a>
                    </li>
                </ul>
            </nav>
        </div>
    </footer>
    <script>
        if (localStorage.getItem("theme") === null) {
    changeScheme();
} else {
    updateThemeClass();
}

function changeScheme(darkTheme = null) {
    if (darkTheme === null) {
        if ("matchMedia" in window) {
            darkTheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
        } else {
            darkTheme = false;
        }
    }
    localStorage.setItem("theme", darkTheme ? "dark" : "light");
    updateThemeClass();
}

function updateThemeClass(value = null) {
    if (value === null) {
        value = localStorage.getItem("theme") === "dark";
    }
    if (value) {
        document.documentElement.classList.add("dark");
    } else {
        document.documentElement.classList.remove("dark");
    }
}

{
    const themeSwitch = document.querySelector("#toggle-theme");
    themeSwitch.checked = localStorage.getItem("theme") !== "dark";
    themeSwitch.addEventListener("change", (ev) => {
        const darkTheme = !ev.target.checked;
        changeScheme(darkTheme);
    });
}

// Clicking on headers stores their reference
document.addEventListener("click", (ev) => {
    if (ev.target.matches(".post > *:is(h2, h3, h4, h5)")) {
        const id = ev.target.getAttribute("id");
        if (id !== null) {
            location.href = '#' + id;
        }
    }
});

const titleBar = document.querySelector("header .icon-title")

titleBar.querySelector("img").addEventListener("dragend", () => {
    const r = document.createElement("video");
    const s = document.createElement("source");
    s.src = "/media/boom.webm";
    r.append(s);
    r.controls = false;
    titleBar.appendChild(r);
    r.addEventListener("ended", () => {
        titleBar.querySelector(".header-title").innerText = "Bengineering";
        r.style.display = "none";
    });
    r.play();

})

// TODO temp hack for highlighted rows in code blocks
for (const element of document.querySelectorAll("[data-highlight]")) {
    const indexes = element.getAttribute("data-highlight").split(",").map(a => parseInt(a));
    for (const pres of element.children[0].children) {
        // TODO adjacent indices don't style well, could do something here
        for (const index of indexes) {
            const line = pres.children[0].children[index];
            const firstChild = line.children[0];
            const newContent = firstChild.textContent.trimLeft();
            const indent = firstChild.textContent.length - newContent.length;
            firstChild.childNodes[0].data = newContent;
            line.style.marginLeft = indent + 'ch';
            line.classList.add("highlight");
        }
    }
}

    </script>


</body></html>