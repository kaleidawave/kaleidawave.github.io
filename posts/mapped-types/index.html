<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="google-site-verification" content="pi8qBei6qHxHyGxm9Eh4WDhPwxU672uIJmfdIqcgIGs">
    <meta name="referrer" content="no-referrer-when-downgrade">

    
    <!-- Cloudflare Web Analytics -->
    <script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;9a3f0b71c0ea4b3d99621e1b084c24cd&quot;}"></script>
    <!-- End Cloudflare Web Analytics -->
    

    <title>Mapped types</title>

    <meta name="title" content="Mapped types">
    <meta property="og:title" content="Mapped types">
    <meta property="twitter:title" content="Mapped types">

    <meta name="description" content="Implementing mapped types">
    <meta property="og:description" content="Implementing mapped types">
    <meta property="twitter:description" content="Implementing mapped types">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kaleidawave.github.io/">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://kaleidawave.github.io/">

    
    <meta property="twitter:image" content="https://kaleidawave.github.io/media/banners/mapped-types.png">
    <meta property="og:image" content="https://kaleidawave.github.io/media/banners/mapped-types.png">
    

    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link rel="preconnect" href="https://fonts.gstatic.com"><link data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap" rel="stylesheet"><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400&amp;family=Roboto+Serif&amp;family=Be+Vietnam+Pro:wght@600&amp;display=swap">/* vietnamese */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW86Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW87Rb0JcBaoUUU.woff2) format('woff2');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Be Vietnam Pro';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/bevietnampro/v12/QdVMSTAyLFyeg_IDWvOJmVES_HToIW81Rb0JcBao.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZJhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZthjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* greek-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZNhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+1F00-1FFF;
}
/* greek */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZxhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0370-0377, U+037A-037F, U+0384-038A, U+038C, U+038E-03A1, U+03A3-03FF;
}
/* vietnamese */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZBhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZFhjp-Ek-_EeAmM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inter/v20/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* cyrillic-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl618BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
/* cyrillic */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6R8BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
/* vietnamese */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl698BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl658BtxaV4jcFyRM.woff) format('woff');
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: 'Roboto Serif';
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/robotoserif/v17/R71RjywflP6FLr3gZx7K8UyuXDs9zVwDmXCb8lxYgmuii32UGoVldX6UgfjL4-3sMM_kB_qXSEXTJQCFLH5-_bcEliotl6B8BtxaV4jcFw.woff) format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
</style>

    <style>:root {
    font-family: "SF Pro Display", "SF Pro Icons", "Inter", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
    font-weight: 400;

    --text-color: #1a1a1a;
    --border: var(--text-color);
    --background: #F2F0EB;
    --muted-background: #f9f5f8;
    --muted-background-opaque: #e4e0da80;
    --accent: #bc3b3b;
    --muted-accent: #993b33;
    --code-highlight: #e2ccb7;
}

@media screen {
    :root.dark {
        --text-color: #dbdbdb;
        --background: #0f0f10;
        --muted-background: #1f1f23;
        --muted-background-opaque: #1f1f2380;
        --accent: #a8ff8e;
        --muted-accent: #81b47c;
        --code-highlight: #549463;
    }
}

:root.dark .shiki-light {
    display: none;
}

:root:not(.dark) .shiki-dark {
    display: none;
}

html,
body {
    margin: 0;
    padding: 0;
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    font-size: 16px;
}

body {
    background-color: var(--background, white);
    color: var(--text-color, black);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

header {
    background-color: var(--muted-background-opaque, white);
    display: flex;
    justify-content: space-around;
    align-items: center;
    font-size: 16px;
    padding: 14px;
}

:root:not(.dark) header {
    border-bottom: 2px solid var(--border);
}

header>div {
    width: 100% !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

header video {
    position: absolute;
}

header h1 {
    font-weight: 100;
    font-size: 20px;
    color: var(--text-color);
}

header h1>a {
    color: var(--text-color) !important;
}

header .icon-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

header img {
    position: relative;
    top: -4px;
    height: 26px;
    width: auto;
}

@media print {
    header nav {
        display: none;
    }

    footer {
        display: none;
    }
}

header nav>ul {
    padding-left: 0;
    display: flex;
    list-style: none;
}

header nav>ul>li {
    margin-left: 10px;
    text-transform: lowercase;
}

h1,
h2,
h3,
h4,
h5 {
    font-family: "Be Vietnam Pro", sans-serif;
    font-weight: 600;
    scroll-margin: 100px;
}

*::selection {
    background: var(--muted-accent);
    color: var(--background);
}

em {
    position: relative;
    left: -2px;
}

ul,
ol {
    margin: 0px;
    padding-left: 20px;
}

hr {
    width: 100%;
    margin: 30px auto;
    border: none;
    border-top: 1px solid var(--text-color);
}

main {
    margin: 20px 0 80px;
}

.width-box {
    width: 95%;
    margin: 0 auto;
}

svg.icon {
    height: 10pt;
    fill: var(--muted-accent);
    position: relative;
    top: 2px;
}

a {
    color: var(--accent, white);
    text-decoration: none;
}

a:visited {
    color: var(--muted-accent, white);
}

pre code {
    white-space: break-spaces !important;
    overflow-x: hidden;
    tab-size: 4;
}

/* Shrink inline code a little bit */
:is(div, p, a, li)>code {
    font-size: 90%;
}

pre,
code {
    background-color: var(--muted-background) !important;
    font-family: 'JetBrains Mono', 'Fira Code light', consolas, monospace;
    font-size: 14px;
}

footer {
    margin-top: auto;
    background-color: var(--muted-background-opaque, white);
    padding: 22px;
}

:root:not(.dark) footer {
    border-top: 2px solid var(--border);
}

footer>div {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

footer h3 {
    margin: 0;
    font-weight: inherit;
    font-size: 16px;
}

footer nav ul {
    list-style: none;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

footer nav ul>li:not(:first-child) {
    border-left: 2px solid var(--muted-accent);
    padding-left: 6px;
}

footer>div>*:nth-child(2n) {
    margin-left: auto;
    font-size: 10pt;
}

@media screen and (max-width: 480px) {
    header>div {
        flex-direction: column;
    }

    body {
        width: 100vw;
        box-sizing: border-box;
    }

    .posts>ul>li img {
        width: 100%;
        height: auto;
    }
}

@media screen and (min-width: 480px) {
    @supports (backdrop-filter: blur(20px)) {
        header {
            backdrop-filter: blur(20px);
        }
    }

    header {
        position: sticky;
        top: 0;
        right: 0;
        left: 0;
        z-index: 100;
    }

    .width-box {
        width: 100%;
        max-width: min(80vw, 840px);
    }
}</style>
    <link rel="alternate" type="application/rss+xml" href="/feed.xml">
</head>

<body>
    <header>
        <div class="width-box">
            <a class="icon-title" href="/">
                <h1 class="header-title">Ben's Engineering Blog</h1>
                <img draggable="true" src="/media/icon.png" width="256" height="256" alt="">
                
            </a>
            <nav>
                <ul>
                    <li><a href="/posts">Posts</a></li>
                    <li><a href="/about">About</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <main>
        
        <div class="width-box">
            <style>.post {
    display: flex;
    flex-direction: column;
}

.post>p,
.post li,
.post blockquote {
    line-height: 1.6em;
    margin: 6px 0;
    font-weight: inherit;
    font-family: "Inter", "Helvetica", sans-serif;
}

.post>*:is(h1, h2, h3, h4, h5) {
    margin: 12pt 0;
}

.post img,
.post video,
.post pre:not(.shiki) {
    margin: 20px 0;
}

.post pre.shiki {
    margin: 0;
}

/* Dark mode by default */
:root:not(.dark) .post img.invertible,
:root:not(.dark) .post video.invertible {
    filter: invert(1);
}

.post img {
    border-radius: 10px;
}

.post svg.icon {
    height: 1em;
    fill: var(--text-color);
}

.post span.line.highlight {
    font-weight: bold;
    background-color: var(--code-highlight);
    outline: 4px var(--code-highlight) solid;
}

.post .shiki-container {
    padding: 20px;
}

.post .math {
    margin: auto;
}

.post .math>svg {
    width: auto;
    height: 200%;
    margin: 10px;
}

.post .quote {
    font-style: italic;
}

.post .quote::before {
    content: '"';
}

.post .quote::after {
    content: '"';
}

.post *[role="caption"] {
    font-size: 14px;
    margin: 6px 0 20px;
    padding: 6px;
    text-align: center;
    font-weight: normal;
    opacity: 0.8;
}

.post time {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 11pt;
    font-family: monospace;
}

.post .center {
    text-align: center;
    font-weight: inherit;
    padding: 30px;
}

.post .note {
    font-style: italic;
    font-size: 12pt;
    opacity: 0.8;
}

*:is(h1, h2, h3, h4, h5, h6)>code {
    font-size: 0.8em;
}

*:is(h1, h2, h3, h4, h5, h6, p, li)>code {
    padding: 2px 6px;
}

/* For footnotes */
.post a[href^="#foot"] {
    font-family: monospace;
    position: relative;
    top: -5px;
    left: 2px;
}

.post #footnotes~* {
    font-size: 14px;
    margin: 4px 0;
    width: 100%;
}

video.small {
    max-height: 300px !important;
}

.callout {
    margin-top: 18px;
    padding: 20px;
    font-size: 15pt;
    background-color: var(--muted-background);
    border-radius: 16px;
    border: 3px solid var(--muted-accent);
}

.post h1.title {
    font-size: 40px;
}

.post h1 {
    font-size: 32px;
}

.post h2 {
    font-size: 28px;
}

.post h3 {
    font-size: 24px;
}

.post h4 {
    font-size: 20px;
}

.post h5 {
    font-size: 16px;
}

.post a.media-container>img {
    width: 100%;
}

.post table {
    border-spacing: 0;
    border-collapse: collapse;
    margin: 40px 0;
    /* max-width: 100%;
    overflow: scroll; */
}

.post table td,
.post table th {
    border: 2px solid var(--text-color);
    padding: 6px 8px;
    text-align: left;
}

.post blockquote {
    border-left: 4px solid var(--muted-accent);
    margin: 10px 0;
    padding: 5px 10px;
    background: var(--muted-background-opaque);
}

.post blockquote>p {
    margin: 0;
}

.post .widget {
    background: white;
    border-radius: 6px;
    padding: 50px;
    margin: 40px 0;
}

.discussions {
    margin: 80px 0px;
}

.parralel pre:not(.shiki) {
    font-size: 12px;
}

@media screen and (max-width: 480px) {
    .center {
        text-align: center;
        font-weight: inherit;
        padding: 10px 0px;
    }

    .post>p,
    .post li {
        font-size: 12pt;
        line-height: 1.4em;
    }

    .post img,
    .post pre,
    .post table,
    .post .widget,
    .post video {
        width: 100%;
        height: auto;
    }

    .post pre {
        overflow-x: auto;
    }
}

@media screen and (min-width: 480px) {
    .post>.parralel {
        display: flex;
        gap: 30px;
    }

    .post>.parralel>div {
        flex-grow: 1;
    }

    .post img,
    .post video,
    .post pre:not(.shiki) {
        align-self: center;
        height: auto;
    }

    .post>img,
    .post>video,
    .post table,
    .post .widget,
    .post>a.media-container,
    .post>.parralel,
    .post>pre:not(.shiki) {
        width: 105%;
        align-self: center;
    }
}

@media print {
    .post video {
        display: none;
    }
}</style>

<div class="post">
    <h1 class="title">Mapped types</h1>
    
    <time datetime="2024-11-27">
        Published on Wednesday 27<sup>th</sup> November 2024
        
    </time>
    
    <p>At the start of this year, I started implementing checking for <a href="https://www.typescriptlang.org/docs/handbook/2/mapped-types.html">TypeScript's mapped type feature</a>. I always had it in the back of my mind that this would be some of the hardest logic in TSC to re-implement. While I could have just skipped types using this mapped feature and treated them as <code>any</code>, I instead thought that having worked on some more realistic subtype and typed things, it would be an interesting challenge to get this complicated system verified by the Ezno type checker.</p>
<blockquote>
<p>For those who haven't heard of it before, the <a href="https://github.com/kaleidawave/ezno">Ezno</a> type checker is a work-in-progress but fast and correct TypeScript type checker and compiler with additional experiments.</p>
</blockquote>
<p>This post covers what mapped types are, a deep dive on generic checking and representing object types and finishes up covering some advanced property features that the type checker covers. You can read see an <a href="https://github.com/kaleidawave/ezno/blob/main/checker/specification/specification.md#mapped-types">overview the additions in the specification</a>.</p>
<blockquote>
<p>The Ezno type checker is built from the ground up. "Implementing" means getting <em>mostly</em> the same behaviour/output. No code or logic is copied from TSC. This post covers my approach to implementing mapped types, which may be different (or the same) as the TSC implementation. <a href="https://kaleidawave.github.io/ezno/comparison/">Infact there are many different behaviors in Ezno compared to TSC</a>.</p>
</blockquote>
<blockquote>
<p>Much like many of the things in checker, there are still edge cases and a few other things that don't quite work at the moment. If you find them, then feel free to <a href="https://github.com/kaleidawave/ezno/issues/new">raise an issue</a>.</p>
</blockquote>
<h2 id="the-basics-of-object-properties" tabindex="-1">The basics of object properties</h2>
<p>In TypeScript, we can define objects with <em>fixed</em> keys</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Event</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">id</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">time</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Date</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">formatDate</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">date</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Date</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9"> { </span><span style="color: #8B949E">/* ... */</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">renderEvent</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">event</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Event</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">`/events/${</span><span style="color: #C9D1D9">event</span><span style="color: #A5D6FF">.</span><span style="color: #C9D1D9">identifer</span><span style="color: #A5D6FF">}`</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">formattedDate</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">formatDate</span><span style="color: #C9D1D9">(event.name);</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">`&lt;a href="${</span><span style="color: #C9D1D9">url</span><span style="color: #A5D6FF">}"&gt;</span></span>
<span class="line"><span style="color: #A5D6FF">		${</span><span style="color: #C9D1D9">event</span><span style="color: #A5D6FF">.</span><span style="color: #C9D1D9">name</span><span style="color: #A5D6FF">} @ ${</span><span style="color: #C9D1D9">formattedDate</span><span style="color: #A5D6FF">}</span></span>
<span class="line"><span style="color: #A5D6FF">	&lt;/a&gt;`</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Event</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">name</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">time</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Date</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">formatDate</span><span style="color: #24292F">(</span><span style="color: #953800">date</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Date</span><span style="color: #24292F">)</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F"> { </span><span style="color: #6E7781">/* ... */</span><span style="color: #24292F"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">renderEvent</span><span style="color: #24292F">(</span><span style="color: #953800">event</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Event</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">url</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">`/events/${</span><span style="color: #24292F">event</span><span style="color: #0A3069">.</span><span style="color: #24292F">identifer</span><span style="color: #0A3069">}`</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">formattedDate</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">formatDate</span><span style="color: #24292F">(event.name);</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">return</span><span style="color: #24292F"> </span><span style="color: #0A3069">`&lt;a href="${</span><span style="color: #24292F">url</span><span style="color: #0A3069">}"&gt;</span></span>
<span class="line"><span style="color: #0A3069">		${</span><span style="color: #24292F">event</span><span style="color: #0A3069">.</span><span style="color: #24292F">name</span><span style="color: #0A3069">} @ ${</span><span style="color: #24292F">formattedDate</span><span style="color: #0A3069">}</span></span>
<span class="line"><span style="color: #0A3069">	&lt;/a&gt;`</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here we define a <code>Event</code> type with an object. We represent properties as a list of key-value pair tuples.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">properties </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [</span></span>
<span class="line"><span style="color: #C9D1D9">	(</span><span style="color: #A5D6FF">"id"</span><span style="color: #C9D1D9">,   </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">string</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	(</span><span style="color: #A5D6FF">"name"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">string</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	(</span><span style="color: #A5D6FF">"date"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">Date</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">  ),</span></span>
<span class="line"><span style="color: #C9D1D9">]</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">properties </span><span style="color: #CF222E">=</span><span style="color: #24292F"> [</span></span>
<span class="line"><span style="color: #24292F">	(</span><span style="color: #0A3069">"id"</span><span style="color: #24292F">,   </span><span style="color: #CF222E">*</span><span style="color: #24292F">string</span><span style="color: #CF222E">*</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	(</span><span style="color: #0A3069">"name"</span><span style="color: #24292F">, </span><span style="color: #CF222E">*</span><span style="color: #24292F">string</span><span style="color: #CF222E">*</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	(</span><span style="color: #0A3069">"date"</span><span style="color: #24292F">, </span><span style="color: #CF222E">*</span><span style="color: #0550AE">Date</span><span style="color: #CF222E">*</span><span style="color: #24292F">  ),</span></span>
<span class="line"><span style="color: #24292F">]</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>This representation of events is greatly simplified for now but will be built on later.</p>
</blockquote>
<p>There are several parts of the <code>renderEvent</code> function where we have to inspect the properties of <code>Event</code>.</p>
<p>First we see <code>event.identifer</code>. With this access expression we want to attempt to get the value associated with the <code>"identifier"</code> property key from the property list above. Finding the associate property value is quite straightforward to do in Rust using iterators.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> want_key </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"identifier"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> value </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> properties</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">rev</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">find_map</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">(key, value)</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span></span>
<span class="line"><span style="color: #C9D1D9">		(key </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> want_key)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">then_some</span><span style="color: #C9D1D9">(value)</span></span>
<span class="line"><span style="color: #C9D1D9">	);</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> want_key </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">"identifier"</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> value </span><span style="color: #CF222E">=</span><span style="color: #24292F"> properties</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">.</span><span style="color: #8250DF">iter</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">.</span><span style="color: #8250DF">rev</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">.</span><span style="color: #8250DF">find_map</span><span style="color: #24292F">(</span><span style="color: #CF222E">|</span><span style="color: #24292F">(key, value)</span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span></span>
<span class="line"><span style="color: #24292F">		(key </span><span style="color: #CF222E">==</span><span style="color: #24292F"> want_key)</span><span style="color: #CF222E">.</span><span style="color: #8250DF">then_some</span><span style="color: #24292F">(value)</span></span>
<span class="line"><span style="color: #24292F">	);</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>However, when we run the above, we do not find any property pair whose key (the first item in the pair) is <code>"identifier"</code>. From this we raise a type error.</p>
<blockquote>
<p>We also return <code>any</code> here, <a href="/posts/sets-types-and-type-checking/#short-circuiting-and-continuing-on-errors">so we can continue type checking</a>.</p>
</blockquote>
<p>Later on in the function we see <code>event.name</code> passed as an argument to <code>formatDate</code>. Again we run our search and this time it finds a key <code>== "time"</code>. The RHS value in this pair is the <code>string</code> type. As it used as argument we check it against the <code>date: Date</code> parameter of <code>formatDate</code> and therefore find another error as we cannot assign <code>string</code> to <code>Date</code>.</p>
<a href="https://kaleidawave.github.io/ezno/playground/?id=32i0aq" class="media-container"><img src="../../media/ezno-screenshots/basic-property-lookup-and-checking.png" alt="basic-property-lookup-and-checking"></a>
<p>Raising these type errors hints the programmer at how to correct the code. In this fixed version we can correct the access to use an actual property.</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">renderEvent</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">event</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Event</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">url</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">`/events/${</span><span style="color: #C9D1D9">event</span><span style="color: #A5D6FF">.</span><span style="color: #C9D1D9">id</span><span style="color: #A5D6FF">}`</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">formattedDate</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">formatDate</span><span style="color: #C9D1D9">(event.time);</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">`&lt;a href="${</span><span style="color: #C9D1D9">url</span><span style="color: #A5D6FF">}"&gt;</span></span>
<span class="line"><span style="color: #A5D6FF">		${</span><span style="color: #C9D1D9">event</span><span style="color: #A5D6FF">.</span><span style="color: #C9D1D9">name</span><span style="color: #A5D6FF">} @ ${</span><span style="color: #C9D1D9">formattedDate</span><span style="color: #A5D6FF">}</span></span>
<span class="line"><span style="color: #A5D6FF">	&lt;/a&gt;`</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">renderEvent</span><span style="color: #24292F">(</span><span style="color: #953800">event</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Event</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">url</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">`/events/${</span><span style="color: #24292F">event</span><span style="color: #0A3069">.</span><span style="color: #24292F">id</span><span style="color: #0A3069">}`</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">formattedDate</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">formatDate</span><span style="color: #24292F">(event.time);</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">return</span><span style="color: #24292F"> </span><span style="color: #0A3069">`&lt;a href="${</span><span style="color: #24292F">url</span><span style="color: #0A3069">}"&gt;</span></span>
<span class="line"><span style="color: #0A3069">		${</span><span style="color: #24292F">event</span><span style="color: #0A3069">.</span><span style="color: #24292F">name</span><span style="color: #0A3069">} @ ${</span><span style="color: #24292F">formattedDate</span><span style="color: #0A3069">}</span></span>
<span class="line"><span style="color: #0A3069">	&lt;/a&gt;`</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<h3 id="more-advanced-shapes-of-objects" tabindex="-1">More advanced shapes of objects</h3>
<p>This first example is relatively simple. However, keys can get more complex than this. For example the <code>Array</code> type has the <code>number</code> type as a property key.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; {</span></span>
<span class="line"><span style="color: #C9D1D9">	[number]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// ...</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">t</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// ...</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; {</span></span>
<span class="line"><span style="color: #24292F">	[number]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// ...</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #8250DF">push</span><span style="color: #24292F">(</span><span style="color: #953800">t</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">)</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// ...</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>There are some complications this brings</p>
<ul>
<li>This key is not singleton: many keys match to this property value <code>T</code>. e.g. We want <code>x[0]</code>, <code>x[5]</code> etc to both yield <code>T</code></li>
<li>This key is not a string: we have to do a bit analysis to see if the key matches the <code>number</code> type. <code>===</code> does not cut the mustard</li>
<li>Additionally we want to keep existing string key behaviour on the same type. Will still want accesses such as <code>x["push"]</code> to yield actual methods on the <code>Array</code> type.</li>
</ul>
<blockquote>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Working_with_objects#objects_and_properties">In JavaScript all keys are strings (or symbols)</a>. When we have a type here, it either depicts some generic, a string or something that coerces simple to a string (such as <code>number</code> and <code>boolean</code>).</p>
</blockquote>
<p>To support types as properties we need to expand the variants of key beyond a <code>String</code>.</p>
<pre><code class="language-diff"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FFA198">- type PropertyKey = String;</span></span>
<span class="line"><span style="color: #7EE787">+ enum PropertyKey&lt;'a&gt; {</span></span>
<span class="line"><span style="color: #7EE787">+     Constant(Cow&lt;'a, str&gt;),</span></span>
<span class="line"><span style="color: #7EE787">+     Type(TypeId)</span></span>
<span class="line"><span style="color: #7EE787">+ }</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #82071E">- type PropertyKey = String;</span></span>
<span class="line"><span style="color: #116329">+ enum PropertyKey&lt;'a&gt; {</span></span>
<span class="line"><span style="color: #116329">+     Constant(Cow&lt;'a, str&gt;),</span></span>
<span class="line"><span style="color: #116329">+     Type(TypeId)</span></span>
<span class="line"><span style="color: #116329">+ }</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>While we could have <code>PropertyKey = Constant(String) | NumberLike</code>. We will use the <code>TypeId</code> as it will handle more complex scenarios when we move on to the next part and further into mapped types.</p>
</blockquote>
<blockquote>
<p>We use <code>Cow&lt;'a, str&gt;</code> because we use the <code>PropertyKey</code> type in two places, one for storing properties where it <code>'static</code> (owned) and one for lookup where it uses an existing <code>&amp;'a str</code> slice from the AST. Using <code>Cow&lt;'a, str&gt;</code> instead of <code>String</code> makes it simple to reuse the definitions for both storage and lookup without cloning bytes unnecessarily (if we had a string member, we would have to <code>.to_owned()</code> on AST just to perform a byte equality).</p>
</blockquote>
<h3 id="generic-types-with-generic-property-keys" tabindex="-1">Generic types with generic property keys</h3>
<p>Now that property key can point to a <code>Type</code> (<code>TypeId</code> is a pointer to a <code>Type</code>) we can have a look at implementing the following <a href="https://www.typescriptlang.org/docs/handbook/utility-types.html#recordkeys-type"><code>Record</code> helper type</a>. A <code>Record</code> is object type who has keys of the type of generic <code>K</code> with values in generic <code>V</code>.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Record</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">K</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extends</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">V</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> { [</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">K</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">V</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Record</span><span style="color: #24292F">&lt;</span><span style="color: #953800">K</span><span style="color: #24292F"> </span><span style="color: #CF222E">extends</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">, </span><span style="color: #953800">V</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> { [</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #953800">K</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">V</span><span style="color: #24292F"> }</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here the <code>Record</code> type is represented in the system as a type alias with two generic parameters and a <em>single</em> properties with the pairing <code>(PropertyKey::Type(*K*), *V*)</code>. In this pseudo-representation.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">Record </span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">100</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Type</span><span style="color: #C9D1D9">::Alias {</span></span>
<span class="line"><span style="color: #C9D1D9">	name </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"Record"</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	parameters </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">Some</span><span style="color: #C9D1D9">([ </span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #8B949E">// 5 is type id string</span></span>
<span class="line"><span style="color: #C9D1D9">		(</span><span style="color: #A5D6FF">"K"</span><span style="color: #C9D1D9"> extends </span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">, id</span><span style="color: #FF7B72">=*</span><span style="color: #79C0FF">101</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">), </span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #8B949E">// 1 is type id any/unknown. </span></span>
<span class="line"><span style="color: #C9D1D9">		(</span><span style="color: #A5D6FF">"V"</span><span style="color: #C9D1D9"> extends </span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">1</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">, id</span><span style="color: #FF7B72">=*</span><span style="color: #79C0FF">102</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">) </span></span>
<span class="line"><span style="color: #C9D1D9">	])</span></span>
<span class="line"><span style="color: #C9D1D9">	value </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Type</span><span style="color: #C9D1D9">::</span><span style="color: #D2A8FF">AnonomousObjectLiteral</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">		[</span></span>
<span class="line"><span style="color: #C9D1D9">			(</span></span>
<span class="line"><span style="color: #C9D1D9">				</span><span style="color: #8B949E">// key of type K</span></span>
<span class="line"><span style="color: #C9D1D9">				PropertyKey::</span><span style="color: #D2A8FF">Type</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">101</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">), </span></span>
<span class="line"><span style="color: #C9D1D9">				</span><span style="color: #8B949E">// value of type V</span></span>
<span class="line"><span style="color: #C9D1D9">				</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">102</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">			)</span></span>
<span class="line"><span style="color: #C9D1D9">		]</span></span>
<span class="line"><span style="color: #C9D1D9">	)</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">Record </span><span style="color: #CF222E">*</span><span style="color: #0550AE">100</span><span style="color: #CF222E">*</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Type</span><span style="color: #24292F">::Alias {</span></span>
<span class="line"><span style="color: #24292F">	name </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">"Record"</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	parameters </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #8250DF">Some</span><span style="color: #24292F">([ </span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #6E7781">// 5 is type id string</span></span>
<span class="line"><span style="color: #24292F">		(</span><span style="color: #0A3069">"K"</span><span style="color: #24292F"> extends </span><span style="color: #CF222E">*</span><span style="color: #0550AE">5</span><span style="color: #CF222E">*</span><span style="color: #24292F">, id</span><span style="color: #CF222E">=*</span><span style="color: #0550AE">101</span><span style="color: #CF222E">*</span><span style="color: #24292F">), </span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #6E7781">// 1 is type id any/unknown. </span></span>
<span class="line"><span style="color: #24292F">		(</span><span style="color: #0A3069">"V"</span><span style="color: #24292F"> extends </span><span style="color: #CF222E">*</span><span style="color: #0550AE">1</span><span style="color: #CF222E">*</span><span style="color: #24292F">, id</span><span style="color: #CF222E">=*</span><span style="color: #0550AE">102</span><span style="color: #CF222E">*</span><span style="color: #24292F">) </span></span>
<span class="line"><span style="color: #24292F">	])</span></span>
<span class="line"><span style="color: #24292F">	value </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Type</span><span style="color: #24292F">::</span><span style="color: #8250DF">AnonomousObjectLiteral</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">		[</span></span>
<span class="line"><span style="color: #24292F">			(</span></span>
<span class="line"><span style="color: #24292F">				</span><span style="color: #6E7781">// key of type K</span></span>
<span class="line"><span style="color: #24292F">				PropertyKey::</span><span style="color: #8250DF">Type</span><span style="color: #24292F">(</span><span style="color: #CF222E">*</span><span style="color: #0550AE">101</span><span style="color: #CF222E">*</span><span style="color: #24292F">), </span></span>
<span class="line"><span style="color: #24292F">				</span><span style="color: #6E7781">// value of type V</span></span>
<span class="line"><span style="color: #24292F">				</span><span style="color: #CF222E">*</span><span style="color: #0550AE">102</span><span style="color: #CF222E">*</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">			)</span></span>
<span class="line"><span style="color: #24292F">		]</span></span>
<span class="line"><span style="color: #24292F">	)</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Now with our type we can instate it with some specific types. Let's say we are getting some data from an API which returns JSON. Once we have parsed the JSON we know from some assumptions that the results are <code>number</code>. So we have a <code>Record&lt;string, number&gt;</code>. We represent this using a <a href="/posts/sets-types-and-type-checking/#partially-applied-generics">partially applied generic</a>.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">Record</span><span style="color: #FF7B72">&lt;</span><span style="color: #C9D1D9">string, number</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Type</span><span style="color: #C9D1D9">::PartiallyAppliedGeneric {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">on</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">100</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #8B949E">// Record type without generic arguments</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">arguments</span><span style="color: #C9D1D9">: [</span></span>
<span class="line"><span style="color: #C9D1D9">		(</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">101</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">5</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">), </span><span style="color: #8B949E">// K = string</span></span>
<span class="line"><span style="color: #C9D1D9">		(</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">102</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">4</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">), </span><span style="color: #8B949E">// V = number</span></span>
<span class="line"><span style="color: #C9D1D9">	]</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">Record</span><span style="color: #CF222E">&lt;</span><span style="color: #24292F">string, number</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">Type</span><span style="color: #24292F">::PartiallyAppliedGeneric {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">on</span><span style="color: #24292F">: </span><span style="color: #CF222E">*</span><span style="color: #0550AE">100</span><span style="color: #CF222E">*</span><span style="color: #24292F"> </span><span style="color: #6E7781">// Record type without generic arguments</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">arguments</span><span style="color: #24292F">: [</span></span>
<span class="line"><span style="color: #24292F">		(</span><span style="color: #CF222E">*</span><span style="color: #0550AE">101</span><span style="color: #CF222E">*</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">*</span><span style="color: #0550AE">5</span><span style="color: #CF222E">*</span><span style="color: #24292F">), </span><span style="color: #6E7781">// K = string</span></span>
<span class="line"><span style="color: #24292F">		(</span><span style="color: #CF222E">*</span><span style="color: #0550AE">102</span><span style="color: #CF222E">*</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">*</span><span style="color: #0550AE">4</span><span style="color: #CF222E">*</span><span style="color: #24292F">), </span><span style="color: #6E7781">// V = number</span></span>
<span class="line"><span style="color: #24292F">	]</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>A <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map"><code>Map</code></a> would be a better data structure to use here, but we are doing working in the bounds of JavaScript with the untransformed output of <code>JSON.parse</code>.</p>
</blockquote>
<blockquote>
<p>During instantiation we also check that the first type argument <code>string</code> extends <code>string</code> (obviously holds as <a href="/posts/sets-types-and-type-checking/#the-details">subtyping is a reflexive relation</a>)</p>
</blockquote>
<p>Using the partially applied generic, we don't create a whole new object and substitute values, we just pair the <code>Record</code> <em>template</em> with some values.</p>
<blockquote>
<p>This step is exactly the same as regular generic objects, nothing new for mapped types just yet.</p>
</blockquote>
<h3 id="recording-generics-with-the-generic-chain" tabindex="-1">Recording generics with the generic chain</h3>
<p>Before we can understand how we can access property keys that are generic types, will take a short deep dive into how reading the wrapped generics works.</p>
<p>We know that <code>Box&lt;number&gt;</code> is a pairing of the <code>Box</code> type with a map of type arguments to type parameters (e.g. <code>Box&lt;number&gt; = (Box, T = number)</code>). When we get a property from this type, we split off the generic arguments and store them in a table. We then look for the property on the <em>naked</em> generic type. If we find a value here we return it with the current chain table. For the following</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; { </span><span style="color: #FFA657">inner</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">getInner</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">box</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">&gt;) {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> box.inner</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">Box</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; { </span><span style="color: #953800">inner</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">getInner</span><span style="color: #24292F">(</span><span style="color: #953800">box</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Box</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">number</span><span style="color: #24292F">&gt;) {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">return</span><span style="color: #24292F"> box.inner</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>The process is something like</p>
<ul>
<li>We start by requesting the <code>"inner"</code> property on <code>Box&lt;number&gt;</code></li>
<li>We unfold the type arguments and so we now look for <code>"inner"</code> on <code>Box</code> with <code>substitutions: [(T, number)]</code>.</li>
<li>In this example <code>"inner"</code> <strong>does</strong> exist on <code>Box</code> so we return <code>Logical::Implies { result: PropertyValue::Value(T), substitutions }</code> where we also send our <code>substitutions</code> chain with the result</li>
<li>After lookup we found a valid result <code>T</code>. We find there are some substitutions we scan <code>T</code> and follow any lookups from the <code>substitutions: [(T, number)]</code> list.</li>
<li>We find a <code>T</code> can be substituted with <code>number</code> and so return <code>number</code></li>
</ul>
<blockquote>
<p>We return a <code>Logical::Implies</code> adjoined with substitutions in a middle step because it works better in Rust's borrow checking. While in this case the substitution was a simple swap, in other cases we need to register new types and is easiest to create new types (mutate the store) only <strong>after</strong> the traversal of current types has finished.</p>
</blockquote>
<h3 id="subtyping-with-generics" tabindex="-1">Subtyping with generics</h3>
<p>Above we used the <code>GenericChain</code> for lookup. We also use this structure for subtyping of generic items.</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; { </span><span style="color: #FFA657">inner</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">numbers</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> { inner: </span><span style="color: #A5D6FF">"not number"</span><span style="color: #C9D1D9"> };</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">Box</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; { </span><span style="color: #953800">inner</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">numbers</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Box</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">number</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> { inner: </span><span style="color: #0A3069">"not number"</span><span style="color: #24292F"> };</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>When checking (subtyping) the following happens with the table. (each line <em>somewhat</em> represents call to the <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/types/subtyping.rs#L221"><code>is_subtype</code> function</a>)</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">Box</span><span style="color: #FF7B72">&lt;</span><span style="color: #C9D1D9">number</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9">                            :</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> { inner: </span><span style="color: #A5D6FF">"not number"</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">// Unfold the `number` argument</span></span>
<span class="line"><span style="color: #C9D1D9">{ </span><span style="color: #FFA657">inner</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> }         (with </span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> number) :</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> { inner: </span><span style="color: #A5D6FF">"not number"</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">// iterating over properties on the LHS. We only have `inner` property</span></span>
<span class="line"><span style="color: #C9D1D9">{ </span><span style="color: #FFA657">inner</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> }.</span><span style="color: #D2A8FF">inner</span><span style="color: #C9D1D9">   (with </span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> number) :</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> { inner: </span><span style="color: #A5D6FF">"not number"</span><span style="color: #C9D1D9"> }.inner</span></span>
<span class="line"><span style="color: #D2A8FF">T</span><span style="color: #C9D1D9">                    (with </span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> number) :</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"not number"</span></span>
<span class="line"><span style="color: #8B949E">// Replace T with number here using this chain</span></span>
<span class="line"><span style="color: #D2A8FF">number</span><span style="color: #C9D1D9">               (with </span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> number) :</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"not number"</span><span style="color: #C9D1D9"> </span><span style="color: #8B949E">// &lt;- subtyping returns here</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">Box</span><span style="color: #CF222E">&lt;</span><span style="color: #24292F">number</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F">                            :</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> { inner: </span><span style="color: #0A3069">"not number"</span><span style="color: #24292F"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">// Unfold the `number` argument</span></span>
<span class="line"><span style="color: #24292F">{ </span><span style="color: #953800">inner</span><span style="color: #24292F">: </span><span style="color: #0550AE">T</span><span style="color: #24292F"> }         (with </span><span style="color: #0550AE">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> number) :</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> { inner: </span><span style="color: #0A3069">"not number"</span><span style="color: #24292F"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">// iterating over properties on the LHS. We only have `inner` property</span></span>
<span class="line"><span style="color: #24292F">{ </span><span style="color: #953800">inner</span><span style="color: #24292F">: </span><span style="color: #0550AE">T</span><span style="color: #24292F"> }.</span><span style="color: #8250DF">inner</span><span style="color: #24292F">   (with </span><span style="color: #0550AE">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> number) :</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> { inner: </span><span style="color: #0A3069">"not number"</span><span style="color: #24292F"> }.inner</span></span>
<span class="line"><span style="color: #8250DF">T</span><span style="color: #24292F">                    (with </span><span style="color: #0550AE">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> number) :</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> </span><span style="color: #0A3069">"not number"</span></span>
<span class="line"><span style="color: #6E7781">// Replace T with number here using this chain</span></span>
<span class="line"><span style="color: #8250DF">number</span><span style="color: #24292F">               (with </span><span style="color: #0550AE">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> number) :</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> </span><span style="color: #0A3069">"not number"</span><span style="color: #24292F"> </span><span style="color: #6E7781">// &lt;- subtyping returns here</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>In the above we see that the LHS unfolds its generics and so we can reduce them out to checking on the <em>leaves</em>.</p>
<blockquote>
<p>Note the RHS can also produce a table if it is generic.</p>
</blockquote>
<p>In the above example I simplified <code>substitutions</code> to just be a list. In the actual code this is called <code>GenericChain</code> and is a linked list of substitution lists. This allows it to do nested generics. So the following is valid.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">parent</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">null</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">inner</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">myBox</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> { parent: { parent: </span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">, inner: </span><span style="color: #79C0FF">6</span><span style="color: #C9D1D9"> }, inner: </span><span style="color: #A5D6FF">"heya"</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">Box</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">parent</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Box</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">number</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #0550AE">null</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">inner</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">myBox</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Box</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">string</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> { parent: { parent: </span><span style="color: #0550AE">null</span><span style="color: #24292F">, inner: </span><span style="color: #0550AE">6</span><span style="color: #24292F"> }, inner: </span><span style="color: #0A3069">"heya"</span><span style="color: #24292F"> }</span></span>
<span class="line"></span></code></pre></div></code></pre>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #8B949E">// Checking</span></span>
<span class="line"><span style="color: #C9D1D9">Box</span><span style="color: #FF7B72">&lt;</span><span style="color: #C9D1D9">string</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9">                            :</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> { </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"><span style="color: #C9D1D9">{ </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">with</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> string)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">{ </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">with</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> string) (</span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> number) :</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> { </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"><span style="color: #79C0FF">T</span><span style="color: #C9D1D9">       </span><span style="color: #FF7B72">with</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> string) (</span><span style="color: #79C0FF">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> number) :</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">6</span></span>
<span class="line"><span style="color: #8B949E">// We pick the first from the right</span></span>
<span class="line"><span style="color: #FFA657">number</span><span style="color: #C9D1D9">                                 :</span><span style="color: #FF7B72">&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">6</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #6E7781">// Checking</span></span>
<span class="line"><span style="color: #24292F">Box</span><span style="color: #CF222E">&lt;</span><span style="color: #24292F">string</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F">                            :</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> { </span><span style="color: #CF222E">...</span><span style="color: #24292F"> }</span></span>
<span class="line"><span style="color: #24292F">{ </span><span style="color: #CF222E">...</span><span style="color: #24292F"> } </span><span style="color: #CF222E">with</span><span style="color: #24292F"> (</span><span style="color: #0550AE">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> string)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">{ </span><span style="color: #CF222E">...</span><span style="color: #24292F"> } </span><span style="color: #CF222E">with</span><span style="color: #24292F"> (</span><span style="color: #0550AE">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> string) (</span><span style="color: #0550AE">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> number) :</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> { </span><span style="color: #CF222E">...</span><span style="color: #24292F"> }</span></span>
<span class="line"><span style="color: #0550AE">T</span><span style="color: #24292F">       </span><span style="color: #CF222E">with</span><span style="color: #24292F"> (</span><span style="color: #0550AE">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> string) (</span><span style="color: #0550AE">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> number) :</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">6</span></span>
<span class="line"><span style="color: #6E7781">// We pick the first from the right</span></span>
<span class="line"><span style="color: #953800">number</span><span style="color: #24292F">                                 :</span><span style="color: #CF222E">&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">6</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>Additionally <code>GenericChain</code> uses lifetimes of arguments rather than cloning lists (and thus allocating).</p>
</blockquote>
<h3 id="testing-generic-keys" tabindex="-1">Testing generic keys</h3>
<p>Given we now have these generics basics out of the way, we have to define what these type representations contain.</p>
<p>It starts to get more complicated for type keys. One case of this is the <code>Array</code> type. As previously stated the <code>Array</code> type has a numeric property and for this we can't really use equality. :/</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FFA657">PropertyKey</span><span style="color: #C9D1D9">::</span><span style="color: #D2A8FF">Type</span><span style="color: #C9D1D9">(TypeId::</span><span style="color: #79C0FF">NUMBER_TYPE</span><span style="color: #C9D1D9">) </span></span>
<span class="line"><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PropertyKey</span><span style="color: #C9D1D9">::</span><span style="color: #79C0FF">String</span><span style="color: #C9D1D9">(Cow::</span><span style="color: #D2A8FF">Borrowed</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"1"</span><span style="color: #C9D1D9">))</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #953800">PropertyKey</span><span style="color: #24292F">::</span><span style="color: #8250DF">Type</span><span style="color: #24292F">(TypeId::</span><span style="color: #0550AE">NUMBER_TYPE</span><span style="color: #24292F">) </span></span>
<span class="line"><span style="color: #24292F">  </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #953800">PropertyKey</span><span style="color: #24292F">::</span><span style="color: #0550AE">String</span><span style="color: #24292F">(Cow::</span><span style="color: #8250DF">Borrowed</span><span style="color: #24292F">(</span><span style="color: #0A3069">"1"</span><span style="color: #24292F">))</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>So instead we need to make a special function for key validity that we can put into the lookup function.</p>
<p>This is where the complications start. While we could use <code>type_is_subtype</code> we don't have two <code>TypeId</code>s as we sometimes have a <code>PropertyKey::String</code> on a side. We also have a problem in the above example. <code>"1"</code> is string not a number, so we have to add catch for the implicit conversion JavaScript when assigning and reading properties with keys that are numbers.</p>
<p>Unfortunately we do have a have some duplication of some logic but we have a function like</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">key_matches</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">	base</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PropertyKey</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	want</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PropertyKey</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">bool</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #8B949E">	// simple case</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">String</span><span style="color: #C9D1D9">(base), </span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">String</span><span style="color: #C9D1D9">(want))</span></span>
<span class="line"><span style="color: #C9D1D9">	) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (base, want) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> base </span><span style="color: #FF7B72">==</span><span style="color: #C9D1D9"> want</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">	// catch for number</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Type</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">TypeId</span><span style="color: #FF7B72">::</span><span style="color: #79C0FF">NUMBER_TYPE</span><span style="color: #C9D1D9">), </span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">String</span><span style="color: #C9D1D9">(want)</span></span>
<span class="line"><span style="color: #C9D1D9">	) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (base, want) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> want</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">parse</span><span style="color: #FF7B72">::</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">usize</span><span style="color: #C9D1D9">&gt;()</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_ok</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8B949E">	// delegate to regular subtyping</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Type</span><span style="color: #C9D1D9">(base), </span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Type</span><span style="color: #C9D1D9">(want)</span></span>
<span class="line"><span style="color: #C9D1D9">	) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (base, want) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">type_is_subtype</span><span style="color: #C9D1D9">(base, want)</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_subtype</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">key_matches</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">	base</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">PropertyKey</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	want</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">PropertyKey</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #953800">bool</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #6E7781">	// simple case</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> (</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">String</span><span style="color: #24292F">(base), </span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">String</span><span style="color: #24292F">(want))</span></span>
<span class="line"><span style="color: #24292F">	) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> (base, want) {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">return</span><span style="color: #24292F"> base </span><span style="color: #CF222E">==</span><span style="color: #24292F"> want</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">	// catch for number</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">let</span><span style="color: #24292F"> (</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Type</span><span style="color: #24292F">(</span><span style="color: #953800">TypeId</span><span style="color: #CF222E">::</span><span style="color: #0550AE">NUMBER_TYPE</span><span style="color: #24292F">), </span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">String</span><span style="color: #24292F">(want)</span></span>
<span class="line"><span style="color: #24292F">	) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> (base, want) {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">return</span><span style="color: #24292F"> want</span><span style="color: #CF222E">.</span><span style="color: #8250DF">parse</span><span style="color: #CF222E">::</span><span style="color: #24292F">&lt;</span><span style="color: #953800">usize</span><span style="color: #24292F">&gt;()</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_ok</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6E7781">	// delegate to regular subtyping</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">let</span><span style="color: #24292F"> (</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Type</span><span style="color: #24292F">(base), </span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Type</span><span style="color: #24292F">(want)</span></span>
<span class="line"><span style="color: #24292F">	) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> (base, want) {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">return</span><span style="color: #24292F"> </span><span style="color: #8250DF">type_is_subtype</span><span style="color: #24292F">(base, want)</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_subtype</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>Full <code>key_matches</code> function <a href="https://github.com/kaleidawave/ezno/blob/e6f6ffd7cb48285cdaaf7e57e4d636bbaf038b03/checker/src/types/subtyping.rs#L2460-L2462">here</a></p>
</blockquote>
<blockquote>
<p>We could create <code>PartialEq</code> implementation but 1) it is not equality, as it involves subtyping and 2) as we will see in a minute this function will start to take a few more parameters and as we are only fixed to LHS and RHS parameters in <code>PartialEq::eq</code> we will we use a function instead</p>
</blockquote>
<h4 id="passing-generics-through-key_matches" tabindex="-1">Passing generics through <code>key_matches</code></h4>
<p>In our initial <code>Record</code> example we have a key that is a generic parameter. With the above we have a problem as we do subtyping on <code>K</code> but we don't have a value for <code>K</code>. Our <code>key_matches</code> function isn't aware of type parameters.</p>
<p>So we modify <code>key_matches</code> function to allow generic arguments down. This base generics will contain a list which has the <code>K=string</code> pair in. When we do subtyping we find a <code>K</code> on the LHS, and using our list we pass down, <a href="https://github.com/kaleidawave/ezno/blob/e6f6ffd7cb48285cdaaf7e57e4d636bbaf038b03/checker/src/types/subtyping.rs#L2500">we look up the argument for <code>K</code></a> and find <code>string</code>. Therefore if <code>want</code> is a string like property key then the <code>key_matches</code> function returns in this example <code>true</code>!</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">fn</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">key_matches</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">	(base, base_generics)</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">PropertyKey</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">GenericChain</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">	(want, want_generics)</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">PropertyKey</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">GenericChain</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">bool</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #8B949E">	// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Type</span><span style="color: #C9D1D9">(base), </span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Type</span><span style="color: #C9D1D9">(want)) </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (base, want) {</span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">type_is_subtype</span><span style="color: #C9D1D9">((base, base_generics), (want, want_generics))</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">is_subtype</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">	}</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">fn</span><span style="color: #24292F"> </span><span style="color: #8250DF">key_matches</span><span style="color: #24292F">(</span></span>
<span class="line"><span style="color: #24292F">	(base, base_generics)</span><span style="color: #CF222E">:</span><span style="color: #24292F"> (</span><span style="color: #953800">PropertyKey</span><span style="color: #24292F">, </span><span style="color: #953800">GenericChain</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">	(want, want_generics)</span><span style="color: #CF222E">:</span><span style="color: #24292F"> (</span><span style="color: #953800">PropertyKey</span><span style="color: #24292F">, </span><span style="color: #953800">GenericChain</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">) </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #953800">bool</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #6E7781">	// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">let</span><span style="color: #24292F"> (</span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Type</span><span style="color: #24292F">(base), </span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Type</span><span style="color: #24292F">(want)) </span><span style="color: #CF222E">=</span><span style="color: #24292F"> (base, want) {</span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #CF222E">return</span><span style="color: #24292F"> </span><span style="color: #8250DF">type_is_subtype</span><span style="color: #24292F">((base, base_generics), (want, want_generics))</span><span style="color: #CF222E">.</span><span style="color: #8250DF">is_subtype</span><span style="color: #24292F">();</span></span>
<span class="line"><span style="color: #24292F">	}</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>When this returns <code>true</code> we now have the following lookup. As it returns true, we yield the value and this in turn is returned with the chain so that we can substitute values in.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #8B949E">// From `Record&lt;string, number&gt;`</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> base_generic_chain </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">[(</span><span style="color: #FFA657">K</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">TypeId</span><span style="color: #FF7B72">::</span><span style="color: #79C0FF">STRING_TYPE</span><span style="color: #C9D1D9">), (</span><span style="color: #FFA657">V</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">TypeId</span><span style="color: #FF7B72">::</span><span style="color: #79C0FF">NUMBER_TYPE</span><span style="color: #C9D1D9">)]</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> want_key </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">String</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">Cow</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Borrowed</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"something"</span><span style="color: #C9D1D9">));</span></span>
<span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> value </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> base_properties</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">iter</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">rev</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">find_map</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">(key, value)</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span></span>
<span class="line"><span style="color: #C9D1D9">		</span><span style="color: #D2A8FF">key_matches</span><span style="color: #C9D1D9">((key, base_generic_chain), (want_key, </span><span style="color: #FFA657">None</span><span style="color: #C9D1D9">))</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">then_some</span><span style="color: #C9D1D9">(value)</span></span>
<span class="line"><span style="color: #C9D1D9">	);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> value</span><span style="color: #FF7B72">.</span><span style="color: #D2A8FF">map</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9">value</span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Result</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	 value,</span></span>
<span class="line"><span style="color: #C9D1D9">	 substitutions</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> base_generic_chain</span></span>
<span class="line"><span style="color: #C9D1D9">})</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #6E7781">// From `Record&lt;string, number&gt;`</span></span>
<span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> base_generic_chain </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #CF222E">*</span><span style="color: #24292F">[(</span><span style="color: #953800">K</span><span style="color: #24292F">, </span><span style="color: #953800">TypeId</span><span style="color: #CF222E">::</span><span style="color: #0550AE">STRING_TYPE</span><span style="color: #24292F">), (</span><span style="color: #953800">V</span><span style="color: #24292F">, </span><span style="color: #953800">TypeId</span><span style="color: #CF222E">::</span><span style="color: #0550AE">NUMBER_TYPE</span><span style="color: #24292F">)]</span><span style="color: #CF222E">*</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> want_key </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">String</span><span style="color: #24292F">(</span><span style="color: #953800">Cow</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Borrowed</span><span style="color: #24292F">(</span><span style="color: #0A3069">"something"</span><span style="color: #24292F">));</span></span>
<span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> value </span><span style="color: #CF222E">=</span><span style="color: #24292F"> base_properties</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">.</span><span style="color: #8250DF">iter</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">.</span><span style="color: #8250DF">rev</span><span style="color: #24292F">()</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">.</span><span style="color: #8250DF">find_map</span><span style="color: #24292F">(</span><span style="color: #CF222E">|</span><span style="color: #24292F">(key, value)</span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span></span>
<span class="line"><span style="color: #24292F">		</span><span style="color: #8250DF">key_matches</span><span style="color: #24292F">((key, base_generic_chain), (want_key, </span><span style="color: #953800">None</span><span style="color: #24292F">))</span><span style="color: #CF222E">.</span><span style="color: #8250DF">then_some</span><span style="color: #24292F">(value)</span></span>
<span class="line"><span style="color: #24292F">	);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">return</span><span style="color: #24292F"> value</span><span style="color: #CF222E">.</span><span style="color: #8250DF">map</span><span style="color: #24292F">(</span><span style="color: #CF222E">|</span><span style="color: #24292F">value</span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #953800">Result</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	 value,</span></span>
<span class="line"><span style="color: #24292F">	 substitutions</span><span style="color: #CF222E">:</span><span style="color: #24292F"> base_generic_chain</span></span>
<span class="line"><span style="color: #24292F">})</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>This is how <code>Record&lt;string, numbers&gt;</code> works. It isn't quite a mapped type yet, but hopefully you have a bit more of an understanding of generics to see how this works now.</p>
<blockquote>
<p>Additionally I hope you can see why the properties are stored as a <code>Vec</code> here (rather than a <code>HashMap</code>). Not only is it a little overkill for the average &lt; 10 key based object. There isn't a simple hash and equality relation for when keys based on types are in the picture.</p>
</blockquote>
<h2 id="on-to-mapped-keys" tabindex="-1">On to mapped keys</h2>
<h3 id="real-mapped-types" tabindex="-1">Real mapped types</h3>
<p>So far we have covered constant keys and keys that are passed from above via a generic.</p>
<h3 class="center"><p>(real) Mapped types are when the property value is based on the type of a property key.</p>
</h3>
<p>We do this using the <code>[ParameterName in ...]: Value</code> syntax for a property. Here <code>ParameterName</code> is a new generic parameter (similar to that on functions or interfaces). It is can be used as a value in the <code>Value</code> type annotation.</p>
<p>For example, in the following we build a type that <em>maps</em> over the keys of <code>Event</code> and builds a <strong>new</strong> type where each field might be <code>null</code>. We can see it uses type <code>P</code> as a inline property generic. We use <code>in</code> to say it must extend the type <code>keyof Event</code> (covered more in a minute). We use this generic <code>P</code> in the property value to depict the result is the associate value of <code>Event[P]</code>.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Event</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">id</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">name</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">time</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Date</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">EventButFieldsPossiblyNull</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Event</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Event</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">null</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Event</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">name</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">time</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Date</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">EventButFieldsPossiblyNull</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	[</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">Event</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Event</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">] </span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #0550AE">null</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>We have <strong>mapped</strong> each property to a new value using <code>P</code> as a parameter.</p>
<p>This practise is normally parameterised and used for utility types.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TButFieldsPossiblyNull</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">|</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">null</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">TButFieldsPossiblyNull</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	[</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">] </span><span style="color: #CF222E">|</span><span style="color: #24292F"> </span><span style="color: #0550AE">null</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>They are a niche feature, but like many other abstractions they can be useful when</p>
<ul>
<li>Don't want to copy out definitions of existing items</li>
<li>Keeping definitions up-to date/inline within related definitions</li>
<li>Working on top of definitions we don't own (external or generated etc)</li>
</ul>
<blockquote>
<p>Again this partial applied. "creating" a mapped type does not walk the properties, it just creates a partially applied generic. This reduces overhead on instantiation, but moves complexity to usage and means that each usage has to do some work.</p>
</blockquote>
<h4 id="important-functionality%3A-inferring-type-argument-values" tabindex="-1">Important functionality: Inferring type argument values</h4>
<p>Before talking about the access part. I will talk about a new kind <strong>kind</strong> of generic recording. We previously saw how type arguments on a structure are passed down through access and subtyping with <code>GenericChain</code> the table like structure.</p>
<p>There are cases where we have a generic but don't have a value for it. Instead we need to <strong>infer its value based on usage</strong>. This is where <code>Contributions</code> comes in.</p>
<p>For example given the function</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">declare</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">idString</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extends</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">&gt;(</span><span style="color: #FFA657">t</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">)</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">declare</span><span style="color: #24292F"> </span><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">idString</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">extends</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">&gt;(</span><span style="color: #953800">t</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">)</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">;</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>When we call it with <code>idString("Hello World")</code> we want to find a type for this expression and this requires knowing figuring out the returned type. In this example we need to infer <code>T</code> to have the value <code>"Hello World"</code>, which we will then use to substitute as the return type.</p>
<p>The implementation to do lies in <s>making</s> subtyping <s>more complex</s>. When we call a function we subtype each argument value against its respective parameter type. In this case we run <code>(T extends string) :&gt; "Hello World"</code>. The inner steps are as follows</p>
<ul>
<li>We find that the LHS <code>T</code> is a (substitutable) generic parameter</li>
<li><strong>We find that it does not have a value in the LHS <code>GenericChain</code> so continue to subtype the generic</strong> (there is no <code>GenericChain</code> in this example).</li>
<li>We also do not find for this <code>FunctionGeneric</code> that there is a explicit call side type argument in <code>state.call_site_type_arguments</code> so continue to subtype the generic</li>
<li>For generics <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/types/subtyping.rs#L615-L620">we check the extends constraint</a> (if there was no extends annotation, this annotation would extend <code>any</code> and so this check always passes)</li>
<li>We find the constraint check passed (<code>"Hello World"</code> does indeed extend <code>string</code>!)</li>
<li>The important part: take our LHS generic type <code>T</code> and RHS type <code>"Hello World"</code> and <strong>we append <code>T="Hello World"</code> as a tuple pair into the <code>contributions</code> list in state</strong>. Something like <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/types/subtyping.rs#L628-L629"><code>contributions.push((lhs, rhs))</code></a>.</li>
</ul>
<blockquote>
<p><code>Contributions</code> is inside the <code>subtyping::State</code> structure which is passed through the <code>is_subtype</code> function (as well as the generic chains).</p>
</blockquote>
<blockquote>
<p>There are some fun details with contributions such as dropping cases with union types when a branch fails. We can also see that through the <code>NoInfer</code> intrinsic the results are dropped. This is why they are internally held as <code>Vec</code> because that is easy to drop ranges from as it is ordered.</p>
</blockquote>
<p>By doing it this way it allows inference to be done in the same <em>scan</em> by the type checker. Although this if faster and simpler, it does have <em>complications</em> (not impossible though) for inference that uses parameters before a value to the right has been checked and inferred.</p>
<h4 id="mapped-keys%3A-the-identity-key-case" tabindex="-1">Mapped keys: The identity key case</h4>
<p>After you have passed inference 101 above, you should be good to go for getting you head around how mapped types work.</p>
<p>We will start of with the <em>identity</em> mapped type.</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">IdOnKeys</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> { [</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> }</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">IdOnKeys</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> { [</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">P</span><span style="color: #24292F"> }</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>When accessing <code>["a"]</code> it goes through the steps outlined above</p>
<ul>
<li>First as one of the side is <code>key_matches</code> it goes to subtype (or something like subtyping),</li>
<li>There is no value for <code>P</code> in the <code>GenericChain</code> (it is not passed from above and also it is marked as a <code>MappedGeneric</code> type) so we go to generic contributions</li>
<li><code>P in string</code> implies <code>P extends string</code> and we have that <code>"a"</code> is a string so we continue</li>
<li>In this case we add <code>P = "a"</code> to the contributions! The argument for generic parameter <code>P</code> is inferred to be the type <code>"a"</code></li>
</ul>
<p>Now we have our pairing we need to make the access aware of this value. To do this we expand on our <code>GenericChain</code> table and pass <code>*[(P, "a")]*</code> to the value resolution.</p>
<a href="https://kaleidawave.github.io/ezno/playground/?id=2hwcga" class="media-container"><img src="../../media/ezno-screenshots/identity-mapped-type-on-keys.png" alt="identity-mapped-type-on-keys"></a>
<blockquote>
<p>One of the problems when attempting the addition of this feature is that inference/contributions is a a <code>TypeId</code> to <code>TypeId</code> paring. When accessing a property key we can have be passed <code>PropertyKey::String</code> which is not a type. We are a bit stuck as we cannot create a new type during subtyping as that would conflicts with the borrow checker (we would require a mutable reference to <code>TypeStore</code> and during subtyping we only have a immutable reference to the bank of types). So like so many problems faced with types, it turned out the checker needed a new pseudo type.</p>
</blockquote>
<blockquote>
<p>To work around allowing <code>TypeId &lt;- String</code> contributions I introduced the new <strong><code>CovariantContribution</code> enum to the contribution system</strong>. This structure has more variants and so is effectively <code>TypeId | String | ...</code> and like other things delegates later steps to creating a type.</p>
</blockquote>
<h4 id="mapped-types%3A-the-identity-map-case" tabindex="-1">Mapped types: the identity map case</h4>
<p>The above shows a basic example of the mapping parameter keys. We will now step up in complexity to cover some more useful mapped types. The first is the identity map on objects. It takes a object and producing another object with the same keys mapping to the same values.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">IdentityOnObject</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">IdentityOnObject</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	[</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>While this has no effect, we can see how we can now modify this above example to give it more use by applying type operations to the property key or value type.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Pick</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ToPick</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extends</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">ToPick</span><span style="color: #C9D1D9">)]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Omit</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">ToOmit</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extends</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Not</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">ToOmit</span><span style="color: #C9D1D9">&gt;)]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">MakeArray</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">]&gt;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Pick</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">, </span><span style="color: #953800">ToPick</span><span style="color: #24292F"> </span><span style="color: #CF222E">extends</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	[</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> (</span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #24292F"> </span><span style="color: #953800">ToPick</span><span style="color: #24292F">)]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Omit</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">, </span><span style="color: #953800">ToOmit</span><span style="color: #24292F"> </span><span style="color: #CF222E">extends</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	[</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> (</span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">&amp;</span><span style="color: #24292F"> </span><span style="color: #953800">Not</span><span style="color: #24292F">&lt;</span><span style="color: #953800">ToOmit</span><span style="color: #24292F">&gt;)]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">MakeArray</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	[</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">]&gt;</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>While you can use the TypeScript <code>Exclude</code> type and <a href="https://github.com/kaleidawave/ezno/blob/main/checker/specification/specification.md#infer-and-extends-distribution">it works in Ezno</a>, I think it is simpler to use the new <a href="/posts/experimental-types/#the-not-type"><code>Not</code></a>.</p>
</blockquote>
<h4 id="key-type-modifiers%3A-in-and-as-syntax" tabindex="-1">Key type modifiers: <code>in</code> and <code>as</code> syntax</h4>
<p>Mapped types can have special syntax in the property position.</p>
<p>In the first example, it is quite simple to see <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/synthesis/interfaces.rs#L321-L331"><code>K in T</code> implies <code>K extends T</code></a>.</p>
<p>The harder code syntax is <code>as</code>. At first it got me scratching my head. But I figured that rewrites the key.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PrefixKeys</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">&nbsp; &nbsp; [</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> ((</span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">&amp;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">`property_${</span><span style="color: #FFA657">P</span><span style="color: #A5D6FF">}`</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">PrefixKeys</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">&nbsp; &nbsp; [</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> ((</span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">) </span><span style="color: #CF222E">&amp;</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">) </span><span style="color: #CF222E">as</span><span style="color: #24292F"> </span><span style="color: #0A3069">`property_${</span><span style="color: #953800">P</span><span style="color: #0A3069">}`</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">];</span></span>
<span class="line"><span style="color: #24292F">};</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>For the identity on properties we have the property key as <code>infer P</code>, for the identity on objects we have a key of type <code>infer P extends keyof T</code>. For this example we put insert <code>P</code> into the RHS type and so have <code>property_${infer P extends ((keyof T) &amp; string)}</code>. In total this is a <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/synthesis/interfaces.rs#L336-L339">three line addition</a> we already have the <code>P</code> type in the namespace for the RHS type synthesis.</p>
<h2 id="more-advanced-property-values" tabindex="-1">More advanced property values</h2>
<p>So far we have only seen properties having the value being a exact type. To discuss the last parts of mapped types we need to expand on the variants of <code>PropertyValue</code>.</p>
<pre><code class="language-diff"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FFA198">- type PropertyValue = TypeId;</span></span>
<span class="line"><span style="color: #7EE787">+ enum PropertyValue {</span></span>
<span class="line"><span style="color: #7EE787">+     /// Simple</span></span>
<span class="line"><span style="color: #7EE787">+     Value(TypeId),</span></span>
<span class="line"><span style="color: #7EE787">+     /// from `get` and `set`</span></span>
<span class="line"><span style="color: #7EE787">+     GetterSetter {</span></span>
<span class="line"><span style="color: #7EE787">+         getter: Box&lt;FunctionType&gt;,</span></span>
<span class="line"><span style="color: #7EE787">+         setter: Box&lt;FunctionType&gt;,</span></span>
<span class="line"><span style="color: #7EE787">+     }</span></span>
<span class="line"><span style="color: #7EE787">+ </span></span>
<span class="line"><span style="color: #7EE787">+     ///</span></span>
<span class="line"><span style="color: #7EE787">+     ConditionallyExists {</span></span>
<span class="line"><span style="color: #7EE787">+         condition: TypeId,</span></span>
<span class="line"><span style="color: #7EE787">+         value: Box&lt;Self&gt;</span></span>
<span class="line"><span style="color: #7EE787">+     }</span></span>
<span class="line"><span style="color: #7EE787">+ </span></span>
<span class="line"><span style="color: #7EE787">+     ///</span></span>
<span class="line"><span style="color: #7EE787">+     Configured {</span></span>
<span class="line"><span style="color: #7EE787">+         writable: TypeId,</span></span>
<span class="line"><span style="color: #7EE787">+         // ...</span></span>
<span class="line"><span style="color: #7EE787">+         value: Box&lt;Self&gt;</span></span>
<span class="line"><span style="color: #7EE787">+     }</span></span>
<span class="line"><span style="color: #7EE787">+ }</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #82071E">- type PropertyValue = TypeId;</span></span>
<span class="line"><span style="color: #116329">+ enum PropertyValue {</span></span>
<span class="line"><span style="color: #116329">+     /// Simple</span></span>
<span class="line"><span style="color: #116329">+     Value(TypeId),</span></span>
<span class="line"><span style="color: #116329">+     /// from `get` and `set`</span></span>
<span class="line"><span style="color: #116329">+     GetterSetter {</span></span>
<span class="line"><span style="color: #116329">+         getter: Box&lt;FunctionType&gt;,</span></span>
<span class="line"><span style="color: #116329">+         setter: Box&lt;FunctionType&gt;,</span></span>
<span class="line"><span style="color: #116329">+     }</span></span>
<span class="line"><span style="color: #116329">+ </span></span>
<span class="line"><span style="color: #116329">+     ///</span></span>
<span class="line"><span style="color: #116329">+     ConditionallyExists {</span></span>
<span class="line"><span style="color: #116329">+         condition: TypeId,</span></span>
<span class="line"><span style="color: #116329">+         value: Box&lt;Self&gt;</span></span>
<span class="line"><span style="color: #116329">+     }</span></span>
<span class="line"><span style="color: #116329">+ </span></span>
<span class="line"><span style="color: #116329">+     ///</span></span>
<span class="line"><span style="color: #116329">+     Configured {</span></span>
<span class="line"><span style="color: #116329">+         writable: TypeId,</span></span>
<span class="line"><span style="color: #116329">+         // ...</span></span>
<span class="line"><span style="color: #116329">+         value: Box&lt;Self&gt;</span></span>
<span class="line"><span style="color: #116329">+     }</span></span>
<span class="line"><span style="color: #116329">+ }</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>The simple case becomes the main variant. We also introduce <code>get</code> and <code>set</code> functions in here, we handle them specially but that is for another blog post.</p>
<p>The two newer additions are <code>PropertyValue::ConditionallyExists</code> and <code>PropertyValue::Configured</code>.</p>
<h3 id="propertyvalue%3A%3Aconditionallyexists" tabindex="-1"><code>PropertyValue::ConditionallyExists</code></h3>
<p>A property can conditionally exist via adding the <code>?</code> prefix modifier to property declaration.</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">MappedTypes</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">fun</span><span style="color: #FF7B72">?:</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"YES!"</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">MappedTypes</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">fun</span><span style="color: #CF222E">?:</span><span style="color: #24292F"> </span><span style="color: #0A3069">"YES!"</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p>This declaration is different to <code>fun: "YES!" | undefined</code> as in this case <code>fun in obj</code> is always <code>true</code>, whereas in the above example it is conditional. Here we say that condition for it existing is <em>unknown</em> and use the <code>boolean</code> type in its place.</p>
</blockquote>
<p>This variant can represent actual JavaScript code</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">obj</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {};</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (condition) {</span></span>
<span class="line"><span style="color: #C9D1D9">	obj.prop </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"><span style="color: #8B949E">// obj.prop conditionally exists (value = 2) based on `condition`</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">obj</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {};</span></span>
<span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (condition) {</span></span>
<span class="line"><span style="color: #24292F">	obj.prop </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">2</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"><span style="color: #6E7781">// obj.prop conditionally exists (value = 2) based on `condition`</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here we see that <code>"prop" in obj</code> is only <code>true</code> when <code>condition</code> is truthy. When we access this property we allow retrieve it but we do union the result with <code>undefined</code> for the user to account for later.</p>
<h3 id="propertyvalue%3A%3Aconfigured" tabindex="-1"><code>PropertyValue::Configured</code></h3>
<p>The second new <code>PropertyValue</code> variant is a configured wrapper. In JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor">every property has a descriptor</a>. The usage of the these descriptors is quite low. However they crop up in standard library items (<a href="https://developer.chrome.com/blog/smooshgate/">normally causing problems</a>).</p>
<p>We can (ab)use the <code>writable</code> value of a property to mark a property as readonly. We say that when <code>writable</code> is <code>false</code> we cannot assign to it. For example if the <code>x</code> property is not writable, then <code>.x = 2</code> will fail.</p>
<p>So given a property declaration prefixed with <code>readonly</code></p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">interface</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Item</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">readonly</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">id</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FFA657">count</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">interface</span><span style="color: #24292F"> </span><span style="color: #953800">Item</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">readonly</span><span style="color: #24292F"> </span><span style="color: #953800">id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #953800">count</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>we define the properties as something like</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">	(</span><span style="color: #A5D6FF">"id"</span><span style="color: #C9D1D9">, PropertyValue::Configured { </span></span>
<span class="line"><span style="color: #C9D1D9">		value: PropertyValue::</span><span style="color: #D2A8FF">Type</span><span style="color: #C9D1D9">(TypeId::</span><span style="color: #79C0FF">STRING_TYPE</span><span style="color: #C9D1D9">),</span></span>
<span class="line"><span style="color: #C9D1D9">		writable: TypeId::</span><span style="color: #79C0FF">FALSE</span></span>
<span class="line"><span style="color: #C9D1D9">	})</span></span>
<span class="line"><span style="color: #C9D1D9">	(</span><span style="color: #A5D6FF">"count"</span><span style="color: #C9D1D9">, PropertyValue::</span><span style="color: #D2A8FF">Type</span><span style="color: #C9D1D9">(TypeId::</span><span style="color: #79C0FF">NUMBER_TYPE</span><span style="color: #C9D1D9">))</span></span>
<span class="line"><span style="color: #C9D1D9">]</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">[</span></span>
<span class="line"><span style="color: #24292F">	(</span><span style="color: #0A3069">"id"</span><span style="color: #24292F">, PropertyValue::Configured { </span></span>
<span class="line"><span style="color: #24292F">		value: PropertyValue::</span><span style="color: #8250DF">Type</span><span style="color: #24292F">(TypeId::</span><span style="color: #0550AE">STRING_TYPE</span><span style="color: #24292F">),</span></span>
<span class="line"><span style="color: #24292F">		writable: TypeId::</span><span style="color: #0550AE">FALSE</span></span>
<span class="line"><span style="color: #24292F">	})</span></span>
<span class="line"><span style="color: #24292F">	(</span><span style="color: #0A3069">"count"</span><span style="color: #24292F">, PropertyValue::</span><span style="color: #8250DF">Type</span><span style="color: #24292F">(TypeId::</span><span style="color: #0550AE">NUMBER_TYPE</span><span style="color: #24292F">))</span></span>
<span class="line"><span style="color: #24292F">]</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>and do not allow writing to it</p>
<a href="https://kaleidawave.github.io/ezno/playground/?id=2rvy0y" class="media-container"><img src="../../media/ezno-screenshots/cannot-write-to-readonly-from-annotation.png" alt="cannot-write-to-readonly-from-annotation"></a>
<blockquote>
<p>There is a bit of nuance here around TypeScript <code>readonly</code> and JavaScript <code>writeable</code>. TypeScript's <code>readonly</code> is a developer abstraction, which has no effect on compile time. <code>writeable</code> on the other hand is part of JavaScript execution and has runtime behaviour when looked up <code>Object.getPropertyDescriptor</code>.</p>
</blockquote>
<blockquote>
<p>Most people prefer the upfront warnings of readonly, rather than marking it as immutable. JavaScript <code>writable</code> is hard to do compile introspection (but not impossible as showcased later), so TypeScript added their own syntax and system to add this case.</p>
</blockquote>
<blockquote>
<p>There are others here, but we skip over them for now</p>
</blockquote>
<h3 id="mapping-modifiers%3A-default-behaviour" tabindex="-1">Mapping Modifiers: Default behaviour</h3>
<p>When we have a mapped key that uses extends, <strong>we have to carry over these conditional and writeable modifiers</strong>. For example given</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">AllValuesString</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">AllValuesString</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	[</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Then if we have <code>AllValuesString&lt;{ a?: number, readonly b: boolean }&gt;</code> then the resulting type <strong>is actually <code>{ a?: string, readonly b: string }</code></strong>!</p>
<p>This seems incredible complicated to implement at first, but it is possible.</p>
<p>In the implementation in Ezno, at the mapped type definition: if the key extends a <code>keyof ...</code> modifier, the resultant property is modified to be based on two special parameters <code>TypeId::WRITABLE_KEY_ARGUMENT</code> and <code>TypeId::NON_OPTIONAL_KEY_ARGUMENT</code>.</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">mut</span><span style="color: #C9D1D9"> rhs </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PropertyValue</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Value</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">references_key_of</span><span style="color: #C9D1D9">(mapped_type</span><span style="color: #FF7B72">.</span><span style="color: #C9D1D9">extends) {</span></span>
<span class="line"><span style="color: #C9D1D9">	rhs </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">PropertyValue</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">ConditionallyExists</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">		condition</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TypeId</span><span style="color: #FF7B72">::</span><span style="color: #79C0FF">NON_OPTIONAL_KEY_ARGUMENT</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">		value</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Box</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">new</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">PropertyValue</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Configured</span><span style="color: #C9D1D9"> { </span></span>
<span class="line"><span style="color: #C9D1D9">			on</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> rhs, </span></span>
<span class="line"><span style="color: #C9D1D9">			writeable</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">TypeId</span><span style="color: #FF7B72">::</span><span style="color: #79C0FF">WRITABLE_KEY_ARGUMENT</span><span style="color: #C9D1D9"> </span></span>
<span class="line"><span style="color: #C9D1D9">		})</span></span>
<span class="line"><span style="color: #C9D1D9">	};</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">let</span><span style="color: #24292F"> </span><span style="color: #CF222E">mut</span><span style="color: #24292F"> rhs </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">PropertyValue</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Value</span><span style="color: #24292F">(</span><span style="color: #CF222E">...</span><span style="color: #24292F">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #8250DF">references_key_of</span><span style="color: #24292F">(mapped_type</span><span style="color: #CF222E">.</span><span style="color: #24292F">extends) {</span></span>
<span class="line"><span style="color: #24292F">	rhs </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #953800">PropertyValue</span><span style="color: #CF222E">::</span><span style="color: #953800">ConditionallyExists</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">		condition</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">TypeId</span><span style="color: #CF222E">::</span><span style="color: #0550AE">NON_OPTIONAL_KEY_ARGUMENT</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">		value</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Box</span><span style="color: #CF222E">::</span><span style="color: #8250DF">new</span><span style="color: #24292F">(</span><span style="color: #953800">PropertyValue</span><span style="color: #CF222E">::</span><span style="color: #953800">Configured</span><span style="color: #24292F"> { </span></span>
<span class="line"><span style="color: #24292F">			on</span><span style="color: #CF222E">:</span><span style="color: #24292F"> rhs, </span></span>
<span class="line"><span style="color: #24292F">			writeable</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">TypeId</span><span style="color: #CF222E">::</span><span style="color: #0550AE">WRITABLE_KEY_ARGUMENT</span><span style="color: #24292F"> </span></span>
<span class="line"><span style="color: #24292F">		})</span></span>
<span class="line"><span style="color: #24292F">	};</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here the property is made conditional and configured based on two special types. We can treat them as parameters. We need to infer whether they are true or false based om <code>keyof</code> returns.</p>
<p>So the next part is to connect this up from the other side. When doing subtyping for key matching, if we test against a <code>keyof</code> type, <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/types/subtyping.rs#L2851-L2891">two arguments are set into the inferred table against for these internal parameters <code>TypeId::WRITABLE_KEY_ARGUMENT</code> and <code>TypeId::NON_OPTIONAL_KEY_ARGUMENT</code></a>.</p>
<p>When we get a property out the <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/types/properties/access.rs#L966-L977">other side we match these up and specialise them</a>.</p>
<h3 id="mapped-type-modifiers%3A-property-descriptor-and-conditionally-exists" tabindex="-1">Mapped type modifiers: Property descriptor and conditionally exists</h3>
<p>So we have the default case out of the way. We can change the mapping-ness and enforce cases using special syntax.</p>
<p>For optionality with <code>?:</code>, we set <code>condition: TypeId::TRUE</code> in the conditional wrapper (rather than the special mapping parameter type)</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Partial</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">?:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Partial</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	[</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">]</span><span style="color: #CF222E">?:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">];</span></span>
<span class="line"><span style="color: #24292F">};</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here because of the <code>-?:</code> we <strong>do not add</strong> the conditional wrapper</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Required</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">-?:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Required</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	[</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">]</span><span style="color: #CF222E">-?:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">];</span></span>
<span class="line"><span style="color: #24292F">};</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here with the <code>readonly</code> prefix we set <code>readonly: TypeId::TRUE</code> in the configurable wrapper (rather than the special mapping parameter type)</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Immutable</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">readonly</span><span style="color: #C9D1D9"> [</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Immutable</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">readonly</span><span style="color: #24292F"> [</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">];</span></span>
<span class="line"><span style="color: #24292F">};</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here because of <code>-readonly</code> we <strong>do not add</strong> the configurable readonly wrapper!</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Mutable</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #FF7B72">-readonly</span><span style="color: #C9D1D9"> [</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">];</span></span>
<span class="line"><span style="color: #C9D1D9">};</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Mutable</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #CF222E">-readonly</span><span style="color: #24292F"> [</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">T</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">];</span></span>
<span class="line"><span style="color: #24292F">};</span></span>
<span class="line"></span></code></pre></div></code></pre>
<blockquote>
<p><a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/synthesis/interfaces.rs#L364-L395">Full logic here</a></p>
</blockquote>
<p>And that concludes the mapped type section. Let me know in the comments if there is any mapped type feature I have missed.</p>
<p>The next parts go into some really interesting and important things about properties and more types!</p>
<h2 id="string-intrinsics%3A-uppercase%2C-lowercase%2C-etc" tabindex="-1">String intrinsics: <code>Uppercase</code>, <code>Lowercase</code>, etc</h2>
<p>When working on mapped types, I noticed some examples used <a href="https://www.typescriptlang.org/docs/handbook/utility-types.html#intrinsic-string-manipulation-types">special string transforms</a> in their <code>as</code> clause. We can pass constant strings to these transformer types.</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">x</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Uppercase</span><span style="color: #C9D1D9">&lt;</span><span style="color: #A5D6FF">"hi"</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"HI"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">y</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Lowercase</span><span style="color: #C9D1D9">&lt;</span><span style="color: #A5D6FF">"Hello"</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"hello"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #8B949E">// Type error: "example" is not assignable to "EXAMPLE"</span></span>
<span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">z</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Uppercase</span><span style="color: #C9D1D9">&lt;</span><span style="color: #A5D6FF">"Example"</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"example"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">x</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Uppercase</span><span style="color: #24292F">&lt;</span><span style="color: #0A3069">"hi"</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">"HI"</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">y</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Lowercase</span><span style="color: #24292F">&lt;</span><span style="color: #0A3069">"Hello"</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">"hello"</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #6E7781">// Type error: "example" is not assignable to "EXAMPLE"</span></span>
<span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">z</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Uppercase</span><span style="color: #24292F">&lt;</span><span style="color: #0A3069">"Example"</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">"example"</span><span style="color: #24292F">;</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>There are a few things that were implemented during this step</p>
<ol>
<li>Eagerly apply the transformation, including through union types (<code>Uppercase&lt;"a" | "b"&gt; = "A" | "B"</code>).</li>
<li>Apply when used on a generic for a return type</li>
<li>Subtyping.</li>
</ol>
<p>Similar to other intrinsics, when we encounter this we have custom logic for these situations.</p>
<blockquote>
<p>If anyone has a neat way to do case insensitive string equality that is better than <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/types/subtyping.rs#L2614C5-L2614C55"><code>lhs.to_lowercase() == rhs.to_lowercase()</code></a> then <a href="https://github.com/kaleidawave/ezno/compare">please send a PR </a>.</p>
</blockquote>
<h3 id="introducing-my-own-intrinsic%3A-caseinsensitive" tabindex="-1">Introducing my own intrinsic: <code>CaseInsensitive</code></h3>
<p>One example that got me confused.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Item</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">id</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">,</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FFA657">iD</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #FF7B72">type</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">MappedItem</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    [</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">keyof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Item</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">as</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Uppercase</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">&gt;]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Item</span><span style="color: #C9D1D9">[</span><span style="color: #FFA657">P</span><span style="color: #C9D1D9">]</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">Item</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">id</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">,</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #953800">iD</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #CF222E">type</span><span style="color: #24292F"> </span><span style="color: #953800">MappedItem</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    [</span><span style="color: #953800">P</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> </span><span style="color: #CF222E">keyof</span><span style="color: #24292F"> </span><span style="color: #953800">Item</span><span style="color: #24292F"> </span><span style="color: #CF222E">as</span><span style="color: #24292F"> </span><span style="color: #953800">Uppercase</span><span style="color: #24292F">&lt;</span><span style="color: #953800">P</span><span style="color: #24292F">&gt;]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Item</span><span style="color: #24292F">[</span><span style="color: #953800">P</span><span style="color: #24292F">]</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>Here we have a property of type <code>Uppercase&lt;infer P extends keyof Event&gt;</code>. We can pull out the problem here and I will give you an equivalent problem: what the return type is here?.</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">declare</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">func</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">extends</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">&gt;(</span><span style="color: #FFA657">param</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Uppercase</span><span style="color: #C9D1D9">&lt;</span><span style="color: #FFA657">T</span><span style="color: #C9D1D9">&gt;) -&gt; </span><span style="color: #D2A8FF">T</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">declare</span><span style="color: #24292F"> </span><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">func</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F"> </span><span style="color: #CF222E">extends</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">&gt;(</span><span style="color: #953800">param</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Uppercase</span><span style="color: #24292F">&lt;</span><span style="color: #953800">T</span><span style="color: #24292F">&gt;) -&gt; </span><span style="color: #8250DF">T</span><span style="color: #24292F">;</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>We see that we have to infer through this <code>Uppercase</code> boundary. For it to be valid you expect <code>func("hi")</code> to return all four valid values for <code>T</code>: <code>"hi", "Hi", "hI", "HI"</code>. To support this I added <code>CaseInsensitive</code>. The result is that if a inferred pair is found inside one of these case transformations then we wrap the output in <code>CaseInsensitive</code> to pick up all valid cases.</p>
<p>After adding similar subtyping logic, this fixes the problem.</p>
<blockquote>
<p>I think I had to do it this way because I am doing it via inference via <code>key_matches</code> whereas TypeScript eagerly evaluates mapped types and so eagerly generates these variants.</p>
</blockquote>
<blockquote>
<p>If you like intrinsics, check out the <a href="/posts/experimental-types">last blog post</a>.</p>
</blockquote>
<p>Switching it up, here are some other things I have been working on properties.</p>
<h2 id="functions-and-object.keys" tabindex="-1">Functions and <code>Object.keys</code></h2>
<p>We will now take a peek at the crazier side of the checker. One of the biggest experimental features is the <em>observance of side-effects</em>.</p>
<p>In some <em>linear</em> code we can apply <em>mutations</em> to <em>types</em> as the program progresses.</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">obj</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {}</span></span>
<span class="line"><span style="color: #C9D1D9">obj.property </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">obj satisfies string; </span><span style="color: #8B949E">// fails as 2 is not a string</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">obj</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {}</span></span>
<span class="line"><span style="color: #24292F">obj.property </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">2</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">obj satisfies string; </span><span style="color: #6E7781">// fails as 2 is not a string</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>This simple case is quite simple to implement. But problems occur when using functions. A huge experiment in Ezno is for functions to record <em>special properties</em> not representable by just types. <a href="https://kaleidawave.github.io/ezno/playground/?id=2iitje">We can see this in the following example</a>.</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">setAt</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">obj</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">at</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">number</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">value</span><span style="color: #C9D1D9">) {</span></span>
<span class="line"><span style="color: #C9D1D9">	obj[at] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> value</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D2A8FF">debug_effects_rust</span><span style="color: #C9D1D9">(setAt)</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">function</span><span style="color: #24292F"> </span><span style="color: #8250DF">setAt</span><span style="color: #24292F">(</span><span style="color: #953800">obj</span><span style="color: #24292F">, </span><span style="color: #953800">at</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">number</span><span style="color: #24292F">, </span><span style="color: #953800">value</span><span style="color: #24292F">) {</span></span>
<span class="line"><span style="color: #24292F">	obj[at] </span><span style="color: #CF222E">=</span><span style="color: #24292F"> value</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8250DF">debug_effects_rust</span><span style="color: #24292F">(setAt)</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>We will skip over a lot here but jumping straight into the deep end and the front of this experiment <a href="https://github.com/kaleidawave/ezno/blob/main/checker/specification/specification.md#array-push">the specification has an example which shows the application of some of the <code>Array.prototype.push</code> mutation information</a>. This gives us more precise information on values after mutations.</p>
<p>WW also account for mutations in <code>for ... in ...</code> loop. Again glossing over a lot here, but the assignments in the loop get collected and when we call some functions which use this, we inspect the object that is <code>in</code>'d and we run each assignment for each (enumerable) property key in the object.</p>
<p>In fact this is also how <code>Object.entries</code>, <code>Object.values</code> and <code>Object.assign</code> work. We define them as</p>
<pre><code class="language-typescript"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">declare</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">class</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Object</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">static</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">keys</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">on</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> { [</span><span style="color: #FFA657">s</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9"> })</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">&gt; {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">keys</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">key</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> on) {</span></span>
<span class="line"><span style="color: #C9D1D9">            keys.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(key);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> keys</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">static</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">values</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">on</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> { [</span><span style="color: #FFA657">s</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9"> })</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9">&gt; {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">values</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;</span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9">&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">key</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> on) {</span></span>
<span class="line"><span style="color: #C9D1D9">            values.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(on[key]);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> values</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">static</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">entries</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">on</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> { [</span><span style="color: #FFA657">s</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">]</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9"> })</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;[</span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9">]&gt; {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">entries</span><span style="color: #FF7B72">:</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">Array</span><span style="color: #C9D1D9">&lt;[</span><span style="color: #79C0FF">string</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">any</span><span style="color: #C9D1D9">]&gt; </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [];</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">key</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> on) {</span></span>
<span class="line"><span style="color: #C9D1D9">            entries.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">([key, on[key]]);</span></span>
<span class="line"><span style="color: #C9D1D9">        }</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> entries</span></span>
<span class="line"><span style="color: #C9D1D9">    }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">declare</span><span style="color: #24292F"> </span><span style="color: #CF222E">class</span><span style="color: #24292F"> </span><span style="color: #953800">Object</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">static</span><span style="color: #24292F"> </span><span style="color: #8250DF">keys</span><span style="color: #24292F">(</span><span style="color: #953800">on</span><span style="color: #CF222E">:</span><span style="color: #24292F"> { [</span><span style="color: #953800">s</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">any</span><span style="color: #24292F"> })</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">string</span><span style="color: #24292F">&gt; {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">keys</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">string</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> [];</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">for</span><span style="color: #24292F"> (</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">key</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> on) {</span></span>
<span class="line"><span style="color: #24292F">            keys.</span><span style="color: #8250DF">push</span><span style="color: #24292F">(key);</span></span>
<span class="line"><span style="color: #24292F">        }</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">return</span><span style="color: #24292F"> keys</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">static</span><span style="color: #24292F"> </span><span style="color: #8250DF">values</span><span style="color: #24292F">(</span><span style="color: #953800">on</span><span style="color: #CF222E">:</span><span style="color: #24292F"> { [</span><span style="color: #953800">s</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">any</span><span style="color: #24292F"> })</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">any</span><span style="color: #24292F">&gt; {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">values</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;</span><span style="color: #0550AE">any</span><span style="color: #24292F">&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> [];</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">for</span><span style="color: #24292F"> (</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">key</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> on) {</span></span>
<span class="line"><span style="color: #24292F">            values.</span><span style="color: #8250DF">push</span><span style="color: #24292F">(on[key]);</span></span>
<span class="line"><span style="color: #24292F">        }</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">return</span><span style="color: #24292F"> values</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292F">    </span><span style="color: #CF222E">static</span><span style="color: #24292F"> </span><span style="color: #8250DF">entries</span><span style="color: #24292F">(</span><span style="color: #953800">on</span><span style="color: #CF222E">:</span><span style="color: #24292F"> { [</span><span style="color: #953800">s</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">string</span><span style="color: #24292F">]</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #0550AE">any</span><span style="color: #24292F"> })</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;[</span><span style="color: #0550AE">string</span><span style="color: #24292F">, </span><span style="color: #0550AE">any</span><span style="color: #24292F">]&gt; {</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">entries</span><span style="color: #CF222E">:</span><span style="color: #24292F"> </span><span style="color: #953800">Array</span><span style="color: #24292F">&lt;[</span><span style="color: #0550AE">string</span><span style="color: #24292F">, </span><span style="color: #0550AE">any</span><span style="color: #24292F">]&gt; </span><span style="color: #CF222E">=</span><span style="color: #24292F"> [];</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">for</span><span style="color: #24292F"> (</span><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">key</span><span style="color: #24292F"> </span><span style="color: #CF222E">in</span><span style="color: #24292F"> on) {</span></span>
<span class="line"><span style="color: #24292F">            entries.</span><span style="color: #8250DF">push</span><span style="color: #24292F">([key, on[key]]);</span></span>
<span class="line"><span style="color: #24292F">        }</span></span>
<span class="line"><span style="color: #24292F">        </span><span style="color: #CF222E">return</span><span style="color: #24292F"> entries</span></span>
<span class="line"><span style="color: #24292F">    }</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>and we get the following results (at least on ezno <code>0.0.22</code>, it is broken in the latest Ezno and we seem to miss out on the first iteration. Hopefully I can find some time to track down what is broken here soon)</p>
<img src="../../media/ezno-screenshots/object-method-results.png" alt="object-method-results">
<blockquote>
<p>This may seems like a lot of work but this mechanism has a lot of other benefits and I think it is the coolest part of Ezno. I will eventually share the whole system and some really interesting things I have discovered.</p>
</blockquote>
<h3 id="complications-with-object.defineproperty" tabindex="-1">Complications with  <code>Object.defineProperty</code></h3>
<p>These inferred side-effect things are cool. However for some things we can't use mutations based on JavaScript code, these being</p>
<ol>
<li>Internal APIs (aren't possible just using JS syntax)</li>
<li>APIs that would be quite complex to write in terms of events (also don't make sense for all inputs). For example <code>Math.sin</code>.</li>
</ol>
<blockquote>
<p>This is similar with JavaScript runtimes. For certain things they use special native code for these functions rather than just JavaScript.</p>
</blockquote>
<p>The function <code>Object.defineProperty</code> has this property. It isn't possible to write an alternative for this function just using <code>[key]</code> and <code>=</code>.</p>
<p>So rather than giving this function a body and using the events it has a different behaviour for a constant function. When <code>Object.defineProperty</code> is called, <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/features/constant_functions.rs#L406-L528">it instead runs this internal logic in <code>constant_functions.rs</code></a>. It isn't perfect, but it does accept sensible usage of this API.</p>
<p>Previously we saw that we needed a <code>readonly</code> annotation this value. But we can do exactly the same in JavaScript</p>
<a href="https://kaleidawave.github.io/ezno/playground/?id=32i0ay" class="media-container"><img src="../../media/ezno-screenshots/object-define-property.png" alt="object-define-property"></a>
<h3 id="locking-objects-with-freeze%2C-seal-and-preventextensions" tabindex="-1">Locking objects with <code>freeze</code>, <code>seal</code> and <code>preventExtensions</code></h3>
<p>The initial mapped type PR included basic support for <code>freeze</code>. But thanks to an <a href="https://github.com/kaleidawave/ezno/pull/213">external PR</a> the logic is now extended to cover <code>preventExtensions</code> and<code>seal</code></p>
<a href="https://kaleidawave.github.io/ezno/playground/?id=27wr9e" class="media-container"><img src="../../media/ezno-screenshots/object-seal.png" alt="object-seal"></a>
<h2 id="the-current-representation-for-properties%3A-adding-publicity" tabindex="-1">The current representation for properties: adding <code>Publicity</code></h2>
<p>Over the course of this blog post we have built up the representation of properties. The final piece is that this key-value pair is a actually a triple including <code>Publicity</code> (<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes/Private_properties">public or private</a>), <code>PropertyKey</code> and <code>PropertyValue</code>. (<a href="https://github.com/kaleidawave/ezno/issues/219">However full private and public property checking is unfinished</a>).</p>
<p>They are stored in a array (<code>Vec</code>), for example the type annotation <code>{ a: 0, b: 2 }</code> is represented something similar to</p>
<pre><code class="language-rust"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #C9D1D9">[</span></span>
<span class="line"><span style="color: #C9D1D9">	(</span><span style="color: #FFA657">Publicity</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Public</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">String</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"a"</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">PropertyValue</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Value</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">TypeId</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)),</span></span>
<span class="line"><span style="color: #C9D1D9">	(</span><span style="color: #FFA657">Publicity</span><span style="color: #FF7B72">::</span><span style="color: #FFA657">Public</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">PropertyKey</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">String</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"b"</span><span style="color: #C9D1D9">), </span><span style="color: #FFA657">PropertyValue</span><span style="color: #FF7B72">::</span><span style="color: #D2A8FF">Value</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">TypeId</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">))</span></span>
<span class="line"><span style="color: #C9D1D9">]</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #24292F">[</span></span>
<span class="line"><span style="color: #24292F">	(</span><span style="color: #953800">Publicity</span><span style="color: #CF222E">::</span><span style="color: #953800">Public</span><span style="color: #24292F">, </span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">String</span><span style="color: #24292F">(</span><span style="color: #0A3069">"a"</span><span style="color: #24292F">), </span><span style="color: #953800">PropertyValue</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Value</span><span style="color: #24292F">(</span><span style="color: #953800">TypeId</span><span style="color: #24292F"> </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">0</span><span style="color: #24292F">)),</span></span>
<span class="line"><span style="color: #24292F">	(</span><span style="color: #953800">Publicity</span><span style="color: #CF222E">::</span><span style="color: #953800">Public</span><span style="color: #24292F">, </span><span style="color: #953800">PropertyKey</span><span style="color: #CF222E">::</span><span style="color: #8250DF">String</span><span style="color: #24292F">(</span><span style="color: #0A3069">"b"</span><span style="color: #24292F">), </span><span style="color: #953800">PropertyValue</span><span style="color: #CF222E">::</span><span style="color: #8250DF">Value</span><span style="color: #24292F">(</span><span style="color: #953800">TypeId</span><span style="color: #24292F"> </span><span style="color: #CF222E">-&gt;</span><span style="color: #24292F"> </span><span style="color: #0550AE">2</span><span style="color: #24292F">))</span></span>
<span class="line"><span style="color: #24292F">]</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p>As discussed the type checker in Ezno is mutation (technically fully side-effect) aware and dependent so traditional representing this as <code>obj = type with properties</code> doesn't quite work. Instead we say <code>obj = *object 100*</code> and then record properties onto each object for each context.</p>
<p>This is because objects can have difference properties in different contexts. <em>There isn't a globally true list of properties for a object</em>.</p>
<pre><code class="language-ts"><div class="shiki-container"><pre class="shiki shiki-dark" style="background-color: #0d1117"><code><span class="line"><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">obj</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> { property: </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9"> };</span></span>
<span class="line"><span style="color: #8B949E">// ctx.properties = { 'obj': [["property", { value: 1 }]] }</span></span>
<span class="line"><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (condition) {</span></span>
<span class="line"><span style="color: #C9D1D9">	obj.property </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// ctx.properties = { 'obj': [["property", { value: 1 }], ["property", { value: 2 }]] }</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// obj.property = 2 throughout here</span></span>
<span class="line"><span style="color: #C9D1D9">} </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class="line"><span style="color: #C9D1D9">	console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"something"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// obj.property = 1 still here</span></span>
<span class="line"><span style="color: #C9D1D9">	</span><span style="color: #8B949E">// ctx.properties = { 'obj': [["property", { value: 1 }]] }</span></span>
<span class="line"><span style="color: #C9D1D9">}</span></span>
<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color: #ffffff"><code><span class="line"><span style="color: #CF222E">const</span><span style="color: #24292F"> </span><span style="color: #0550AE">obj</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> { property: </span><span style="color: #0550AE">1</span><span style="color: #24292F"> };</span></span>
<span class="line"><span style="color: #6E7781">// ctx.properties = { 'obj': [["property", { value: 1 }]] }</span></span>
<span class="line"><span style="color: #CF222E">if</span><span style="color: #24292F"> (condition) {</span></span>
<span class="line"><span style="color: #24292F">	obj.property </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0550AE">2</span><span style="color: #24292F">;</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// ctx.properties = { 'obj': [["property", { value: 1 }], ["property", { value: 2 }]] }</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// obj.property = 2 throughout here</span></span>
<span class="line"><span style="color: #24292F">} </span><span style="color: #CF222E">else</span><span style="color: #24292F"> {</span></span>
<span class="line"><span style="color: #24292F">	console.</span><span style="color: #8250DF">log</span><span style="color: #24292F">(</span><span style="color: #0A3069">"something"</span><span style="color: #24292F">)</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// obj.property = 1 still here</span></span>
<span class="line"><span style="color: #24292F">	</span><span style="color: #6E7781">// ctx.properties = { 'obj': [["property", { value: 1 }]] }</span></span>
<span class="line"><span style="color: #24292F">}</span></span>
<span class="line"></span></code></pre></div></code></pre>
<p><strong>The current system also enables interface merging. However not all types store their properties on the context. Thanks to a recent change, anonymous object type annotations store their properties actually on the type.</strong></p>
<blockquote>
<p>The eagle eyed among you will notice that in the first branch, <code>obj</code> has two properties named <code>property</code>. I am still unsure whether appending rather than replacing is the best approach. It does mean that assigning a property doesn't have to check the rest and not-implemented at the moment but it means that LSP hover could instead only print up-to some assignment. This system is fine though as access accounts for this finding the first match when walking right-to-left.</p>
</blockquote>
<h3 id="improvements-to-listing-types" tabindex="-1">Improvements to listing types</h3>
<p>The PR also made some improvements for being able to get all properties on an object. Now <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/types/properties/list.rs#L105">number properties are sorted and added first</a>, <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/types/properties/list.rs#L43-L45">the <code>enumerable</code> property is checked</a> and <a href="https://github.com/kaleidawave/ezno/blob/16f7779b157dea4da2b618d8e192492a09d1acb9/checker/src/types/properties/access.rs#L67-L84">properties with both <code>get</code>ter and <code>set</code>ter fixed</a>.</p>
<p>Additionally <a href="https://github.com/kaleidawave/ezno/pull/180">thanks to an external PR</a> added a while back, when a property is not find it gives alternatives using the Levenshtein algorithm on these keys.</p>
<img src="../../media/ezno-screenshots/property-alternatives.png" alt="property-alternatives">
<h3 id="future-changes-to-properties-for-consideration" tabindex="-1">Future changes to properties for consideration</h3>
<blockquote>
<p>None of this adds anything. But there is still things that could be changed with regards to this representation of properties.</p>
</blockquote>
<ul>
<li>Separate out <code>PropertyValue::Configured</code>
<ul>
<li>Maybe this could be held separately on the context</li>
</ul>
</li>
<li>Adding <em>metadata</em> to properties
<ul>
<li>This is needed for documentation comments in the LSP</li>
</ul>
</li>
<li>Restructuring the <code>LocalInformation.properties</code>
<ul>
<li>Maybe removing <code>PropertyValue::Optional</code> for <code>{ a: string, b?: string } == { a: string } &amp; ({ b: string } | {})</code></li>
</ul>
</li>
<li><code>Publicity</code> item absorbed in <code>PropertyKey</code> ?</li>
</ul>
<hr>
<p>Hopefully you enjoyed this blog post! If you haven't seen yet there are recent blog posts on <a href="/posts/experimental-types">experimental types</a> and a <a href="/posts/sets-types-and-type-checking">background on type theory</a>.</p>

</div>

<div class="discussions">
    <script src="https://giscus.app/client.js" data-repo="kaleidawave/discussions" data-repo-id="R_kgDOIy08KA" data-category="Comments" data-category-id="DIC_kwDOIy08KM4CTpn8" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async="">
            </script>
</div>

<script defer="">
    for (const video of document.querySelectorAll("video")) {
        video.addEventListener("mouseover", (ev) => {
            ev.target.play();
        })
    }
</script>

        </div>
        
    </main>
    <footer>
        <div class="width-box">
            <form>
                <label for="toggle-theme">Light Mode</label>
                <input type="checkbox" name="toggle-theme" id="toggle-theme">
            </form>
            <nav>
                <ul>
                    <li>
                        <a href="https://bsky.app/profile/kaleidawave.bsky.social">Bluesky <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/kaleidawave">Twitter <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"></path></svg></a>
                    </li>
                    <li>
                        <a href="https://github.com/kaleidawave">GitHub <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a>
                    </li>
                    <li>
                        Built with <a href="https://www.11ty.dev/"><svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3.398 12V0h17.204v24H3.398zm13.17 6.07a1.07 1.07 0 00.373-.107c.432-.213.68-.672.877-1.626.076-.372 1.195-6.168 1.209-6.263.026-.186-.008-.382-.084-.476a.325.325 0 00-.087-.064l-.06-.031h-.291c-.253 0-.298 0-.348.02-.113.039-.207.156-.255.316-.011.038-.168.881-.348 1.873l-.328 1.802-.046-.21c-.56-2.547-.764-3.452-.794-3.532a.383.383 0 00-.103-.16c-.105-.107-.117-.11-.567-.11-.411 0-.422 0-.5.074-.086.079-.122.216-.111.42.006.115.045.27.688 2.784.663 2.587.751 2.943.787 3.177.046.3-.05.713-.208.893-.032.037-.037.039-.084.032-.028 0-.12-.027-.204-.051-.268-.078-.362-.072-.462.028-.096.096-.137.248-.138.51 0 .256.028.34.159.473.131.133.324.208.595.23.164.012.22.012.33-.001zm-1.896-1.712a.31.31 0 00.16-.192c.02-.058.022-.098.022-.356 0-.255-.003-.299-.021-.354-.04-.121-.136-.196-.278-.217-.041-.01-.2-.01-.355-.01-.365-.001-.378-.01-.446-.184-.068-.18-.096-.326-.113-.602a85.799 85.799 0 01-.012-1.94v-1.765h.35c.454 0 .507-.01.602-.113a.465.465 0 00.102-.24 3.273 3.273 0 000-.534c-.026-.16-.099-.271-.211-.322-.057-.025-.065-.026-.45-.03h-.392l-.003-1.22c-.003-1.09-.005-1.227-.021-1.278a.378.378 0 00-.201-.247c-.052-.024-.072-.025-.32-.029-.27 0-.356 0-.429.038-.087.042-.148.133-.185.278-.014.054-.032.346-.076 1.262l-.06 1.194s-.08 0-.18.01c-.206.01-.263.022-.327.086-.092.092-.12.19-.127.455-.01.334.02.487.115.588.075.081.134.1.345.106l.173.01v1.785c0 1.7.006 2.019.034 2.274.041.37.13.709.241.928.194.38.544.617.988.668h1.005l.07-.04zm-7.447 0c.098-.053.16-.154.2-.332.016-.077.018-.401.018-4.518 0-4.184-.001-4.44-.02-4.51-.05-.194-.19-.29-.378-.26-.035.01-.344.084-.686.175-.343.09-.684.18-.758.198-.17.043-.214.062-.281.126-.105.098-.122.185-.122.606 0 .416.016.5.12.604.094.095.189.1.456.03.103-.026.193-.048.2-.048.01 0 .014.784.017 3.763.003 3.436.005 3.77.021 3.84.048.202.113.296.236.34.034.013.133.016.487.014.435 0 .445 0 .49-.027zm3.203 0c.092-.046.152-.135.197-.29l.024-.084.003-4.435c.002-3.194 0-4.456-.01-4.509-.033-.2-.145-.308-.322-.308-.066 0-.198.03-.857.204-.56.147-.799.214-.849.239a.34.34 0 00-.17.184c-.024.06-.024.071-.024.479 0 .415 0 .417.026.483a.362.362 0 00.083.12c.1.1.172.105.456.034a5.46 5.46 0 01.208-.05c.008 0 .012 1.202.014 3.791l.003 3.79.026.086a.48.48 0 00.135.23c.078.062.085.063.57.06.414 0 .447 0 .487-.024z"></path></svg> Eleventy</a> and
                        <a href="/architecture">others</a>
                    </li>
                </ul>
            </nav>
        </div>
    </footer>
    <script>
        if (localStorage.getItem("theme") === null) {
    changeScheme();
} else {
    updateThemeClass();
}

function changeScheme(darkTheme = null) {
    if (darkTheme === null) {
        if ("matchMedia" in window) {
            darkTheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
        } else {
            darkTheme = false;
        }
    }
    localStorage.setItem("theme", darkTheme ? "dark" : "light");
    updateThemeClass();
}

function updateThemeClass(value = null) {
    if (value === null) {
        value = localStorage.getItem("theme") === "dark";
    }
    if (value) {
        document.documentElement.classList.add("dark");
    } else {
        document.documentElement.classList.remove("dark");
    }
}

{
    const themeSwitch = document.querySelector("#toggle-theme");
    themeSwitch.checked = localStorage.getItem("theme") !== "dark";
    themeSwitch.addEventListener("change", (ev) => {
        const darkTheme = !ev.target.checked;
        changeScheme(darkTheme);
    });
}

// Clicking on headers stores their reference
document.addEventListener("click", (ev) => {
    if (ev.target.matches(".post > *:is(h2, h3, h4, h5)")) {
        const id = ev.target.getAttribute("id");
        if (id !== null) {
            location.href = '#' + id;
        }
    }
});

const titleBar = document.querySelector("header .icon-title")

titleBar.querySelector("img").addEventListener("dragend", () => {
    const r = document.createElement("video");
    const s = document.createElement("source");
    s.src = "/media/boom.webm";
    r.append(s);
    r.controls = false;
    titleBar.appendChild(r);
    r.addEventListener("ended", () => {
        titleBar.querySelector(".header-title").innerText = "Bengineering";
        r.style.display = "none";
    });
    r.play();

})

// TODO temp hack for highlighted rows in code blocks
for (const element of document.querySelectorAll("[data-highlight]")) {
    const indexes = element.getAttribute("data-highlight").split(",").map(a => parseInt(a));
    for (const pres of element.children[0].children) {
        // TODO adjacent indices don't style well, could do something here
        for (const index of indexes) {
            const line = pres.children[0].children[index];
            const firstChild = line.children[0];
            const newContent = firstChild.textContent.trimLeft();
            const indent = firstChild.textContent.length - newContent.length;
            firstChild.childNodes[0].data = newContent;
            line.style.marginLeft = indent + 'ch';
            line.classList.add("highlight");
        }
    }
}

    </script>


</body></html>